

<div class="container-full">
    
    <div id="vistaFacturas" class="vista-modo">
        <div class="vista-scroll">
        
        <div class="module-header" id="headerFacturas">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="module-title">
                        <i class="fas fa-truck"></i>
                        SISTEMA DE PROVEEDORES
                    </h1>
                    <p class="module-subtitle">Gestión integral de proveedores</p>
                </div>
                
                
                <div class="header-center">
                    <div class="mode-tabs">
                        <button class="mode-tab active" data-mode="facturas" onclick="cambiarModoProveedor('facturas')">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Facturas</span>
                        </button>
                        <button class="mode-tab" data-mode="productos" onclick="cambiarModoProveedor('productos')">
                            <i class="fas fa-box-open"></i>
                            <span>Ingresar Factura</span>
                        </button>
                        <button class="mode-tab" data-mode="comparador" onclick="cambiarModoProveedor('comparador')">
                            <i class="fas fa-balance-scale"></i>
                            <span>Comparador</span>
                        </button>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="stats-group" id="statsFacturas">
                        <div class="stat-item">
                            <span class="stat-label">Total Facturas</span>
                            <span class="stat-value accent" id="totalFacturas">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Pendiente</span>
                            <span class="stat-value info" id="totalPendiente">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Vencidas</span>
                            <span class="stat-value danger" id="totalVencido">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="filters-bar">
            <div class="filter-group">
                <label class="filter-label">
                    <i class="fas fa-building"></i>
                    Proveedor
                </label>
                <select id="proveedorSelector" class="form-select">
                    <option value="todos">Todos los proveedores</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i class="fas fa-filter"></i>
                    Estado
                </label>
                <select id="estadoSelector" class="form-select">
                    <option value="pendientes">Pendientes/Abonadas</option>
                    <option value="pagadas">Pagadas</option>
                    <option value="todas">Todas</option>
                </select>
            </div>
            
            <div class="filter-actions">
                <button class="btn btn-secondary" onclick="recargarFacturas()">
                    <i class="fas fa-sync-alt"></i>
                    Recargar
                </button>
                <button class="btn btn-accent" onclick="mostrarModalNotas()">
                    <i class="fas fa-sticky-note"></i>
                    Notas
                    <span id="badgeNotas" class="badge-counter hidden">0</span>
                </button>
                <button class="btn btn-primary" onclick="mostrarModalNotificar()">
                    <i class="fas fa-bell"></i>
                    Notificar Visita
                </button>
                <button class="btn btn-warning" onclick="mostrarModalFacturaEmergencia()">
                    <i class="fas fa-exclamation-circle"></i>
                    Factura Emergencia
                </button>
            </div>
        </div>

        
        <div class="content-wrapper">
            <div class="facturas-scroll-container">
                <div id="facturasGrid" class="facturas-grid">
                    
                </div>
            </div>
        </div>
        </div>
    </div>

    
    <div id="vistaProductos" class="vista-modo vista-fullpage hidden">
        <div id="ingresoFacturaContainer"></div>
    </div>

    <!-- Vista: Comparador de Precios -->
    <div id="vistaComparador" class="vista-modo vista-fullpage hidden">
        <div id="comparadorContainer"></div>
    </div>
</div>


<div id="modalFactura" class="modal">
    <div class="modal-overlay" onclick="cerrarModalFactura()"></div>
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 id="modalFacturaTitulo">Factura</h3>
            <button class="modal-close" onclick="cerrarModalFactura()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        
        <div class="tabs-container">
            <button class="tab-btn active" data-tab="detalles">
                <i class="fas fa-file-invoice"></i>
                Detalles
            </button>
            <button class="tab-btn" data-tab="historial">
                <i class="fas fa-history"></i>
                Historial
            </button>
            <button class="tab-btn" data-tab="pago">
                <i class="fas fa-dollar-sign"></i>
                Registrar Pago
            </button>
            <button class="tab-btn" data-tab="productos">
                <i class="fas fa-boxes"></i>
                Productos
            </button>
        </div>
        
        <div class="modal-body">
            
            <div id="tabDetalles" class="tab-content active">
                <div class="details-grid">
                    <div class="detail-item">
                        <label>Número de Factura</label>
                        <span id="detNumeroFactura"></span>
                    </div>
                    <div class="detail-item">
                        <label>Proveedor</label>
                        <span id="detProveedor"></span>
                    </div>
                    <div class="detail-item">
                        <label>Fecha de Emisión</label>
                        <span id="detFechaEmision"></span>
                    </div>
                    <div class="detail-item">
                        <label>Fecha de Vencimiento</label>
                        <span id="detFechaVencimiento"></span>
                    </div>
                    <div class="detail-item">
                        <label>Subtotal</label>
                        <span id="detSubtotal"></span>
                    </div>
                    <div class="detail-item">
                        <label>IVA (15%)</label>
                        <span id="detIva"></span>
                    </div>
                    <div class="detail-item">
                        <label>Descuento</label>
                        <span id="detDescuento" class="text-danger"></span>
                    </div>
                    <div class="detail-item">
                        <label>Total Factura</label>
                        <span id="detTotalFactura" class="text-accent"></span>
                    </div>
                    <div class="detail-item">
                        <label>Saldo Pendiente</label>
                        <span id="detSaldoPendiente" class="text-info"></span>
                    </div>
                    <div class="detail-item">
                        <label>Estado</label>
                        <span id="detEstado" class="badge"></span>
                    </div>
                    <div class="detail-item">
                        <label>Días de Vencimiento</label>
                        <span id="detDiasVencimiento"></span>
                    </div>
                </div>
                <div class="detail-notas">
                    <label>Notas</label>
                    <p id="detNotas" class="notas-text"></p>
                </div>
            </div>
            
            
            <div id="tabHistorial" class="tab-content">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Monto</th>
                                <th>Método</th>
                                <th>Referencia</th>
                                <th>Saldo Resultante</th>
                            </tr>
                        </thead>
                        <tbody id="historialPagosBody">
                        </tbody>
                    </table>
                </div>
                <div id="noHistorial" class="empty-state hidden">
                    <i class="fas fa-inbox"></i>
                    <p>No hay pagos registrados</p>
                </div>
            </div>
            
            
            <div id="tabPago" class="tab-content">
                <form id="formPago" class="form-grid">
                    <input type="hidden" id="pagoFacturaId">
                    <input type="hidden" id="pagoSaldoAnterior">
                    
                    <div class="form-group">
                        <label class="form-label required">Referencia/Recibo</label>
                        <input type="text" id="pagoReferencia" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">Método de Pago</label>
                        <select id="pagoMetodo" class="form-select" required>
                            <option value="">Seleccionar...</option>
                            <option value="EFECTIVO">Efectivo</option>
                            <option value="TRANSFERENCIA">Transferencia</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">Tipo de Pago</label>
                        <select id="pagoTipo" class="form-select" required>
                            <option value="Abono">Abono</option>
                            <option value="Total">Total</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">Monto</label>
                        <div class="input-group">
                            <span class="input-prefix">$</span>
                            <input type="number" id="pagoMonto" class="form-input" step="0.01" min="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group form-full">
                        <label class="form-label">Notas</label>
                        <textarea id="pagoNotas" class="form-textarea" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions form-full">
                        <button type="button" class="btn btn-secondary" onclick="cerrarModalFactura()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-accent">
                            <i class="fas fa-save"></i>
                            Registrar Pago
                        </button>
                    </div>
                </form>
            </div>


            <div id="tabProductos" class="tab-content">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio (+15% IVA)</th>
                                <th>Subtotal (+15%)</th>
                                <th>Zona</th>
                            </tr>
                        </thead>
                        <tbody id="productosFacturaBody">
                        </tbody>
                    </table>
                </div>
                <div id="noProductos" class="empty-state hidden">
                    <i class="fas fa-box-open"></i>
                    <p>No hay productos registrados en esta factura</p>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="modalNotas" class="modal">
    <div class="modal-overlay" onclick="cerrarModalNotas()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <i class="fas fa-sticky-note"></i>
                Notas de Proveedores
            </h3>
            <button class="modal-close" onclick="cerrarModalNotas()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="notas-section">
                <h4 class="section-title">
                    <i class="fas fa-exclamation-circle text-warning"></i>
                    Pendientes
                </h4>
                <div id="notasPendientesList" class="notas-list"></div>
                <div id="noNotasPendientes" class="empty-state hidden">
                    <p>No hay notas pendientes</p>
                </div>
            </div>
            
            <div class="notas-section">
                <h4 class="section-title">
                    <i class="fas fa-check-circle text-success"></i>
                    Resueltas
                </h4>
                <div id="notasResueltasList" class="notas-list"></div>
                <div id="noNotasResueltas" class="empty-state hidden">
                    <p>No hay notas resueltas</p>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="modalNotificar" class="modal">
    <div class="modal-overlay" onclick="cerrarModalNotificar()"></div>
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3>
                <i class="fas fa-bell"></i>
                Notificar Visita de Proveedor
            </h3>
            <button class="modal-close" onclick="cerrarModalNotificar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formNotificar">
                <div class="form-group">
                    <label class="form-label">Seleccionar Proveedor *</label>
                    <div id="proveedoresNotificarGrid" class="proveedores-grid">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Cargando proveedores...</p>
                        </div>
                    </div>
                    <input type="hidden" id="proveedorNotificarId" required>
                    <input type="hidden" id="proveedorNotificarNombre">
                </div>
                
                <div id="notasPendientesProveedor" class="notas-alerta hidden">
                    
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notificarDeuda" checked>
                            <span>Incluir información de deuda actual</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notificarMotivo">
                            <span>Incluir motivo específico de visita</span>
                        </label>
                    </div>
                </div>
                
                <div id="motivoContainer" class="form-group hidden">
                    <label class="form-label">Motivo de la Visita</label>
                    <textarea id="motivoVisita" class="form-textarea" rows="4" placeholder="Describe el motivo de la visita..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalNotificar()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-accent" id="btnEnviarNotificacion" disabled>
                        <i class="fas fa-paper-plane"></i>
                        Enviar Notificación
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<div id="modalAlertaProveedores" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-alerta">
        <div class="modal-body">
            <div class="alerta-icono" id="alertaIcono">
                <i class="fas fa-info-circle"></i>
            </div>
            <h3 id="alertaTitulo">Mensaje</h3>
            <p id="alertaMensaje"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="alertaBtnCancelar" style="display: none;">
                Cancelar
            </button>
            <button class="btn btn-accent" id="alertaBtnConfirmar">
                Aceptar
            </button>
        </div>
    </div>
</div>


<div id="progressOverlay" class="progress-overlay">
    <div class="progress-container">
        <div class="progress-icon">
            <i class="fas fa-save"></i>
        </div>
        <h3 class="progress-title">Guardando Pago</h3>
        <p class="progress-subtitle" id="progressSubtitle">Por favor espera...</p>
        
        <div class="progress-bar-wrapper">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="progress-steps" id="progressSteps">
            <div class="progress-step" data-step="1">
                <div class="progress-step-icon">
                    <i class="fas fa-check"></i>
                </div>
                <span>Validando datos</span>
            </div>
            <div class="progress-step" data-step="2">
                <div class="progress-step-icon">
                    <i class="fas fa-database"></i>
                </div>
                <span>Registrando pago</span>
            </div>
            <div class="progress-step" data-step="3">
                <div class="progress-step-icon">
                    <i class="fas fa-money-bill-transfer"></i>
                </div>
                <span>Procesando transferencia</span>
            </div>
            <div class="progress-step" data-step="4">
                <div class="progress-step-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <span>Finalizando</span>
            </div>
        </div>
    </div>
</div>

<div class="lp-solutions-footer">
    <div class="lp-powered-by">
        POWERED BY <img src="img/dev/lpsolutionsblack.webp" alt="LP Solutions" class="lp-brand-logo">
    </div>
</div>


<style>
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 99999 !important;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal.show,
    .modal.active {
        display: flex;
        opacity: 1;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(3px);
    }

    .modal-content {
        position: relative;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        z-index: 10001;
        animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
    }

    .modal-lg {
        max-width: 900px;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 2px solid #f0f0f0;
        background: linear-gradient(135deg, #d4a017 0%, #b8860b 100%);
        color: white;
        border-radius: 16px 16px 0 0;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.3em;
        color: white;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-header h3 i {
        font-size: 1.2em;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        cursor: pointer;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
        background: white;
    }

    .modal-footer {
        padding: 20px 24px;
        border-top: 2px solid #f0f0f0;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        background: white;
    }

    
    .progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        z-index: 20000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .progress-overlay.show {
        display: flex;
        opacity: 1;
    }

    .progress-container {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 20px;
        padding: 40px;
        min-width: 400px;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                    0 0 0 1px rgba(212, 160, 23, 0.2);
        text-align: center;
        animation: progressSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 2px solid rgba(212, 160, 23, 0.15);
    }

    @keyframes progressSlideIn {
        from {
            opacity: 0;
            transform: scale(0.8) translateY(30px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .progress-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 25px;
        background: linear-gradient(135deg, #d4a017 0%, #b8860b 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulseGlow 2s ease-in-out infinite;
        box-shadow: 0 10px 30px rgba(212, 160, 23, 0.4);
    }

    .progress-icon i {
        font-size: 2.5em;
        color: white;
        animation: rotateIcon 2s linear infinite;
    }

    @keyframes pulseGlow {
        0%, 100% {
            box-shadow: 0 10px 30px rgba(212, 160, 23, 0.4),
                        0 0 20px rgba(212, 160, 23, 0.2);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 15px 40px rgba(212, 160, 23, 0.6),
                        0 0 40px rgba(212, 160, 23, 0.4);
            transform: scale(1.05);
        }
    }

    @keyframes rotateIcon {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .progress-title {
        font-size: 1.5em;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 10px;
    }

    .progress-subtitle {
        font-size: 1em;
        color: #6b7280;
        margin-bottom: 30px;
    }

    .progress-bar-wrapper {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
        position: relative;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, 
            #d4a017 0%, 
            #ffd700 50%, 
            #d4a017 100%);
        background-size: 200% 100%;
        width: 0%;
        transition: width 0.3s ease;
        animation: shimmer 2s linear infinite;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(212, 160, 23, 0.5);
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .progress-steps {
        display: flex;
        flex-direction: column;
        gap: 12px;
        text-align: left;
    }

    .progress-step {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.95em;
        color: #9ca3af;
        transition: all 0.3s ease;
    }

    .progress-step.active {
        color: #d4a017;
        font-weight: 600;
    }

    .progress-step.completed {
        color: #10b981;
    }

    .progress-step-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75em;
        background: #e5e7eb;
        color: #6b7280;
        flex-shrink: 0;
        transition: all 0.3s ease;
    }

    .progress-step.active .progress-step-icon {
        background: linear-gradient(135deg, #d4a017 0%, #b8860b 100%);
        color: white;
        animation: bounce 0.6s ease;
    }

    .progress-step.completed .progress-step-icon {
        background: #10b981;
        color: white;
    }

    @keyframes bounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }

    
    .header-center {
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
    }

    .mode-tabs {
        display: flex;
        gap: 10px;
        background: var(--bg-primary);
        padding: 5px;
        border-radius: var(--border-radius-md);
    }

    .mode-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.95em;
        font-weight: 600;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .mode-tab:hover {
        background: var(--bg-white);
        color: var(--text-primary);
    }

    .mode-tab.active {
        background: var(--color-accent);
        color: white;
    }

    .mode-tab i {
        font-size: 1.1em;
    }

    
    .container-full {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
    }

    .vista-modo {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
        min-height: 0;
    }

    .vista-scroll {
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 25px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        background: var(--bg-body);
    }

    .vista-modo.hidden {
        display: none;
    }

    .vista-fullpage {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 999;
        background: var(--bg-body);
        overflow-y: auto;
    }

    .content-wrapper {
        display: block;
        padding: 20px;
        background: var(--bg-primary);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-sm);
    }

    .facturas-scroll-container {
        overflow: visible;
    }

    .facturas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .factura-card {
        background: var(--bg-white);
        border-radius: var(--border-radius-md);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
        cursor: pointer;
        border: 2px solid transparent;
    }

    .factura-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
        border-color: var(--color-accent);
    }

    .factura-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--bg-primary);
    }

    .factura-numero {
        font-weight: 700;
        color: var(--color-accent);
        font-size: 1.1em;
    }

    .factura-body {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .factura-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .factura-label {
        color: var(--text-secondary);
        font-size: 0.9em;
    }

    .factura-value {
        font-weight: 600;
        color: var(--text-primary);
    }

    .factura-total {
        font-size: 1.5em;
        color: var(--color-accent);
    }

    .factura-saldo {
        font-size: 1.2em;
        color: var(--color-info);
    }

    .factura-footer {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid var(--bg-primary);
        text-align: center;
    }

    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
    }

    .badge-pendiente {
        background: #fff3cd;
        color: #856404;
    }

    .badge-abonada {
        background: #cfe2ff;
        color: #084298;
    }

    .badge-pagada {
        background: #d1e7dd;
        color: #0f5132;
    }

    .badge-vencida {
        background: #f8d7da;
        color: #842029;
    }

    .badge-counter {
        background: var(--color-danger);
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 0.75em;
        margin-left: 5px;
    }

    .tabs-container {
        display: flex;
        gap: 10px;
        border-bottom: 2px solid var(--bg-primary);
        margin-bottom: 20px;
    }

    .tab-btn {
        background: none;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        color: var(--text-secondary);
        font-weight: 500;
        transition: all var(--transition-fast);
        border-bottom: 3px solid transparent;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tab-btn:hover {
        color: var(--color-accent);
    }

    .tab-btn.active {
        color: var(--color-accent);
        border-bottom-color: var(--color-accent);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .detail-item label {
        color: #666;
        font-size: 0.85em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-item span {
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.05em;
    }

    .detail-notas {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid var(--bg-primary);
    }

    .detail-notas label {
        color: #666;
        font-size: 0.85em;
        font-weight: 600;
        display: block;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .notas-text {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        color: #2c3e50;
        line-height: 1.6;
        border: 1px solid #e9ecef;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .form-full {
        grid-column: 1 / -1;
    }

    .input-group {
        position: relative;
        display: flex;
        align-items: center;
    }

    .input-prefix {
        position: absolute;
        left: 12px;
        color: var(--text-secondary);
        font-weight: 600;
        pointer-events: none;
    }

    .input-group .form-input {
        padding-left: 30px;
    }

    .notas-section {
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .notas-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
    }

    .nota-item {
        background: var(--bg-primary);
        padding: 15px;
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--color-warning);
    }

    .nota-item.resuelta {
        border-left-color: var(--color-success);
        opacity: 0.7;
    }

    .nota-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .nota-proveedor {
        font-weight: 600;
        color: var(--text-primary);
    }

    .nota-fecha {
        font-size: 0.85em;
        color: var(--text-secondary);
    }

    .nota-contenido {
        color: var(--text-primary);
        line-height: 1.5;
    }

    .loading-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
    }

    .loading-state .spinner {
        margin: 0 auto;
    }

    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.3;
        color: var(--text-secondary);
    }

    .empty-state p {
        font-size: 1.1em;
        color: var(--text-secondary);
    }

    .proveedores-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        padding: 15px;
        background: var(--bg-primary);
        border-radius: var(--border-radius-sm);
        max-height: 300px;
        overflow-y: auto;
    }

    .proveedor-btn {
        padding: 12px;
        background: white;
        border: 2px solid #ddd;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-weight: 500;
        text-align: center;
    }

    .proveedor-btn:hover {
        border-color: var(--color-accent);
        background: var(--color-accent);
        color: white;
        transform: translateY(-2px);
    }

    .proveedor-btn.selected {
        border-color: var(--color-accent);
        background: var(--color-accent);
        color: white;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
    }

    .checkbox-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .notas-alerta {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: var(--border-radius-sm);
        padding: 15px;
        margin: 15px 0;
    }

    .notas-alerta h4 {
        color: #856404;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .notas-alerta-lista {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
    }

    .nota-alerta-item {
        background: white;
        padding: 10px;
        border-radius: 6px;
        border-left: 3px solid #ffc107;
        font-size: 0.9em;
    }

    .nota-alerta-fecha {
        font-size: 0.8em;
        color: #856404;
        margin-bottom: 5px;
    }

    
    .container-full,
    .content-wrapper,
    .facturas-grid,
    .modal-body,
    .proveedores-grid,
    .notas-alerta-lista {
        scrollbar-width: thin;
        scrollbar-color: #d4a017 transparent;
    }

    .container-full::-webkit-scrollbar,
    .content-wrapper::-webkit-scrollbar,
    .facturas-grid::-webkit-scrollbar,
    .modal-body::-webkit-scrollbar,
    .proveedores-grid::-webkit-scrollbar,
    .notas-alerta-lista::-webkit-scrollbar {
        width: 3px;
        height: 3px;
    }

    .container-full::-webkit-scrollbar-track,
    .content-wrapper::-webkit-scrollbar-track,
    .facturas-grid::-webkit-scrollbar-track,
    .modal-body::-webkit-scrollbar-track,
    .proveedores-grid::-webkit-scrollbar-track,
    .notas-alerta-lista::-webkit-scrollbar-track {
        background: transparent;
    }

    .container-full::-webkit-scrollbar-thumb,
    .content-wrapper::-webkit-scrollbar-thumb,
    .facturas-grid::-webkit-scrollbar-thumb,
    .modal-body::-webkit-scrollbar-thumb,
    .proveedores-grid::-webkit-scrollbar-thumb,
    .notas-alerta-lista::-webkit-scrollbar-thumb {
        background: #d4a017;
        border-radius: 10px;
    }

    .container-full::-webkit-scrollbar-thumb:hover,
    .content-wrapper::-webkit-scrollbar-thumb:hover,
    .facturas-grid::-webkit-scrollbar-thumb:hover,
    .modal-body::-webkit-scrollbar-thumb:hover,
    .proveedores-grid::-webkit-scrollbar-thumb:hover,
    .notas-alerta-lista::-webkit-scrollbar-thumb:hover {
        background: #b8860b;
    }

    
    .modal-alerta {
        max-width: 450px;
        text-align: center;
    }

    .alerta-icono {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 2em;
    }

    .alerta-icono.info {
        background: rgba(52, 152, 219, 0.1);
        color: #3498db;
    }

    .alerta-icono.success {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
    }

    .alerta-icono.warning {
        background: rgba(241, 196, 15, 0.1);
        color: #f1c40f;
    }

    .alerta-icono.error {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
    }

    .modal-alerta h3 {
        font-size: 1.5em;
        margin-bottom: 15px;
        color: var(--text-primary);
    }

    .modal-alerta p {
        font-size: 1em;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 0;
    }

    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: center;
        padding: 20px 30px;
        border-top: 1px solid var(--bg-secondary);
    }

    .modal-footer .btn {
        min-width: 120px;
    }

    @media (max-width: 768px) {
        .details-grid,
        .form-grid {
            grid-template-columns: 1fr;
        }

        .facturas-grid {
            grid-template-columns: 1fr;
        }
    }
</style>


<div id="modalFacturaEmergencia" class="modal">
    <div class="modal-overlay" onclick="cerrarModalFacturaEmergencia()"></div>
    <div class="modal-content modal-lg">
        <div class="modal-header" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">
            <h3>
                <i class="fas fa-file-invoice-dollar"></i>
                Nueva Factura de Emergencia
            </h3>
            <button class="modal-close" onclick="cerrarModalFacturaEmergencia()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="alert alert-info" style="margin-bottom: 20px; background-color: #e3f2fd; color: #0c5460; padding: 10px; border-radius: 8px; border: 1px solid #bee5eb;">
                <i class="fas fa-info-circle"></i>
                Esta opción permite registrar facturas sin productos detallados (gastos, servicios, facturas antiguas, etc).
            </div>

            <form id="formFacturaEmergencia" class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Proveedor</label>
                    <select id="emergenciaProveedor" class="form-select" required onchange="actualizarDeudaProveedorEmergencia()">
                        <option value="">Seleccionar proveedor...</option>
                    </select>
                    <div id="emergenciaDeudaInfo" class="text-info" style="font-size: 0.9em; margin-top: 5px; display: none;">
                        <i class="fas fa-info-circle"></i> Deuda actual: <span id="emergenciaDeudaMonto" style="font-weight: bold;">$0.00</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Número de Factura</label>
                    <input type="text" id="emergenciaNumero" class="form-input" placeholder="001-001-000000000" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Fecha de Emisión</label>
                    <input type="date" id="emergenciaFechaEmision" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Fecha de Vencimiento</label>
                    <input type="date" id="emergenciaFechaVencimiento" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Total Factura</label>
                    <div class="input-group">
                        <span class="input-prefix">$</span>
                        <input type="number" id="emergenciaTotal" class="form-input" step="0.01" min="0.01" placeholder="0.00" required>
                    </div>
                </div>
                
                <div class="form-group form-full">
                    <label class="form-label">Notas / Observaciones</label>
                    <textarea id="emergenciaNotas" class="form-textarea" rows="3" placeholder="Detalles adicionales sobre esta factura..."></textarea>
                </div>
                
                <div class="form-actions form-full">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalFacturaEmergencia()">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-accent" onclick="guardarFacturaEmergencia(event)" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); border: none;">
                        <i class="fas fa-save"></i>
                        Guardar Factura
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// MÓDULO PROVEEDORES - Gestión de Facturas

// =====================================================
// SISTEMA DE LOGGING
// =====================================================
const DEBUG_PROVEEDORES = true;

function logProveedor(mensaje, ...datos) {
    if (DEBUG_PROVEEDORES) {
        const timestamp = new Date().toLocaleTimeString();
    }
}

function logError(mensaje, error) {
    const timestamp = new Date().toLocaleTimeString();
    console.error(`%c[ERROR ${timestamp}]`, 'color: #ff0000; font-weight: bold;', mensaje, error);
    if (error?.message) console.error('Error message:', error.message);
    if (error?.details) console.error('Error details:', error.details);
    if (error?.hint) console.error('Error hint:', error.hint);
}

function logWarning(mensaje, ...datos) {
    if (DEBUG_PROVEEDORES) {
        const timestamp = new Date().toLocaleTimeString();
        console.warn(`%c[WARNING ${timestamp}]`, 'color: #ffa500; font-weight: bold;', mensaje, ...datos);
    }
}

// Helper para obtener cliente de Supabase
function getSupabaseClient() {
    const client = window.app?.db || window.supabaseClient || null;
    if (!client) {
        logError('Cliente de Supabase no encontrado');
    }
    return client;
}

let proveedoresData = {
    facturas: [],
    proveedores: [],
    notas: [],
    facturaActual: null,
    modoActual: 'facturas' // 'facturas' o 'productos'
};

// CAMBIO DE MODO

window.cambiarModoProveedor = cambiarModoProveedor;

async function cambiarModoProveedor(modo) {
    
    proveedoresData.modoActual = modo;
    
    // Actualizar tabs
    document.querySelectorAll('.mode-tab').forEach(tab => {
        if (tab.dataset.mode === modo) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // Mostrar/ocultar vistas
    if (modo === 'facturas') {
        const vistaFacturas = document.getElementById('vistaFacturas');
        const vistaProductos = document.getElementById('vistaProductos');
        const vistaComparador = document.getElementById('vistaComparador');
        
        if (vistaFacturas) vistaFacturas.classList.remove('hidden');
        if (vistaProductos) vistaProductos.classList.add('hidden');
        if (vistaComparador) vistaComparador.classList.add('hidden');
    } else if (modo === 'productos') {
        const vistaFacturas = document.getElementById('vistaFacturas');
        const vistaProductos = document.getElementById('vistaProductos');
        const vistaComparador = document.getElementById('vistaComparador');
        
        if (vistaFacturas) vistaFacturas.classList.add('hidden');
        if (vistaProductos) vistaProductos.classList.remove('hidden');
        if (vistaComparador) vistaComparador.classList.add('hidden');
        
        // Cargar módulo de ingreso de facturas
        await cargarModuloIngresoFactura();
        
        // Verificar si hay caché de ingreso de factura y mostrar notificación
        const tieneCacheIngreso = verificarCacheIngresoFactura();
        if (tieneCacheIngreso) {
            setTimeout(() => {
                if (typeof proveedoresAlert === 'function') {
                    proveedoresAlert(
                        'Tienes una factura en proceso. Puedes continuar desde donde lo dejaste.',
                        'info',
                        'Sesión Pendiente'
                    );
                }
            }, 500);
        }
    } else if (modo === 'comparador') {
        const vistaFacturas = document.getElementById('vistaFacturas');
        const vistaProductos = document.getElementById('vistaProductos');
        const vistaComparador = document.getElementById('vistaComparador');
        
        if (vistaFacturas) vistaFacturas.classList.add('hidden');
        if (vistaProductos) vistaProductos.classList.add('hidden');
        if (vistaComparador) vistaComparador.classList.remove('hidden');
        
        // Cargar módulo de comparador
        await cargarModuloComparador();
    }
}

async function cargarModuloIngresoFactura() {
    const container = document.getElementById('ingresoFacturaContainer');
    if (!container) return; // Vista cambiada
    
    if (container.innerHTML.trim() === '') {
        
        try {
            // Cargar el HTML del módulo
            const response = await fetch('views/ingreso-factura.html');
            if (!response.ok) throw new Error('No se pudo cargar ingreso-factura.html');
            
            const html = await response.text();
            container.innerHTML = html;
            
            // Cargar el JavaScript del módulo
            const script = document.createElement('script');
            script.src = 'js/ingreso-factura.js';
            script.onload = () => {
                if (typeof initIngresoFactura === 'function') {
                    initIngresoFactura(proveedoresData.proveedores);
                }
            };
            script.onerror = () => {
                container.innerHTML = '<div class="empty-state"><p>Error al cargar el módulo de ingreso</p></div>';
            };
            document.body.appendChild(script);
            
        } catch (error) {
            container.innerHTML = '<div class="empty-state"><p>Error al cargar el módulo</p></div>';
        }
    }
}

// Función global para volver desde el comparador
window.volverAProveedores = function() {
    cambiarModoProveedor('facturas');
};

async function cargarModuloComparador() {
    const container = document.getElementById('comparadorContainer');
    if (!container) return; // Vista cambiada
    
    if (container.innerHTML.trim() === '') {
        
        try {
            // Cargar el HTML del módulo
            const response = await fetch('views/comparador.html');
            if (!response.ok) throw new Error('No se pudo cargar comparador.html');
            
            const html = await response.text();
            container.innerHTML = html;
            
            console.log('✅ Módulo comparador HTML insertado');
            
            // Extraer y ejecutar los scripts manualmente
            const scripts = container.querySelectorAll('script');
            console.log(`🔧 Encontrados ${scripts.length} scripts en el módulo`);
            
            scripts.forEach((oldScript, index) => {
                const newScript = document.createElement('script');
                if (oldScript.src) {
                    newScript.src = oldScript.src;
                } else {
                    newScript.textContent = oldScript.textContent;
                }
                document.body.appendChild(newScript);
                oldScript.remove();
                console.log(`✅ Script ${index + 1} ejecutado`);
            });
            
            // Esperar a que los scripts se ejecuten
            setTimeout(() => {
                if (typeof window.initComparador === 'function') {
                    console.log('🔧 Llamando initComparador manualmente...');
                    window.initComparador();
                } else {
                    console.error('❌ window.initComparador no está definida');
                }
            }, 300);
            
        } catch (error) {
            console.error('Error cargando módulo comparador:', error);
            container.innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f44336;"></i>
                    <h3 style="margin-top: 20px;">Error al cargar el módulo</h3>
                    <p style="color: #666;">${error.message}</p>
                </div>
            `;
        }
    } else {
        // Si ya está cargado, solo reinicializar
        if (typeof window.initComparador === 'function') {
            await window.initComparador();
        }
    }
}

// INICIALIZACIÓN

async function initProveedores() {
    
    // Actualizar contador del navbar
    updateNavbarCounter('proveedores', 'Facturas');
    
    // Cargar datos
    await Promise.all([
        cargarProveedoresData(),
        cargarFacturasData(),
        cargarNotasData()
    ]);
    
    // Configurar event listeners
    setupProveedoresListeners();
}

function verificarCacheIngresoFactura() {
    try {
        const cacheString = localStorage.getItem('ingresoFacturaCache');
        if (!cacheString) return false;
        
        const cache = JSON.parse(cacheString);
        
        // Verificar que no tenga más de 24 horas
        const timestamp = new Date(cache.timestamp);
        const ahora = new Date();
        const horasTranscurridas = (ahora - timestamp) / (1000 * 60 * 60);
        
        if (horasTranscurridas > 24) {
            localStorage.removeItem('ingresoFacturaCache');
            return false;
        }
        
        return true;
    } catch (error) {
        return false;
    }
}

function setupProveedoresListeners() {
    // Selectores de filtro
    document.getElementById('proveedorSelector')?.addEventListener('change', filtrarFacturasProveedores);
    document.getElementById('estadoSelector')?.addEventListener('change', filtrarFacturasProveedores);
    
    // Formulario de pago
    document.getElementById('formPago')?.addEventListener('submit', registrarPagoProveedor);
    document.getElementById('pagoTipo')?.addEventListener('change', actualizarTipoPagoProveedor);
    document.getElementById('pagoMonto')?.addEventListener('input', validarMontoPagoProveedor);
    
    // Formulario de notificación
    document.getElementById('formNotificar')?.addEventListener('submit', enviarNotificacionProveedor);
    document.getElementById('notificarDeuda')?.addEventListener('change', actualizarCheckboxesNotificacion);
    document.getElementById('notificarMotivo')?.addEventListener('change', actualizarCheckboxesNotificacion);
    
    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => cambiarTabProveedor(btn.dataset.tab));
    });
}

// =====================================================
// CARGA DE DATOS
// =====================================================

async function cargarProveedoresData() {
    try {
        const client = getSupabaseClient();
        const { data, error } = await client
            .from('ferre_proveedores')
            .select('id, codigo, empresa')
            .order('empresa', { ascending: true });
        
        if (error) throw error;
        
        proveedoresData.proveedores = data || [];
        
        // Llenar selector
        const selector = document.getElementById('proveedorSelector');
        if (!selector) return; // Vista cambiada
        
        selector.innerHTML = '<option value="todos">Todos los proveedores</option>';
        
        data.forEach(proveedor => {
            const option = document.createElement('option');
            option.value = proveedor.id;
            option.textContent = proveedor.empresa;
            selector.appendChild(option);
        });
        
    } catch (error) {
        mostrarNotificacionProveedor('Error al cargar proveedores', 'error');
    }
}

async function cargarFacturasData() {
    logProveedor('🔵 Cargando facturas desde Supabase...');
    try {
        // Mostrar loading en el grid
        const grid = document.getElementById('facturasGrid');
        if (!grid) {
            logProveedor('⚠️ Grid de facturas no encontrado (vista no montada)');
            return;
        }
        
        grid.innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Cargando facturas...</p>
            </div>
        `;
        
        const client = getSupabaseClient();
        logProveedor('Consultando vista v_facturas_proveedores_completa...');
        
        const { data, error } = await client
            .from('ferre_v_facturas_proveedores_completa')
            .select('*')
            .order('fecha_vencimiento', { ascending: true });
        
        if (error) {
            logError('❌ Error al cargar facturas:', error);
            throw error;
        }
        
        logProveedor(`✅ Facturas cargadas: ${data?.length || 0} registros`);
        proveedoresData.facturas = data || [];
        filtrarFacturasProveedores();
        
    } catch (error) {
        mostrarNotificacionProveedor('Error al cargar facturas', 'error');
        const grid = document.getElementById('facturasGrid');
        if (grid) {
            grid.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error al cargar las facturas</p>
                </div>
            `;
        }
    }
}

async function cargarNotasData() {
    try {
        const client = getSupabaseClient();
        const { data, error } = await client
            .from('ferre_notas_proveedores')
            .select(`
                *,
                proveedor:ferre_proveedores(empresa)
            `)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        proveedoresData.notas = data || [];
        
        // Actualizar contador solo si el elemento existe
        const badge = document.getElementById('badgeNotas');
        if (badge) {
            const pendientes = data.filter(n => n.estado === 'Pendiente');
            if (pendientes.length > 0) {
                badge.textContent = pendientes.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
    } catch (error) {
        logError('Error cargando notas:', error);
    }
}

// =====================================================
// VISUALIZACIÓN
// =====================================================

function filtrarFacturasProveedores() {
    const proveedorSelector = document.getElementById('proveedorSelector');
    const estadoSelector = document.getElementById('estadoSelector');
    
    if (!proveedorSelector || !estadoSelector) {
        mostrarFacturasProveedores(proveedoresData.facturas);
        actualizarResumenProveedores(proveedoresData.facturas);
        return;
    }
    
    const proveedorId = proveedorSelector.value;
    const estado = estadoSelector.value;
    
    let facturasFiltradas = [...proveedoresData.facturas];
    
    // Filtrar por proveedor
    if (proveedorId !== 'todos') {
        facturasFiltradas = facturasFiltradas.filter(f => f.proveedor_id === proveedorId);
    }
    
    // Filtrar por estado
    if (estado === 'pendientes') {
        facturasFiltradas = facturasFiltradas.filter(f => 
            f.estado === 'Pendiente' || f.estado === 'Abonada'
        );
    } else if (estado === 'pagadas') {
        facturasFiltradas = facturasFiltradas.filter(f => f.estado === 'Pagada');
    }
    
    mostrarFacturasProveedores(facturasFiltradas);
    actualizarResumenProveedores(facturasFiltradas);
}

function mostrarFacturasProveedores(facturas) {
    const grid = document.getElementById('facturasGrid');
    
    if (!grid) {
        logProveedor('⚠️ Grid de facturas no encontrado (vista no montada)');
        return;
    }
    
    if (!facturas || facturas.length === 0) {
        grid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No hay facturas para mostrar</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = facturas.map(factura => crearTarjetaFacturaProveedor(factura)).join('');
    
    // Agregar event listeners a las tarjetas
    grid.querySelectorAll('.factura-card').forEach(card => {
        card.addEventListener('click', function() {
            const facturaId = this.dataset.facturaId;
            const factura = proveedoresData.facturas.find(f => f.id === facturaId);
            if (factura) {
                abrirDetalleFactura(factura);
            }
        });
    });
}

function crearTarjetaFacturaProveedor(factura) {
    let estadoClass = '';
    if (factura.estado === 'Pendiente') estadoClass = 'badge-pendiente';
    else if (factura.estado === 'Abonada') estadoClass = 'badge-abonada';
    else if (factura.estado === 'Pagada') estadoClass = 'badge-pagada';
    
    const vencimientoHTML = factura.esta_vencida ? 
        `<span class="badge badge-vencida">Vencida (${Math.abs(factura.dias_vencimiento)} días)</span>` : 
        `<span class="text-secondary">Vence en ${factura.dias_vencimiento} días</span>`;
    
    return `
        <div class="factura-card" data-factura-id="${factura.id}">
            <div class="factura-header">
                <span class="factura-numero">${factura.numero_factura}</span>
                <span class="badge ${estadoClass}">${factura.estado}</span>
            </div>
            <div class="factura-body">
                <div class="factura-row">
                    <span class="factura-label">Proveedor:</span>
                    <span class="factura-value">${factura.proveedor_empresa}</span>
                </div>
                <div class="factura-row">
                    <span class="factura-label">Total:</span>
                    <span class="factura-value factura-total">${formatCurrency(factura.total_factura)}</span>
                </div>
                <div class="factura-row">
                    <span class="factura-label">Saldo:</span>
                    <span class="factura-value factura-saldo">${formatCurrency(factura.saldo_pendiente)}</span>
                </div>
                <div class="factura-row">
                    <span class="factura-label">Emisión:</span>
                    <span class="factura-value">${formatDate(factura.fecha_emision)}</span>
                </div>
                <div class="factura-row">
                    <span class="factura-label">Vencimiento:</span>
                    <span class="factura-value">${formatDate(factura.fecha_vencimiento)}</span>
                </div>
            </div>
            <div class="factura-footer">
                ${vencimientoHTML}
            </div>
        </div>
    `;
}

function actualizarResumenProveedores(facturas) {
    let totalFacturas = 0;
    let totalPendiente = 0;
    let totalVencido = 0;
    
    facturas.forEach(factura => {
        totalFacturas += parseFloat(factura.total_factura) || 0;
        totalPendiente += parseFloat(factura.saldo_pendiente) || 0;
        
        if (factura.esta_vencida && factura.saldo_pendiente > 0) {
            totalVencido += parseFloat(factura.saldo_pendiente) || 0;
        }
    });
    
    const elemTotalFacturas = document.getElementById('totalFacturas');
    const elemTotalPendiente = document.getElementById('totalPendiente');
    const elemTotalVencido = document.getElementById('totalVencido');
    
    if (elemTotalFacturas) elemTotalFacturas.textContent = formatCurrency(totalFacturas);
    if (elemTotalPendiente) elemTotalPendiente.textContent = formatCurrency(totalPendiente);
    if (elemTotalVencido) elemTotalVencido.textContent = formatCurrency(totalVencido);
}

// =====================================================
// MODAL FACTURA
// =====================================================

async function abrirDetalleFactura(factura) {
    logProveedor('🔵 Abriendo detalle de factura:', factura);
    proveedoresData.facturaActual = factura;
    
    // Verificar elementos antes de manipular
    const modalTitulo = document.getElementById('modalFacturaTitulo');
    const detNumero = document.getElementById('detNumeroFactura');
    const detProveedor = document.getElementById('detProveedor');
    const detFechaEmision = document.getElementById('detFechaEmision');
    const detFechaVencimiento = document.getElementById('detFechaVencimiento');
    const detSubtotal = document.getElementById('detSubtotal');
    const detIva = document.getElementById('detIva');
    const detDescuento = document.getElementById('detDescuento');
    const detTotalFactura = document.getElementById('detTotalFactura');
    const detSaldoPendiente = document.getElementById('detSaldoPendiente');
    const estadoBadge = document.getElementById('detEstado');
    const detDiasVencimiento = document.getElementById('detDiasVencimiento');
    const detNotas = document.getElementById('detNotas');
    const pagoFacturaId = document.getElementById('pagoFacturaId');
    const pagoSaldoAnterior = document.getElementById('pagoSaldoAnterior');
    const pagoMonto = document.getElementById('pagoMonto');
    const formPago = document.getElementById('formPago');
    const modalFactura = document.getElementById('modalFactura');
    
    // Si el modal no existe, el usuario cambió de vista
    if (!modalFactura) {
        logProveedor('⚠️ Modal no encontrado, vista cambiada');
        return;
    }
    
    // Llenar detalles
    if (modalTitulo) modalTitulo.textContent = `Factura ${factura.numero_factura}`;
    if (detNumero) detNumero.textContent = factura.numero_factura;
    if (detProveedor) detProveedor.textContent = factura.proveedor_empresa;
    if (detFechaEmision) detFechaEmision.textContent = formatDate(factura.fecha_emision);
    if (detFechaVencimiento) detFechaVencimiento.textContent = formatDate(factura.fecha_vencimiento);
    
    // Mostrar Subtotal, IVA y Descuento si están disponibles
    if (detSubtotal) detSubtotal.textContent = formatCurrency(factura.subtotal || 0);
    if (detIva) detIva.textContent = formatCurrency(factura.iva || 0);
    if (detDescuento) detDescuento.textContent = '-' + formatCurrency(factura.descuento || 0);
    
    if (detTotalFactura) detTotalFactura.textContent = formatCurrency(factura.total_factura);
    if (detSaldoPendiente) detSaldoPendiente.textContent = formatCurrency(factura.saldo_pendiente);
    
    if (estadoBadge) {
        estadoBadge.textContent = factura.estado;
        estadoBadge.className = 'badge';
        if (factura.estado === 'Pendiente') estadoBadge.classList.add('badge-pendiente');
        else if (factura.estado === 'Abonada') estadoBadge.classList.add('badge-abonada');
        else if (factura.estado === 'Pagada') estadoBadge.classList.add('badge-pagada');
    }
    
    const diasTexto = factura.esta_vencida ? 
        `Vencida hace ${Math.abs(factura.dias_vencimiento)} días` : 
        `${factura.dias_vencimiento} días`;
    if (detDiasVencimiento) detDiasVencimiento.textContent = diasTexto;
    
    if (detNotas) detNotas.textContent = factura.notas || 'Sin notas';
    
    // Cargar historial y productos
    await Promise.all([
        cargarHistorialPagosProveedor(factura.id),
        cargarProductosFacturaProveedor(factura.id)
    ]);
    
    // Preparar formulario de pago
    if (pagoFacturaId) pagoFacturaId.value = factura.id;
    if (pagoSaldoAnterior) pagoSaldoAnterior.value = factura.saldo_pendiente;
    if (pagoMonto) {
        pagoMonto.max = factura.saldo_pendiente;
        pagoMonto.placeholder = factura.saldo_pendiente.toFixed(2);
    }
    if (formPago) formPago.reset();
    
    // Mostrar modal y tab de detalles
    cambiarTabProveedor('detalles');
    modalFactura.classList.add('show');
}

function cerrarModalFactura() {
    const modal = document.getElementById('modalFactura');
    if (modal) modal.classList.remove('show');
    proveedoresData.facturaActual = null;
}

function cambiarTabProveedor(tabName) {
    // Cambiar botones
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
    
    // Cambiar contenido
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    const tabContent = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
    if (tabContent) tabContent.classList.add('active');
}

async function cargarHistorialPagosProveedor(facturaId) {
    try {
        const client = getSupabaseClient();
        const { data, error } = await client
            .from('ferre_pagos_proveedores')
            .select('*')
            .eq('factura_id', facturaId)
            .order('fecha_pago', { ascending: false });
        
        if (error) throw error;
        
        const tbody = document.getElementById('historialPagosBody');
        const noHistorial = document.getElementById('noHistorial');
        
        // Si los elementos no existen, el usuario cambió de vista
        if (!tbody || !noHistorial) return;
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '';
            noHistorial.classList.remove('hidden');
            return;
        }
        
        noHistorial.classList.add('hidden');
        tbody.innerHTML = data.map(pago => `
            <tr>
                <td>${formatDateTime(pago.fecha_pago)}</td>
                <td class="text-accent">${formatCurrency(pago.monto_pago)}</td>
                <td><span class="badge">${pago.metodo_pago}</span></td>
                <td>${pago.referencia_pago}</td>
                <td class="text-info">${formatCurrency(pago.saldo_nuevo)}</td>
            </tr>
        `).join('');
        
    } catch (error) {
    }
}

async function cargarProductosFacturaProveedor(facturaId) {
    try {
        const client = getSupabaseClient();
        const { data, error } = await client
            .from('ferre_detalle_facturas_proveedores')
            .select('*')
            .eq('factura_id', facturaId);
        
        if (error) throw error;
        
        const tbody = document.getElementById('productosFacturaBody');
        const noProductos = document.getElementById('noProductos');
        
        if (!tbody || !noProductos) return;
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '';
            noProductos.classList.remove('hidden');
            return;
        }
        
        noProductos.classList.add('hidden');
        tbody.innerHTML = data.map(p => {
            // Precio con 15% IVA (visual)
            const precioConIva = (parseFloat(p.precio_proveedor) || 0) * 1.15;
            const subtotalConIva = (parseFloat(p.cantidad) || 0) * precioConIva;
            
            return `
                <tr>
                    <td><strong>${p.codigo_producto}</strong></td>
                    <td>${p.nombre_producto}</td>
                    <td>${parseFloat(p.cantidad).toFixed(2)}</td>
                    <td class="text-accent">${formatCurrency(precioConIva)}</td>
                    <td class="text-info">${formatCurrency(subtotalConIva)}</td>
                    <td><span class="badge">${p.zona || 'N/A'}</span></td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error al cargar productos de factura:', error);
    }
}

// =====================================================
// REGISTRO DE PAGOS
// =====================================================

function actualizarTipoPagoProveedor() {
    const pagoSaldoAnterior = document.getElementById('pagoSaldoAnterior');
    const montoPagoInput = document.getElementById('pagoMonto');
    const tipoPago = document.getElementById('pagoTipo');
    
    if (!pagoSaldoAnterior || !montoPagoInput || !tipoPago) return;
    
    const saldoAnterior = parseFloat(pagoSaldoAnterior.value);
    
    if (tipoPago.value === 'Total') {
        montoPagoInput.value = saldoAnterior.toFixed(2);
        montoPagoInput.readOnly = true;
    } else {
        montoPagoInput.readOnly = false;
        if (parseFloat(montoPagoInput.value) === saldoAnterior) {
            montoPagoInput.value = '';
        }
    }
}

function validarMontoPagoProveedor() {
    const pagoSaldoAnterior = document.getElementById('pagoSaldoAnterior');
    const montoPagoInput = document.getElementById('pagoMonto');
    const tipoPagoSelect = document.getElementById('pagoTipo');
    
    if (!pagoSaldoAnterior || !montoPagoInput || !tipoPagoSelect) return;
    
    const saldoAnterior = parseFloat(pagoSaldoAnterior.value);
    
    let valor = montoPagoInput.value.replace(',', '.');
    const monto = parseFloat(valor);
    
    if (!isNaN(monto)) {
        if (Math.abs(monto - saldoAnterior) < 0.01 || monto > saldoAnterior) {
            montoPagoInput.value = saldoAnterior.toFixed(2);
            tipoPagoSelect.value = 'Total';
            montoPagoInput.readOnly = true;
        } else {
            tipoPagoSelect.value = 'Abono';
            montoPagoInput.readOnly = false;
        }
    }
}

async function registrarPagoProveedor(e) {
    e.preventDefault();
    logProveedor('🔵 Iniciando registro de pago');
    
    const pagoSaldoAnterior = document.getElementById('pagoSaldoAnterior');
    const montoPagoInput = document.getElementById('pagoMonto');
    const tipoPagoElem = document.getElementById('pagoTipo');
    const metodoPagoElem = document.getElementById('pagoMetodo');
    const pagoFacturaIdElem = document.getElementById('pagoFacturaId');
    const pagoReferenciaElem = document.getElementById('pagoReferencia');
    const pagoNotasElem = document.getElementById('pagoNotas');
    
    if (!pagoSaldoAnterior || !montoPagoInput || !tipoPagoElem || !metodoPagoElem) {
        logProveedor('⚠️ Elementos del formulario no encontrados, vista cambiada');
        return;
    }
    
    const saldoAnterior = parseFloat(pagoSaldoAnterior.value);
    const tipoPago = tipoPagoElem.value;
    const metodoPago = metodoPagoElem.value;
    
    let montoPago = tipoPago === 'Total' ? saldoAnterior : parseFloat(montoPagoInput.value);
    
    logProveedor('Datos del pago:', {
        saldoAnterior,
        montoPago,
        tipoPago,
        metodoPago,
        montoPagoInput: montoPagoInput.value
    });
    
    if (isNaN(montoPago) || montoPago <= 0) {
        logWarning('Monto inválido:', montoPago);
        mostrarNotificacionProveedor('Monto inválido', 'error');
        return;
    }
    
    if (montoPago > saldoAnterior + 0.001) {
        logWarning('Monto mayor al saldo:', { montoPago, saldoAnterior });
        mostrarNotificacionProveedor('El monto no puede ser mayor al saldo pendiente', 'error');
        return;
    }
    
    const saldoNuevo = saldoAnterior - montoPago;
    
    const datosInsert = {
        factura_id: pagoFacturaIdElem ? pagoFacturaIdElem.value : null,
        monto_pago: montoPago,
        metodo_pago: metodoPago,
        tipo_pago: tipoPago,
        referencia_pago: pagoReferenciaElem ? pagoReferenciaElem.value : '',
        saldo_nuevo: saldoNuevo,
        notas: pagoNotasElem ? pagoNotasElem.value || null : null
    };
    
    logProveedor('📤 Datos a enviar a Supabase:', datosInsert);
    
    const esTransferencia = metodoPago.toUpperCase().includes('TRANSFER');
    
    try {
        // Mostrar barra de progreso
        showProgressOverlay(esTransferencia);
        await sleep(300);
        
        // Paso 1: Validando datos
        updateProgressStep(1, 'active');
        updateProgressBar(25);
        await sleep(400);
        updateProgressStep(1, 'completed');
        
        const client = getSupabaseClient();
        
        if (!client) {
            throw new Error('Cliente de Supabase no disponible');
        }
        
        // Paso 2: Registrando pago
        updateProgressStep(2, 'active');
        updateProgressBar(50);
        
        logProveedor('Enviando INSERT a pagos_proveedores...');
        const { data, error } = await client
            .from('ferre_pagos_proveedores')
            .insert(datosInsert)
            .select();
        
        if (error) {
            logError('❌ Error de Supabase al insertar pago:', error);
            throw error;
        }
        
        logProveedor('✅ Pago registrado exitosamente:', data);
        await sleep(400);
        updateProgressStep(2, 'completed');
        
        // Paso 3: Procesando transferencia (si aplica)
        if (esTransferencia) {
            updateProgressStep(3, 'active');
            updateProgressBar(75);
            updateProgressSubtitle('Procesando transferencia y enviando notificación...');
            
            logProveedor('💸 Procesando transferencia...');
            await procesarTransferenciaProveedor({
                factura: proveedoresData.facturaActual,
                monto: montoPago,
                numeroFactura: proveedoresData.facturaActual.numero_factura
            }, client);
            
            await sleep(500);
            updateProgressStep(3, 'completed');
        } else {
            // Ocultar paso de transferencia si no aplica
            const step3 = document.querySelector('[data-step=\"3\"]');
            if (step3) step3.style.display = 'none';
            updateProgressBar(75);
            await sleep(300);
        }
        
        // Paso 4: Finalizando
        updateProgressStep(4, 'active');
        updateProgressBar(90);
        await cargarFacturasData();
        await sleep(400);
        updateProgressStep(4, 'completed');
        updateProgressBar(100);
        await sleep(500);
        
        // Ocultar progreso y cerrar modal
        hideProgressOverlay();
        cerrarModalFactura();
        mostrarNotificacionProveedor('Pago registrado correctamente', 'success');
        
    } catch (error) {
        hideProgressOverlay();
        logError('❌ Error al registrar pago:', error);
        mostrarNotificacionProveedor('Error al registrar el pago: ' + (error.message || 'Error desconocido'), 'error');
    }
}

// =====================================================
// CONTROL DE BARRA DE PROGRESO
// =====================================================

function showProgressOverlay(conTransferencia = false) {
    const overlay = document.getElementById('progressOverlay');
    if (!overlay) return;
    
    const step3 = document.querySelector('[data-step="3"]');
    
    // Mostrar/ocultar paso de transferencia según sea necesario
    if (step3) {
        step3.style.display = conTransferencia ? 'flex' : 'none';
    }
    
    // Resetear progreso
    updateProgressBar(0);
    updateProgressSubtitle('Por favor espera...');
    
    // Resetear todos los pasos
    document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active', 'completed');
    });
    
    overlay.classList.add('show');
}

function hideProgressOverlay() {
    const overlay = document.getElementById('progressOverlay');
    if (overlay) overlay.classList.remove('show');
}

function updateProgressBar(percentage) {
    const bar = document.getElementById('progressBar');
    if (bar) {
        bar.style.width = percentage + '%';
    }
}

function updateProgressStep(stepNumber, status) {
    const step = document.querySelector(`[data-step="${stepNumber}"]`);
    if (step) {
        step.classList.remove('active', 'completed');
        if (status) {
            step.classList.add(status);
        }
    }
}

function updateProgressSubtitle(text) {
    const subtitle = document.getElementById('progressSubtitle');
    if (subtitle) {
        subtitle.textContent = text;
    }
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// =====================================================
// PROCESAMIENTO DE TRANSFERENCIAS
// =====================================================

function generarComprobantePagoCanvasProveedor(datos) {
    logProveedor('🎨 Generando comprobante de pago en canvas');
    try {
        const canvas = document.createElement('canvas');
        canvas.width = 600;
        canvas.height = 350;
        const ctx = canvas.getContext('2d');
        
        // Fondo blanco
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Borde
        ctx.strokeStyle = '#d4a017';
        ctx.lineWidth = 4;
        ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
        
        // Título
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = '#d4a017';
        ctx.textAlign = 'center';
        ctx.fillText('COMPROBANTE DE PAGO', canvas.width / 2, 50);
        
        // Línea separadora
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(30, 70);
        ctx.lineTo(canvas.width - 30, 70);
        ctx.stroke();
        
        // Información
        ctx.font = '18px Arial';
        ctx.fillStyle = '#374151';
        ctx.textAlign = 'left';
        
        ctx.fillText(`Proveedor: ${datos.proveedor}`, 40, 110);
        ctx.fillText(`Factura N°: ${datos.numeroFactura}`, 40, 145);
        
        ctx.font = 'bold 22px Arial';
        ctx.fillStyle = '#d4a017';
        ctx.fillText(`Monto: $${datos.monto.toFixed(2)}`, 40, 190);
        
        ctx.font = '16px Arial';
        ctx.fillStyle = '#6b7280';
        ctx.fillText(`Fecha: ${datos.fecha || new Date().toLocaleDateString('es-EC')}`, 40, 230);
        ctx.fillText(`Método: TRANSFERENCIA`, 40, 260);
        
        // Footer
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#9ca3af';
        ctx.fillText('Generado por Ferrisoluciones', canvas.width / 2, 310);
        
        const dataUrl = canvas.toDataURL('image/png');
        logProveedor('✅ Comprobante generado correctamente');
        return dataUrl;
    } catch (e) {
        logError('Error al generar comprobante:', e);
        return null;
    }
}

async function procesarTransferenciaProveedor(datos, client) {
    try {
        const proveedorNombre = datos.factura.proveedor_empresa || 'Proveedor';
        const motivo = `Pago a ${proveedorNombre} por factura ${datos.numeroFactura} - Monto: $${datos.monto.toFixed(2)}`;
        
        logProveedor('📝 Registrando transferencia:', { proveedorNombre, motivo });
        
        // Generar comprobante en base64
        const fotoDataUrl = generarComprobantePagoCanvasProveedor({
            proveedor: proveedorNombre,
            numeroFactura: datos.numeroFactura,
            monto: datos.monto,
            fecha: formatDate(new Date())
        });
        
        // Obtener información del usuario desde el header del navbar
        const userNameElement = document.getElementById('userName');
        const userName = userNameElement ? userNameElement.textContent.trim() : 'Usuario';
        const userEmail = window.app?.user?.email || 'sistema@ferreteria.com';
        const userId = window.app?.user?.id || null;
        
        logProveedor('👤 Usuario que registra:', { userName, userEmail });
        
        // Preparar registro de transferencia
        const transferenciaRow = {
            caso: 'egreso',
            monto: datos.monto,
            motivo: motivo,
            fotografia: 'https://urlnodisponible.com',
            fechahora: new Date().toISOString(),
            subido_por: userEmail,
            user_id: userId
        };
        
        logProveedor('📤 Insertando en tabla transferencias:', transferenciaRow);
        
        // Insertar en tabla transferencias
        const { data: transferenciaInsertada, error: errTrans } = await client
            .from('ferre_transferencias')
            .insert([transferenciaRow])
            .select()
            .single();
        
        if (errTrans) {
            logError('Error al insertar transferencia:', errTrans);
            return;
        }
        
        logProveedor('✅ Transferencia registrada:', transferenciaInsertada);
        
        // Enviar notificación por WhatsApp
        try {
            const transferenciaConFoto = {
                ...transferenciaInsertada,
                foto_url: fotoDataUrl,
                subido_por_nombre: userName
            };
            
            logProveedor('📱 Enviando notificación WhatsApp...');
            await enviarNotificacionWhatsAppProveedor(transferenciaConFoto, client);
        } catch (notifyErr) {
            logWarning('No se pudo enviar notificación WhatsApp:', notifyErr);
        }
        
    } catch (error) {
        logError('Error al procesar transferencia:', error);
    }
}

async function enviarNotificacionWhatsAppProveedor(transferencia, client) {
    try {
        logProveedor('🔍 Obteniendo configuración de WhatsApp...');
        
        // Obtener configuración de ferredatos
        const { data: ferredatos, error } = await client
            .from('ferre_ferredatos')
            .select('*')
            .limit(1)
            .single();
        
        if (error || !ferredatos) {
            logWarning('No se encontró configuración de WhatsApp');
            return { success: false, reason: 'no_config' };
        }
        
        logProveedor('✅ Configuración obtenida:', { instance: ferredatos.instance });
        
        // Formatear fecha y hora
        const fecha = new Date(transferencia.fechahora);
        const fechaFormateada = fecha.toLocaleDateString('es-EC', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        const horaFormateada = fecha.toLocaleTimeString('es-EC', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        
        const emoji = '💸';
        const tipoMovimiento = 'EGRESO';
        const montoFormateado = parseFloat(transferencia.monto).toFixed(2);
        
        const mensaje = `${emoji} *Pago a Proveedor Registrado*\n\n*DETALLES DEL PAGO*\n\n📅 *Fecha:* ${fechaFormateada}\n🕐 *Hora:* ${horaFormateada}\n\n❌ *Tipo:* ${tipoMovimiento}\n💵 *Monto:* $${montoFormateado}\n\n📝 *Motivo:*\n${transferencia.motivo}\n\n👤 *Registrado por:*\n${transferencia.subido_por_nombre || transferencia.subido_por || 'N/A'}\n\n📸 *Comprobante adjunto*\n\n_Sistema de Gestión Ferrisoluciones_\n_Powered by Ferrisoluciones Tech_`;
        
        const url = `https://api.ferrisoluciones.com/message/sendMedia/${ferredatos.instance}`;
        
        // Extraer base64 del data URL
        let mediaToSend = transferencia.foto_url || '';
        if (mediaToSend.startsWith('data:')) {
            const commaIdx = mediaToSend.indexOf(',');
            if (commaIdx !== -1) {
                mediaToSend = mediaToSend.substring(commaIdx + 1);
            }
        }
        
        const fileName = `PAGO_PROVEEDOR_${fechaFormateada.replace(/\//g, '-')}_${horaFormateada.replace(/:/g, '-')}.png`;
        
        const payload = {
            number: ferredatos.number,
            mediatype: 'image',
            mimetype: 'image/png',
            caption: mensaje,
            media: mediaToSend,
            fileName: fileName,
            delay: 1000,
            linkPreview: false
        };
        
        logProveedor('📤 Enviando mensaje a WhatsApp API...');
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'apikey': ferredatos.apikey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            logProveedor('✅ Notificación WhatsApp enviada:', data);
            return { success: true, data };
        } else {
            logError('❌ Error en API de WhatsApp:', data);
            return { success: false, error: data };
        }
        
    } catch (error) {
        logError('Error al enviar notificación WhatsApp:', error);
        return { success: false, error: error.message };
    }
}

// =====================================================
// MODAL NOTIFICACIÓN
// =====================================================

window.mostrarModalNotificar = function() {
    // Cargar proveedores en el grid
    cargarProveedoresParaNotificar();
    
    // Reset del formulario
    document.getElementById('formNotificar').reset();
    document.getElementById('proveedorNotificarId').value = '';
    document.getElementById('proveedorNotificarNombre').value = '';
    document.getElementById('notificarDeuda').checked = true;
    document.getElementById('notificarMotivo').checked = false;
    document.getElementById('motivoContainer').classList.add('hidden');
    document.getElementById('btnEnviarNotificacion').disabled = true;
    document.getElementById('notasPendientesProveedor').classList.add('hidden');
    
    // Mostrar modal
    document.getElementById('modalNotificar').classList.add('active');
}

window.cerrarModalNotificar = function() {
    document.getElementById('modalNotificar').classList.remove('active');
}

async function cargarProveedoresParaNotificar() {
    const grid = document.getElementById('proveedoresNotificarGrid');
    
    // Usar caché si está disponible
    if (proveedoresData.proveedores && proveedoresData.proveedores.length > 0) {
        mostrarBotonesProveedoresNotificar(proveedoresData.proveedores);
    } else {
        grid.innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Cargando proveedores...</p>
            </div>
        `;
        
        // Cargar desde Supabase
        await cargarProveedoresData();
        mostrarBotonesProveedoresNotificar(proveedoresData.proveedores);
    }
}

function mostrarBotonesProveedoresNotificar(proveedores) {
    const grid = document.getElementById('proveedoresNotificarGrid');
    
    if (!proveedores || proveedores.length === 0) {
        grid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No hay proveedores registrados</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = proveedores.map(proveedor => `
        <button type="button" class="proveedor-btn" 
                data-id="${proveedor.id}" 
                data-nombre="${proveedor.empresa}"
                onclick="seleccionarProveedorNotificar(this)">
            ${proveedor.empresa}
        </button>
    `).join('');
}

window.seleccionarProveedorNotificar = function(btn) {
    const proveedorId = btn.dataset.id;
    const proveedorNombre = btn.dataset.nombre;
    
    // Desmarcar todos los botones
    document.querySelectorAll('.proveedor-btn').forEach(b => b.classList.remove('selected'));
    
    // Marcar este botón
    btn.classList.add('selected');
    
    // Guardar selección
    document.getElementById('proveedorNotificarId').value = proveedorId;
    document.getElementById('proveedorNotificarNombre').value = proveedorNombre;
    
    // Habilitar botón de envío
    document.getElementById('btnEnviarNotificacion').disabled = false;
    
    // Buscar notas pendientes de este proveedor
    mostrarNotasPendientesProveedor(proveedorId, proveedorNombre);
}

window.mostrarNotasPendientesProveedor = function(proveedorId, proveedorNombre) {
    const notasPendientes = proveedoresData.notas.filter(n => 
        n.proveedor_id === proveedorId && n.estado === 'Pendiente'
    );
    
    const container = document.getElementById('notasPendientesProveedor');
    
    if (notasPendientes.length === 0) {
        container.classList.add('hidden');
        return;
    }
    
    container.classList.remove('hidden');
    container.innerHTML = `
        <h4>
            <i class="fas fa-exclamation-circle"></i>
            Notas Pendientes para ${proveedorNombre}
        </h4>
        <div class="notas-alerta-lista">
            ${notasPendientes.map(nota => `
                <div class="nota-alerta-item">
                    <div class="nota-alerta-fecha">${formatDateTime(nota.created_at)}</div>
                    <div>${nota.nota}</div>
                </div>
            `).join('')}
        </div>
        <button type="button" class="btn btn-secondary" style="margin-top: 10px;" onclick="incluirNotasEnMotivo()">
            <i class="fas fa-plus"></i>
            Incluir notas en el motivo
        </button>
    `;
}

function incluirNotasEnMotivo() {
    const proveedorId = document.getElementById('proveedorNotificarId').value;
    const notasPendientes = proveedoresData.notas.filter(n => 
        n.proveedor_id === proveedorId && n.estado === 'Pendiente'
    );
    
    // Activar checkbox de motivo
    document.getElementById('notificarMotivo').checked = true;
    actualizarCheckboxesNotificacion();
    
    // Agregar notas al textarea
    const motivoTextarea = document.getElementById('motivoVisita');
    let notasTexto = "NOTAS PENDIENTES:\n\n";
    
    notasPendientes.forEach(nota => {
        notasTexto += `📌 [${formatDateTime(nota.created_at)}]\n${nota.nota}\n\n`;
    });
    
    motivoTextarea.value = (motivoTextarea.value ? motivoTextarea.value + "\n\n" : "") + notasTexto;
}

function actualizarCheckboxesNotificacion() {
    const checkDeuda = document.getElementById('notificarDeuda');
    const checkMotivo = document.getElementById('notificarMotivo');
    const motivoContainer = document.getElementById('motivoContainer');
    const motivoVisita = document.getElementById('motivoVisita');
    
    // Al menos uno debe estar marcado
    if (!checkDeuda.checked && !checkMotivo.checked) {
        checkDeuda.checked = true;
    }
    
    // Mostrar/ocultar campo de motivo
    if (checkMotivo.checked) {
        motivoContainer.classList.remove('hidden');
        motivoVisita.required = true;
    } else {
        motivoContainer.classList.add('hidden');
        motivoVisita.required = false;
    }
}

async function enviarNotificacionProveedor(e) {
    e.preventDefault();
    
    const proveedorId = document.getElementById('proveedorNotificarId').value;
    const proveedorNombre = document.getElementById('proveedorNotificarNombre').value;
    const notificarDeuda = document.getElementById('notificarDeuda').checked;
    const notificarMotivo = document.getElementById('notificarMotivo').checked;
    const motivoVisita = document.getElementById('motivoVisita').value.trim();
    
    if (!proveedorId) {
        mostrarNotificacionProveedor('Debe seleccionar un proveedor', 'error');
        return;
    }
    
    if (notificarMotivo && !motivoVisita) {
        mostrarNotificacionProveedor('Debe ingresar el motivo de la visita', 'error');
        return;
    }
    
    try {
        // Mostrar loader
        if (typeof showAppLoader === 'function') {
            showAppLoader();
        }
        
        // Deshabilitar botón de envío para evitar doble clic
        const btnEnviar = document.getElementById('btnEnviarNotificacion');
        const textoOriginal = btnEnviar.innerHTML;
        btnEnviar.disabled = true;
        btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        
        // Obtener facturas pendientes del proveedor
        const facturasPendientes = proveedoresData.facturas.filter(f => 
            f.proveedor_id === proveedorId && 
            (f.estado === 'Pendiente' || f.estado === 'Abonada')
        );
        
        // Calcular deuda total
        const deudaTotal = facturasPendientes.reduce((sum, f) => sum + parseFloat(f.saldo_pendiente), 0);
        
        // Construir mensaje
        let mensaje = `🔔 *NOTIFICACIÓN DE VISITA*\n\n`;
        mensaje += `Proveedor: *${proveedorNombre}*\n\n`;
        
        if (notificarDeuda && deudaTotal > 0) {
            mensaje += `💰 *Deuda Actual:* $${deudaTotal.toFixed(2)}\n`;
            mensaje += `📋 Facturas pendientes: ${facturasPendientes.length}\n\n`;
            
            if (facturasPendientes.length > 0) {
                mensaje += `*Detalle de facturas:*\n`;
                facturasPendientes.forEach(f => {
                    mensaje += `• ${f.numero_factura}: $${parseFloat(f.saldo_pendiente).toFixed(2)}`;
                    if (f.esta_vencida) {
                        mensaje += ` ⚠️ VENCIDA`;
                    }
                    mensaje += `\n`;
                });
                mensaje += `\n`;
            }
        }
        
        if (notificarMotivo && motivoVisita) {
            mensaje += `📝 *Motivo de visita:*\n${motivoVisita}\n\n`;
        }
        
        mensaje += `_Mensaje generado desde Ferrisoluciones_`;
        
        // Enviar notificación por WhatsApp
        const resultadoWhatsApp = await enviarWhatsAppProveedor(mensaje);
        
        // Restaurar botón
        btnEnviar.innerHTML = textoOriginal;
        btnEnviar.disabled = false;
        
        if (resultadoWhatsApp && resultadoWhatsApp.success) {
            cerrarModalNotificar();
            mostrarNotificacionProveedor(`Notificación enviada a ${proveedorNombre}`, 'success');
        } else {
            cerrarModalNotificar();
            mostrarNotificacionProveedor('Notificación preparada pero no se pudo enviar por WhatsApp', 'warning');
        }
        
    } catch (error) {
        console.error('Error al enviar notificación:', error);
        mostrarNotificacionProveedor('Error al preparar la notificación: ' + error.message, 'error');
        
        // Restaurar botón en caso de error
        const btnEnviar = document.getElementById('btnEnviarNotificacion');
        if (btnEnviar) {
            btnEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Notificación';
            btnEnviar.disabled = false;
        }
    } finally {
        // Ocultar loader
        if (typeof hideAppLoader === 'function') {
            hideAppLoader();
        }
    }
}

async function enviarWhatsAppProveedor(mensaje) {
    try {
        const client = getSupabaseClient();
        
        // Obtener configuración de WhatsApp desde ferredatos
        const { data: ferredatos, error } = await client
            .from('ferre_ferredatos')
            .select('*')
            .limit(1)
            .single();

        if (error || !ferredatos) {
            return null;
        }

        
        const url = `https://api.ferrisoluciones.com/message/sendText/${ferredatos.instance}`;

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'apikey': ferredatos.apikey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                number: ferredatos.number,
                text: mensaje,
                delay: 1000,
                linkPreview: false
            })
        });

        const data = await response.json();

        if (response.ok && data.key && data.key.id) {
            return {
                success: true,
                messageId: data.key.id,
                remoteJid: data.key.remoteJid
            };
        } else {
            return null;
        }

    } catch (error) {
        return null;
    }
}

// =====================================================
// MODAL NOTAS
// =====================================================

function mostrarModalNotas() {
    const pendientesList = document.getElementById('notasPendientesList');
    const resueltasList = document.getElementById('notasResueltasList');
    
    const pendientes = proveedoresData.notas.filter(n => n.estado === 'Pendiente');
    const resueltas = proveedoresData.notas.filter(n => n.estado === 'Resuelta');
    
    // Mostrar pendientes
    if (pendientes.length === 0) {
        pendientesList.innerHTML = '';
        document.getElementById('noNotasPendientes').classList.remove('hidden');
    } else {
        document.getElementById('noNotasPendientes').classList.add('hidden');
        pendientesList.innerHTML = pendientes.map(nota => crearElementoNota(nota)).join('');
    }
    
    // Mostrar resueltas
    if (resueltas.length === 0) {
        resueltasList.innerHTML = '';
        document.getElementById('noNotasResueltas').classList.remove('hidden');
    } else {
        document.getElementById('noNotasResueltas').classList.add('hidden');
        resueltasList.innerHTML = resueltas.map(nota => crearElementoNota(nota, true)).join('');
    }
    
    document.getElementById('modalNotas').classList.add('show');
}

function cerrarModalNotas() {
    document.getElementById('modalNotas').classList.remove('show');
}

function crearElementoNota(nota, resuelta = false) {
    const contenidoCorto = nota.nota.length > 150 ? nota.nota.substring(0, 150) + '...' : nota.nota;
    
    return `
        <div class="nota-item ${resuelta ? 'resuelta' : ''}">
            <div class="nota-header">
                <span class="nota-proveedor">${nota.proveedor?.empresa || 'Proveedor'}</span>
                <span class="nota-fecha">${formatDateTime(nota.created_at)}</span>
            </div>
            <div class="nota-contenido">${contenidoCorto}</div>
        </div>
    `;
}

// =====================================================
// UTILIDADES
// =====================================================

async function recargarFacturas() {
    await cargarFacturasData();
    mostrarNotificacionProveedor('Facturas actualizadas', 'success');
}

function mostrarNotificacionProveedor(mensaje, tipo = 'info') {
    // Usar el sistema de alertas personalizado si está disponible
    if (typeof proveedoresAlert === 'function') {
        proveedoresAlert(mensaje, tipo);
    } else if (window.showCustomAlert) {
        window.showCustomAlert(mensaje, tipo);
    } else if (window.showNotification) {
        window.showNotification(mensaje, tipo);
    } else {
        alert(mensaje);
    }
}

function showAppLoader() {
    // Mostrar loader global si existe
    if (window.showLoader) {
        window.showLoader();
    }
}

function hideAppLoader() {
    // Ocultar loader global si existe
    if (window.hideLoader) {
        window.hideLoader();
    }
}

// =====================================================
// FUNCIONES DE FORMATO
// =====================================================

function formatCurrency(amount) {
    if (amount === null || amount === undefined) return '$0.00';
    const num = parseFloat(amount);
    if (isNaN(num)) return '$0.00';
    return new Intl.NumberFormat('es-EC', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}/${month}/${year}`;
    } catch (e) {
        return 'N/A';
    }
}

function formatDateTime(dateTimeString) {
    if (!dateTimeString) return 'N/A';
    try {
        const date = new Date(dateTimeString);
        if (isNaN(date.getTime())) return 'N/A';
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    } catch (e) {
        return 'N/A';
    }
}

// =====================================================
// FUNCIÓN DE ACTUALIZACIÓN DEL CONTADOR DEL NAVBAR
// =====================================================

function updateNavbarCounter(module, text) {
    // Buscar el elemento del contador en el navbar
    const navbarItem = document.querySelector(`.nav-item[data-module="${module}"]`);
    if (navbarItem) {
        const counter = navbarItem.querySelector('.nav-counter');
        if (counter) {
            counter.textContent = text;
        }
    }
}

// =====================================================
// FUNCIÓN DE ALERTA PERSONALIZADA
// =====================================================

function proveedoresAlert(mensaje, tipo = 'info', titulo = '') {
    // Si existe un sistema global de alertas, usarlo
    if (window.showAlert) {
        window.showAlert(mensaje, tipo, titulo);
        return;
    }
    
    // Si no, crear una alerta simple
    const iconos = {
        'info': 'fa-info-circle',
        'success': 'fa-check-circle',
        'warning': 'fa-exclamation-triangle',
        'error': 'fa-times-circle'
    };
    
    const titulos = {
        'info': titulo || 'Información',
        'success': titulo || 'Éxito',
        'warning': titulo || 'Advertencia',
        'error': titulo || 'Error'
    };
    
    const colores = {
        'info': '#3498db',
        'success': '#2ecc71',
        'warning': '#f1c40f',
        'error': '#e74c3c'
    };
    
    // Crear modal de alerta
    const alertaHTML = `
        <div id="alertaModal" class="modal show">
            <div class="modal-overlay" onclick="cerrarAlertaModal()"></div>
            <div class="modal-content modal-alerta">
                <div class="modal-body">
                    <div class="alerta-icono ${tipo}">
                        <i class="fas ${iconos[tipo] || iconos.info}"></i>
                    </div>
                    <h3>${titulos[tipo]}</h3>
                    <p>${mensaje}</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="cerrarAlertaModal()">
                        Entendido
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Insertar en el DOM
    const alertaContainer = document.createElement('div');
    alertaContainer.innerHTML = alertaHTML;
    document.body.appendChild(alertaContainer);
}

function cerrarAlertaModal() {
    logProveedor('Cerrando modal de alerta');
    const alertaModal = document.getElementById('alertaModal');
    if (alertaModal) {
        const modalContainer = alertaModal.parentElement;
        if (modalContainer) {
            modalContainer.remove();
        }
    }
    // También intentar cerrar el modal de alertas predefinido
    const modalAlertaPredefinido = document.getElementById('modalAlertaProveedores');
    if (modalAlertaPredefinido) {
        modalAlertaPredefinido.classList.remove('show');
    }
}

// =====================================================
// MODAL FACTURA EMERGENCIA
// =====================================================

function mostrarModalFacturaEmergencia() {
    const modal = document.getElementById('modalFacturaEmergencia');
    const form = document.getElementById('formFacturaEmergencia');
    const selectProveedor = document.getElementById('emergenciaProveedor');
    
    // Resetear formulario
    form.reset();
    
    // Llenar selector de proveedores
    selectProveedor.innerHTML = '<option value="">Seleccionar proveedor...</option>';
    
    // Usar los proveedores ya cargados en memoria
    if (proveedoresData.proveedores && proveedoresData.proveedores.length > 0) {
        proveedoresData.proveedores.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.empresa;
            selectProveedor.appendChild(option);
        });
    } else {
        // Si no hay proveedores cargados, intentar cargarlos
        cargarProveedoresData().then(() => {
            proveedoresData.proveedores.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.empresa;
                selectProveedor.appendChild(option);
            });
        });
    }
    
    // Establecer fecha de hoy por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('emergenciaFechaEmision').value = today;
    document.getElementById('emergenciaFechaVencimiento').value = today;
    
    modal.classList.add('show');
}

function actualizarDeudaProveedorEmergencia() {
    const proveedorId = document.getElementById('emergenciaProveedor')?.value;
    const infoDiv = document.getElementById('emergenciaDeudaInfo');
    const montoSpan = document.getElementById('emergenciaDeudaMonto');
    
    if (!infoDiv || !montoSpan) return;
    
    if (!proveedorId) {
        infoDiv.style.display = 'none';
        return;
    }
    
    // Calcular deuda
    const facturasProveedor = proveedoresData.facturas.filter(f => f.proveedor_id === proveedorId);
    const deudaTotal = facturasProveedor.reduce((sum, f) => sum + (parseFloat(f.saldo_pendiente) || 0), 0);
    
    montoSpan.textContent = formatCurrency(deudaTotal);
    infoDiv.style.display = 'block';
    
    // Cambiar color si hay deuda
    if (deudaTotal > 0) {
        infoDiv.className = 'text-warning'; 
        infoDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Deuda actual: <span id="emergenciaDeudaMonto" style="font-weight: bold;">${formatCurrency(deudaTotal)}</span>`;
    } else {
        infoDiv.className = 'text-success';
        infoDiv.innerHTML = `<i class="fas fa-check-circle"></i> Sin deuda pendiente <span id="emergenciaDeudaMonto" style="display:none">0</span>`;
    }
}

function cerrarModalFacturaEmergencia() {
    document.getElementById('modalFacturaEmergencia').classList.remove('show');
}

async function guardarFacturaEmergencia(e) {
    e.preventDefault();
    
    const proveedorId = document.getElementById('emergenciaProveedor').value;
    const numeroFactura = document.getElementById('emergenciaNumero').value.trim();
    const fechaEmision = document.getElementById('emergenciaFechaEmision').value;
    const fechaVencimiento = document.getElementById('emergenciaFechaVencimiento').value;
    const totalFactura = parseFloat(document.getElementById('emergenciaTotal').value);
    const notas = document.getElementById('emergenciaNotas').value.trim();
    
    if (!proveedorId || !numeroFactura || !fechaEmision || !fechaVencimiento || isNaN(totalFactura)) {
        mostrarNotificacionProveedor('Por favor complete todos los campos obligatorios', 'warning');
        return;
    }
    
    if (totalFactura <= 0) {
        mostrarNotificacionProveedor('El total debe ser mayor a 0', 'warning');
        return;
    }
    
    try {
        showAppLoader();
        const client = getSupabaseClient();
        
        // Verificar duplicados
        const { data: existing } = await client
            .from('ferre_facturas_proveedores')
            .select('id')
            .eq('proveedor_id', proveedorId)
            .eq('numero_factura', numeroFactura)
            .single();
            
        if (existing) {
            hideAppLoader();
            mostrarNotificacionProveedor('Ya existe una factura con este número para este proveedor', 'error');
            return;
        }
        
        const nuevaFactura = {
            proveedor_id: proveedorId,
            numero_factura: numeroFactura,
            fecha_emision: fechaEmision,
            fecha_vencimiento: fechaVencimiento,
            total_factura: totalFactura,
            saldo_pendiente: totalFactura, // Inicialmente igual al total
            notas: notas || 'Factura de emergencia (sin detalles de productos)',
            usuario_registro: 'Sistema' // O el usuario actual si está disponible
        };
        
        const { error } = await client
            .from('ferre_facturas_proveedores')
            .insert(nuevaFactura);
            
        if (error) throw error;
        
        hideAppLoader();
        cerrarModalFacturaEmergencia();
        mostrarNotificacionProveedor('Factura guardada correctamente', 'success');
        
        // Recargar lista
        recargarFacturas();
        
    } catch (error) {
        hideAppLoader();
        console.error('Error al guardar factura de emergencia:', error);
        mostrarNotificacionProveedor('Error al guardar la factura: ' + error.message, 'error');
    }
}

// Event listener para el formulario eliminado ya que usamos onclick directo para evitar problemas con la carga dinámica


// =====================================================
// EXPONER FUNCIONES GLOBALES
// =====================================================

// Hacer accesibles las funciones principales globalmente
window.initProveedores = initProveedores;
window.abrirDetalleFactura = abrirDetalleFactura;
window.cerrarModalFactura = cerrarModalFactura;
window.cambiarTabProveedor = cambiarTabProveedor;
window.mostrarModalNotas = mostrarModalNotas;
window.cerrarModalNotas = cerrarModalNotas;
window.recargarFacturas = recargarFacturas;
window.proveedoresAlert = proveedoresAlert;
window.cerrarAlertaModal = cerrarAlertaModal;
window.mostrarModalFacturaEmergencia = mostrarModalFacturaEmergencia;
window.cerrarModalFacturaEmergencia = cerrarModalFacturaEmergencia;
window.guardarFacturaEmergencia = guardarFacturaEmergencia;
window.actualizarDeudaProveedorEmergencia = actualizarDeudaProveedorEmergencia;

logProveedor('✅ Módulo de proveedores cargado - Funciones globales exportadas');

</script>




