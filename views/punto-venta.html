<div class="container" style="height: calc(100vh - 80px); overflow: hidden; padding: 20px;">


    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 100%;">


        <div style="overflow-y: auto; padding-right: 10px; height: 100%; overflow-x: hidden; max-width: 100%;">


            <div class="card" style="min-width: 0;">
                <h3 style="margin-bottom: 15px; font-size: 1.2em;">
                    <i class="fas fa-search"></i> Buscar Producto
                </h3>

                <div class="form-group">
                    <label class="form-label">Código o Nombre</label>
                    <input type="text" id="searchInput" class="form-input"
                        placeholder="Escanea código de barras o escribe nombre..." autocomplete="off" autofocus>
                </div>


                <div id="searchResults" class="search-results">
                    <div id="loadingCache" style="display: none; text-align: center; padding: 40px; color: #d4a017;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <p style="margin: 0; font-weight: 500;">Cargando inventario...</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #999;">Esto solo ocurre una vez</p>
                    </div>
                </div>
            </div>


            <div class="card">
                <h3 style="margin-bottom: 15px; font-size: 1.2em;">
                    <i class="fas fa-user"></i> Cliente
                </h3>

                <div class="form-group">
                    <label class="form-label">Cliente</label>


                    <div id="clienteSeleccionadoBox" class="cliente-seleccionado-box consumidor-final">
                        <div class="cliente-header">
                            <div class="cliente-icon">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="cliente-datos">
                                <div class="cliente-nombre" id="clienteNombreSeleccionado">Consumidor Final</div>
                                <div class="cliente-cedula" id="clienteCedulaSeleccionado">CI/RUC: 9999999999999</div>
                            </div>
                        </div>
                        <div class="cliente-detalles" id="clienteDetallesBox" style="display: none;">
                            <div class="cliente-detalle-item">
                                <i class="fas fa-envelope"></i>
                                <span id="clienteCorreoSeleccionado">-</span>
                            </div>
                            <div class="cliente-detalle-item">
                                <i class="fas fa-phone"></i>
                                <span id="clienteTelefonoSeleccionado">-</span>
                            </div>
                        </div>
                        <div class="cliente-acciones">
                            <button class="btn-cliente-accion btn-editar" id="btnEditarCliente"
                                onclick="editarCliente()" title="Editar información del cliente" style="display: none;">
                                <i class="fas fa-pencil-alt"></i>
                                <span>Editar</span>
                            </button>
                            <button class="btn-cliente-accion btn-cambiar" onclick="cambiarCliente()"
                                title="Cambiar cliente">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Cambiar</span>
                            </button>
                            <button class="btn-cliente-accion btn-borrar" id="btnQuitarCliente"
                                onclick="borrarCliente()" title="Quitar cliente" style="display: none;">
                                <i class="fas fa-times"></i>
                                <span>Quitar</span>
                            </button>
                        </div>
                    </div>


                    <div id="clienteBusquedaBox" style="display: none;">
                        <input type="text" id="clienteCedula" class="form-input"
                            placeholder="Buscar por cédula o nombre..." maxlength="50" autocomplete="off">


                        <div id="clienteSearchResults" class="search-results"
                            style="max-height: 250px; overflow-y: auto;"></div>

                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="cancelarBusqueda()" style="width: 100%;">
                                <i class="fas fa-times"></i>
                                <span>Cancelar</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>


        <div style="overflow-y: auto; padding-right: 10px; height: 100%;" id="carritoColumn">

            <div class="card" id="carritoCard" style="position: relative;">

                <div class="edit-mode-badge" id="editModeBadge">
                    <div class="edit-mode-indicator"></div>
                    <span>EDITANDO</span>
                </div>


                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.2em;">
                        <i class="fas fa-shopping-cart"></i> Carrito de Compra
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div class="items-counter" id="itemsCounter">
                            <i class="fas fa-box"></i>
                            <span id="itemsCount">0</span>
                            <span class="items-label">items</span>
                        </div>
                        <button class="ganancia-toggle-btn" id="gananciaToggleBtn" onclick="toggleGananciaPanel()"
                            title="Mostrar ganancia total">
                            <i class="fas fa-dollar-sign"></i>
                            <span>G</span>
                        </button>
                        <div class="ganancia-total-inline" id="gananciaTotalInline">
                            <span class="ganancia-total-label">Ganancia:</span>
                            <span id="gananciaTotalValue" class="ganancia-total-value">$0.00</span>
                        </div>
                    </div>
                </div>


                <div class="table-container">
                    <table class="table" id="carritoTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th style="width: 80px;">Cant.</th>
                                <th style="width: 100px;">Precio</th>
                                <th style="width: 100px;">Subtotal</th>
                                <th style="width: 90px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="carritoBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #999; padding: 40px;">
                                    Carrito vacío. Escanea productos para comenzar.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>

        </div>

    </div>

</div>



<div id="modalVenta" class="modal-venta-overlay">
    <div class="modal-venta-container">
        <div class="modal-venta-header">
            <h2><i class="fas fa-cash-register"></i> Procesar Venta</h2>
            <button class="modal-venta-close" onclick="cerrarModalVenta()">&times;</button>
        </div>
        <div class="modal-venta-content">

            <div class="modal-venta-left">

                <div class="venta-section">
                    <h3><i class="fas fa-user"></i> Cliente</h3>
                    <div class="cliente-info-card" id="modalClienteInfo">

                    </div>
                </div>


                <div class="venta-section">
                    <h3><i class="fas fa-file-invoice"></i> Tipo de Comprobante</h3>
                    <div class="tipo-comprobante-selector">
                        <button class="btn-tipo-comprobante active" data-tipo="RECIBO"
                            onclick="seleccionarTipoComprobante('RECIBO')">
                            <i class="fas fa-receipt"></i>
                            <span>Recibo</span>
                        </button>
                        <button class="btn-tipo-comprobante" data-tipo="FACTURA"
                            onclick="seleccionarTipoComprobante('FACTURA')">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Factura</span>
                        </button>
                    </div>
                </div>
            </div>


            <div class="modal-venta-right">

                <div class="venta-section">
                    <div class="total-grande">
                        <span>TOTAL:</span>
                        <strong id="modalTotal">$0.00</strong>
                    </div>
                </div>


                <div class="venta-section">
                    <h3><i class="fas fa-money-bill-wave"></i> Pago</h3>

                    <!-- Selector de Tipo de Pago -->
                    <div class="payment-options"
                        style="grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;">
                        <label class="payment-option">
                            <input type="radio" name="tipoPagoVenta" value="EFECTIVO" checked
                                onchange="cambiarTipoPagoVenta()">
                            <span class="payment-card" style="padding: 10px;">
                                <i class="fas fa-money-bill-alt"></i>
                                <span style="font-size: 0.9em;">Efectivo</span>
                            </span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="tipoPagoVenta" value="TRANSFERENCIA"
                                onchange="cambiarTipoPagoVenta()">
                            <span class="payment-card" style="padding: 10px;">
                                <i class="fas fa-university"></i>
                                <span style="font-size: 0.9em;">Transf.</span>
                            </span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="tipoPagoVenta" value="MIXTO" onchange="cambiarTipoPagoVenta()">
                            <span class="payment-card" style="padding: 10px;">
                                <i class="fas fa-wallet"></i>
                                <span style="font-size: 0.9em;">Mixto</span>
                            </span>
                        </label>
                    </div>

                    <div class="pago-group" id="pagoGroupEfectivo">
                        <label id="labelPagadoCon">Pagado con:</label>
                        <input type="number" id="pagadoCon" class="input-pago" placeholder="0.00" step="0.01" min="0"
                            oninput="calcularVuelto()">
                    </div>

                    <div id="infoTransferencia"
                        style="display: none; margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; color: #0d47a1; font-weight: bold; text-align: right;">
                        <span style="display: block; font-size: 0.8em; opacity: 0.8;">Monto a Transferir</span>
                        <span id="montoTransferenciaDisplay" style="font-size: 1.2em;">$0.00</span>
                    </div>

                    <div class="vuelto-display" id="vueltoSection">
                        <span>Vuelto:</span>
                        <strong id="vueltoDisplay">$0.00</strong>
                    </div>
                </div>


                <div class="modal-venta-actions">
                    <button class="btn-modal-cancelar" onclick="cerrarModalVenta()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn-modal-confirmar" id="btnConfirmarVenta" onclick="procesarVentaConValidacion()">
                        <i class="fas fa-check"></i> Confirmar Venta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="modalCajaInicial" class="modal-caja-overlay">
    <div class="modal-caja-container" style="max-width: 700px;">
        <div class="modal-caja-header">
            <h2><i class="fas fa-door-open"></i> Registro de Caja Inicial</h2>
        </div>
        <div class="modal-caja-body">
            <p class="modal-caja-description">
                Ingresa el efectivo encontrado en la caja física antes de iniciar las ventas del día.
                Este paso es obligatorio para habilitar el punto de venta.
            </p>
            <div class="modal-caja-form">
                <div id="cajaInicialEsperadoWrapper" class="modal-caja-expected" style="display: none;">
                    <div class="modal-caja-expected-text">
                        <span id="cajaInicialEsperadoLabel">Valor esperado (caja anterior)</span>
                        <small id="cajaInicialEsperadoFecha"></small>
                    </div>
                    <strong id="cajaInicialEsperadoValor">$0.00</strong>
                </div>

                <!-- Tabla de Denominaciones -->
                <div class="denominaciones-section">
                    <h3 class="denominaciones-titulo">
                        <i class="fas fa-money-bill-wave"></i> Conteo de Denominaciones
                        <small style="margin-left: auto; font-size: 0.7em; color: #64748b;">(Esperado vs Contado)</small>
                    </h3>
                    
                    <div class="denominaciones-grid">
                        <!-- Billetes -->
                        <div class="denominacion-grupo">
                            <h4><i class="fas fa-money-bill"></i> Billetes</h4>
                            <div class="denominacion-header" style="display: grid; grid-template-columns: 60px 50px 1fr 80px; gap: 8px; margin-bottom: 8px; font-size: 0.75em; font-weight: 700; color: #64748b; text-transform: uppercase; padding: 0 4px;">
                                <span>Denom.</span>
                                <span style="text-align: center;">Esp.</span>
                                <span style="text-align: center;">Contado</span>
                                <span style="text-align: right;">Subtotal</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$100</label>
                                <span class="denom-esperado" id="esp_billet_100">0</span>
                                <input type="number" id="billet_100" class="denom-input" min="0" step="1" placeholder="0" data-valor="100">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$50</label>
                                <span class="denom-esperado" id="esp_billet_50">0</span>
                                <input type="number" id="billet_50" class="denom-input" min="0" step="1" placeholder="0" data-valor="50">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$20</label>
                                <span class="denom-esperado" id="esp_billet_20">0</span>
                                <input type="number" id="billet_20" class="denom-input" min="0" step="1" placeholder="0" data-valor="20">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$10</label>
                                <span class="denom-esperado" id="esp_billet_10">0</span>
                                <input type="number" id="billet_10" class="denom-input" min="0" step="1" placeholder="0" data-valor="10">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$5</label>
                                <span class="denom-esperado" id="esp_billet_5">0</span>
                                <input type="number" id="billet_5" class="denom-input" min="0" step="1" placeholder="0" data-valor="5">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$2</label>
                                <span class="denom-esperado" id="esp_billet_2">0</span>
                                <input type="number" id="billet_2" class="denom-input" min="0" step="1" placeholder="0" data-valor="2">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$1</label>
                                <span class="denom-esperado" id="esp_billet_1">0</span>
                                <input type="number" id="billet_1" class="denom-input" min="0" step="1" placeholder="0" data-valor="1">
                                <span class="denom-total">$0.00</span>
                            </div>
                        </div>

                        <!-- Monedas -->
                        <div class="denominacion-grupo">
                            <h4><i class="fas fa-coins"></i> Monedas</h4>
                            <div class="denominacion-header" style="display: grid; grid-template-columns: 60px 50px 1fr 80px; gap: 8px; margin-bottom: 8px; font-size: 0.75em; font-weight: 700; color: #64748b; text-transform: uppercase; padding: 0 4px;">
                                <span>Denom.</span>
                                <span style="text-align: center;">Esp.</span>
                                <span style="text-align: center;">Contado</span>
                                <span style="text-align: right;">Subtotal</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$1.00</label>
                                <span class="denom-esperado" id="esp_moneda_1">0</span>
                                <input type="number" id="moneda_1" class="denom-input" min="0" step="1" placeholder="0" data-valor="1">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$0.50</label>
                                <span class="denom-esperado" id="esp_moneda_050">0</span>
                                <input type="number" id="moneda_050" class="denom-input" min="0" step="1" placeholder="0" data-valor="0.50">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$0.25</label>
                                <span class="denom-esperado" id="esp_moneda_025">0</span>
                                <input type="number" id="moneda_025" class="denom-input" min="0" step="1" placeholder="0" data-valor="0.25">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$0.10</label>
                                <span class="denom-esperado" id="esp_moneda_010">0</span>
                                <input type="number" id="moneda_010" class="denom-input" min="0" step="1" placeholder="0" data-valor="0.10">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$0.05</label>
                                <span class="denom-esperado" id="esp_moneda_005">0</span>
                                <input type="number" id="moneda_005" class="denom-input" min="0" step="1" placeholder="0" data-valor="0.05">
                                <span class="denom-total">$0.00</span>
                            </div>
                            <div class="denominacion-item">
                                <label>$0.01</label>
                                <span class="denom-esperado" id="esp_moneda_001">0</span>
                                <input type="number" id="moneda_001" class="denom-input" min="0" step="1" placeholder="0" data-valor="0.01">
                                <span class="denom-total">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Total Calculado -->
                    <div class="total-contado" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span>Total Contado:</span>
                            <strong id="totalDenominaciones">$0.00</strong>
                        </div>
                        <div id="cajaInicialDesfaseWrapper" style="display: none; padding: 4px 10px; border-radius: 6px; font-size: 0.9em; font-weight: 700;">
                            <span>Diferencia:</span>
                            <span id="cajaInicialDesfase">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-caja-form">
                <label for="cajaInicialNotasInput">Observaciones (opcional)</label>
                <textarea id="cajaInicialNotasInput" rows="2"
                    placeholder="Ej. Base entregada por turno anterior"></textarea>
            </div>
            <div id="modalCajaInicialError" class="modal-caja-error" style="display: none;"></div>
            <div id="modalCajaInicialInfo" class="modal-caja-info" style="display: none;"></div>
        </div>
        <div class="modal-caja-footer">
            <button id="btnGuardarCajaInicial" class="btn-guardar-caja">
                <i class="fas fa-save"></i> Guardar caja inicial
            </button>
        </div>
    </div>
</div>

<!-- Modal de Cierre de Caja Diaria -->
<div id="modalCajaDiaria" class="modal-caja-overlay">
    <div class="modal-caja-container" style="max-width: 900px;">
        <div class="modal-caja-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <h2><i class="fas fa-cash-register"></i> Cierre de Caja Diaria</h2>
            <button class="modal-close-simple" onclick="ocultarModalCajaDiaria()">&times;</button>
        </div>
        <div class="modal-caja-body">
            <div class="cierre-layout">
                <!-- Columna Izquierda: Denominaciones -->
                <div class="cierre-col">
                    <div class="denominaciones-section">
                        <h3 class="denominaciones-titulo"><i class="fas fa-money-bill-wave"></i> Conteo Físico</h3>
                        <div class="denominaciones-grid">
                            <div class="denominacion-grupo">
                                <h4>Billetes</h4>
                                <div class="denominacion-item"><label>$100 x</label><input type="number" id="cierre_billet_100" class="cierre-denom-input" min="0" placeholder="0" data-valor="100"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$50 x</label><input type="number" id="cierre_billet_50" class="cierre-denom-input" min="0" placeholder="0" data-valor="50"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$20 x</label><input type="number" id="cierre_billet_20" class="cierre-denom-input" min="0" placeholder="0" data-valor="20"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$10 x</label><input type="number" id="cierre_billet_10" class="cierre-denom-input" min="0" placeholder="0" data-valor="10"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$5 x</label><input type="number" id="cierre_billet_5" class="cierre-denom-input" min="0" placeholder="0" data-valor="5"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$2 x</label><input type="number" id="cierre_billet_2" class="cierre-denom-input" min="0" placeholder="0" data-valor="2"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$1 x</label><input type="number" id="cierre_billet_1" class="cierre-denom-input" min="0" placeholder="0" data-valor="1"><span class="cierre-denom-total">$0.00</span></div>
                            </div>
                            <div class="denominacion-grupo">
                                <h4>Monedas</h4>
                                <div class="denominacion-item"><label>$1.00 x</label><input type="number" id="cierre_moneda_1" class="cierre-denom-input" min="0" placeholder="0" data-valor="1"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$0.50 x</label><input type="number" id="cierre_moneda_050" class="cierre-denom-input" min="0" placeholder="0" data-valor="0.50"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$0.25 x</label><input type="number" id="cierre_moneda_025" class="cierre-denom-input" min="0" placeholder="0" data-valor="0.25"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$0.10 x</label><input type="number" id="cierre_moneda_010" class="cierre-denom-input" min="0" placeholder="0" data-valor="0.10"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$0.05 x</label><input type="number" id="cierre_moneda_005" class="cierre-denom-input" min="0" placeholder="0" data-valor="0.05"><span class="cierre-denom-total">$0.00</span></div>
                                <div class="denominacion-item"><label>$0.01 x</label><input type="number" id="cierre_moneda_001" class="cierre-denom-input" min="0" placeholder="0" data-valor="0.01"><span class="cierre-denom-total">$0.00</span></div>
                            </div>
                        </div>
                        <div class="total-contado" style="background: #fffbeb; border-color: #f59e0b;">
                            <span style="color: #92400e;">Total Contado:</span>
                            <strong id="cierreTotalDenominaciones" style="color: #78350f;">$0.00</strong>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Comparación y Resumen -->
                <div class="cierre-col">
                    <div class="resumen-cierre-card">
                        <h3><i class="fas fa-balance-scale"></i> Cuadre de Caja</h3>
                        <div class="cuadre-item">
                            <span>Ventas en Efectivo:</span>
                            <strong id="cierreVentasEfectivo">$0.00</strong>
                        </div>
                        <div class="cuadre-item">
                            <span>Ingresos/Egresos:</span>
                            <strong id="cierreMovimientosExtras">$0.00</strong>
                        </div>
                        <div class="cuadre-item separator">
                            <span>Caja Inicial:</span>
                            <strong id="cierreMontoInicial">$0.00</strong>
                        </div>
                        <div class="cuadre-item total-esperado">
                            <span>Total Esperado:</span>
                            <strong id="cierreTotalEsperado">$0.00</strong>
                        </div>
                        <div class="cuadre-item total-contado-resumen">
                            <span>Total Contado (Físico):</span>
                            <strong id="cierreTotalContadoResumen">$0.00</strong>
                        </div>
                        <div id="desfaseWrapper" class="cuadre-item desfase-box">
                            <span>Diferencia (Desfase):</span>
                            <strong id="cierreDesfase">$0.00</strong>
                        </div>
                    </div>

                    <div class="modal-caja-form" style="margin-top: 15px;">
                        <label for="cierreNotas">Observaciones de cierre</label>
                        <textarea id="cierreNotas" rows="2" placeholder="Ej. El desfase se debe a..."></textarea>
                    </div>
                </div>
            </div>
            <div id="modalCajaDiariaError" class="modal-caja-error" style="display: none;"></div>
        </div>
        <div class="modal-caja-footer">
            <button class="btn-cancelar-caja" onclick="ocultarModalCajaDiaria()">Cancelar</button>
            <button id="btnGuardarCierreCaja" class="btn-guardar-caja" style="background: #d97706;">
                <i class="fas fa-lock"></i> Cerrar Caja y Finalizar Día
            </button>
        </div>
    </div>
</div>


<div id="modalCreditoVenta" class="modal-venta-overlay">
    <div class="modal-venta-container credit-modal">
        <div class="modal-venta-header">
            <h2><i class="fas fa-wallet"></i> Registrar crédito</h2>
            <button class="modal-venta-close" onclick="cerrarModalCreditoVenta()">&times;</button>
        </div>
        <div class="modal-venta-content credit-layout">
            <div class="modal-venta-col credit-col">
                <div class="venta-section">
                    <h3><i class="fas fa-user-check"></i> Cliente</h3>
                    <div class="cliente-info-card" id="modalCreditoCliente"></div>
                </div>
                <div class="venta-section">
                    <h3><i class="fas fa-calculator"></i> Resumen del crédito</h3>
                    <div class="info-box resumen-credito-box">
                        <div class="info-item">
                            <span class="info-label">Total de la venta</span>
                            <span class="info-value" id="creditoTotalResumen">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Abono inicial</span>
                            <span class="info-value" id="creditoAbonoResumen">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Saldo a financiar</span>
                            <span class="info-value" id="creditoSaldoResumen">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="venta-section" id="modalCreditoAvisoWrapper" style="display: none;">
                    <div class="modal-warning" id="modalCreditoAviso">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p id="modalCreditoAvisoTexto"></p>
                    </div>
                </div>
            </div>
            <div class="modal-venta-col credit-col">
                <div class="venta-section">
                    <div class="total-grande">
                        <span>Total de la venta</span>
                        <strong id="creditoTotalDisplay">$0.00</strong>
                    </div>
                </div>
                <div class="venta-section">
                    <label for="creditoAbonoInput" style="font-weight: 600; display: block; margin-bottom: 6px;">Abono
                        inicial</label>
                    <input type="number" id="creditoAbonoInput" class="input-pago" min="0" step="0.01"
                        placeholder="0.00">
                    <small class="form-hint" style="margin-top: 6px; display: block;">Si el cliente paga algo ahora
                        regístralo aquí, se guardará como pago inmediato.</small>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 8px;">
                        <span style="font-weight: 600; color: var(--text-secondary);">Saldo por cobrar</span>
                        <strong id="creditoSaldoDisplay">$0.00</strong>
                    </div>
                    <div id="creditoAbonoWarning"
                        style="display: none; margin-top: 10px; font-size: 0.9em; color: var(--color-danger);"></div>
                </div>
            </div>
            <div class="modal-venta-col credit-col">
                <div class="venta-section">
                    <label for="creditoVencimientoInput"
                        style="font-weight: 600; display: block; margin-bottom: 6px;">Fecha de vencimiento</label>
                    <input type="date" id="creditoVencimientoInput" class="input-pago">
                </div>
                <div class="venta-section">
                    <label for="creditoMotivoInput"
                        style="font-weight: 600; display: block; margin-bottom: 6px;">Motivo</label>
                    <input type="text" id="creditoMotivoInput" class="input-pago" placeholder="Ej: Venta de materiales">
                </div>
                <div class="venta-section">
                    <label for="creditoMetodoSelect"
                        style="font-weight: 600; display: block; margin-bottom: 6px;">Método del abono</label>
                    <select id="creditoMetodoSelect" class="input-pago">
                        <option value="EFECTIVO">Efectivo</option>
                        <option value="TRANSFERENCIA">Transferencia</option>
                        <option value="CHEQUE">Cheque</option>
                        <option value="TARJETA">Tarjeta</option>
                        <option value="DEPOSITO">Depósito</option>
                        <option value="OTRO">Otro</option>
                    </select>
                </div>
                <div class="venta-section">
                    <label for="creditoNotasInput" style="font-weight: 600; display: block; margin-bottom: 6px;">Notas
                        internas</label>
                    <textarea id="creditoNotasInput" class="input-pago" rows="3"
                        placeholder="Observaciones para el equipo (opcional)"></textarea>
                </div>
                <div class="modal-venta-actions credit-actions">
                    <button class="btn-modal-cancelar" onclick="cerrarModalCreditoVenta()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn-modal-confirmar" id="btnConfirmarCreditoVenta" onclick="confirmarCreditoVenta()">
                        <i class="fas fa-hand-holding-usd"></i> Guardar crédito
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="custom-confirm-overlay" id="customConfirmOverlay">
    <div class="custom-confirm-box">
        <div class="custom-confirm-title" id="customConfirmTitle">
            <i class="fas fa-question-circle"></i>
            <span>Confirmación</span>
        </div>
        <div class="custom-confirm-message" id="customConfirmMessage">
            ¿Estás seguro?
        </div>
        <div class="custom-confirm-buttons" id="customConfirmButtons">
            <button class="custom-confirm-btn custom-confirm-btn-cancel" id="customConfirmCancel">
                Cancelar
            </button>
            <button class="custom-confirm-btn custom-confirm-btn-confirm" id="customConfirmOk">
                Confirmar
            </button>
        </div>
    </div>
</div>


<div class="modal-cantidad-overlay" id="modalExitoVenta">
    <div class="modal-cantidad-box" style="max-width: 500px;">
        <div class="modal-cantidad-header"
            style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;">
            <h3 style="display: flex; align-items: center; gap: 10px; margin: 0;">
                <i class="fas fa-check-circle" style="font-size: 1.5em;"></i>
                <span>¡Venta Registrada!</span>
            </h3>
        </div>
        <div class="modal-cantidad-body" style="text-align: center; padding: 30px 20px;">
            <div style="font-size: 3em; color: #4CAF50; margin-bottom: 15px;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 style="margin: 0 0 10px 0; color: #333; font-size: 1.3em;">Venta Exitosa</h3>
            <p style="color: #666; font-size: 1.1em; margin: 0 0 10px 0;">
                Código de venta: <strong id="modalExitoCodigoVenta" style="color: #4CAF50;">-</strong>
            </p>
            <p id="modalExitoTipoDoc" style="color: #888; font-size: 0.9em; margin: 0 0 20px 0;"></p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button id="btnReimprimirComprobante" class="btn btn-secondary" onclick="reimprimirUltimoComprobante()"
                    style="padding: 12px 20px;">
                    <i class="fas fa-print"></i> Reimprimir Comprobante
                </button>
                <button id="btnAceptarVenta" class="btn btn-primary" onclick="cerrarModalExitoVenta()"
                    style="padding: 12px 30px;">
                    <i class="fas fa-check"></i> Aceptar
                </button>
            </div>
            <p style="color: #999; font-size: 0.85em; margin: 15px 0 0 0;">
                <i class="fas fa-keyboard"></i> Presione <strong>Enter</strong> para aceptar
            </p>
        </div>
    </div>
</div>


<div class="modal-cantidad-overlay" id="modalCantidadOverlay">
    <div class="modal-cantidad-box">
        <div class="modal-cantidad-header">
            <h3 id="modalCantidadProducto">Producto</h3>
            <button class="modal-cantidad-close" onclick="cerrarModalCantidad()">&times;</button>
        </div>
        <div class="modal-cantidad-body">
            <div class="stock-disponible">
                <i class="fas fa-box"></i>
                <span>Stock disponible:</span>
                <strong id="modalCantidadStock">0</strong>
            </div>
            <div class="cantidad-input-group">
                <label for="modalCantidadInput">Cantidad a agregar:</label>
                <input type="number" id="modalCantidadInput" class="modal-cantidad-input" placeholder="0.00"
                    step="0.001" min="0.001" autofocus>
            </div>
        </div>
        <div class="modal-cantidad-footer">
            <button class="btn btn-secondary" onclick="cerrarModalCantidad()">Cancelar</button>
            <button class="btn btn-accent" onclick="confirmarCantidadRapida()">
                <i class="fas fa-plus"></i>
                <span>Agregar al Carrito</span>
            </button>
        </div>
    </div>
</div>


<div class="modal-cantidad-overlay" id="modalIngresoDirecto">
    <div class="modal-cantidad-box">
        <div class="modal-cantidad-header">
            <h3 id="modalIngresoDirectoTitulo"><i class="fas fa-barcode"></i> Escanee el Producto</h3>
            <button class="modal-cantidad-close" onclick="cerrarModalIngresoDirecto()">&times;</button>
        </div>
        <div class="modal-cantidad-body">
            <div class="cantidad-input-group">
                <label for="modalIngresoCodigoInput">Código del Producto:</label>
                <input type="text" id="modalIngresoCodigoInput" class="modal-cantidad-input"
                    placeholder="Escanee o escriba el código" autofocus>
            </div>
            <div id="modalIngresoCantidadDisplay"
                style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: center; font-size: 1.2em; font-weight: bold; color: #1976d2;">
                Cantidad a agregar: <span id="modalIngresoCantidadTexto">1</span> unidad(es)
            </div>
            <div id="modalIngresoMensaje" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;">
            </div>
        </div>
        <div class="modal-cantidad-footer">
            <button class="btn btn-secondary" onclick="cerrarModalIngresoDirecto()">Cancelar</button>
            <button class="btn btn-accent" onclick="confirmarIngresoDirecto()">
                <i class="fas fa-plus"></i>
                <span>Agregar al Carrito</span>
            </button>
        </div>
    </div>
</div>


<div class="modal-cantidad-overlay" id="modalSeleccionProducto">
    <div class="modal-cantidad-box" style="max-width: 650px;">
        <div class="modal-cantidad-header">
            <h3><i class="fas fa-box-open"></i> Seleccione Tipo y Cantidad</h3>
            <button class="modal-cantidad-close" onclick="cerrarModalSeleccionProducto()">&times;</button>
        </div>
        <div class="modal-cantidad-body">
            <p style="margin-bottom: 20px; color: #666; text-align: center; font-weight: 500;">Ingrese la cantidad del
                tipo que desea agregar:</p>
            <div id="opcionesProductos" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Opciones se llenarán dinámicamente -->
            </div>
            <p style="margin-top: 15px; color: #999; text-align: center; font-size: 0.9em;">
                <i class="fas fa-info-circle"></i> Presione Enter en el campo con cantidad para agregar
            </p>
        </div>
        <div class="modal-cantidad-footer">
            <button class="btn btn-secondary" onclick="cerrarModalSeleccionProducto()">Cancelar</button>
        </div>
    </div>
</div>


<div class="modal" id="modalGarantia">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-shield-alt"></i> Generar Garantía</h3>
            <button class="modal-close" onclick="cerrarModalGarantia()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="detail-item">
                <label>Producto</label>
                <span id="garantiaProductoNombre">-</span>
            </div>
            <div class="detail-item">
                <label>Código</label>
                <span id="garantiaProductoCodigo">-</span>
            </div>
            <div class="detail-item" style="margin-top: 20px;">
                <label for="garantiaPeriodo">Años de Garantía</label>
                <input type="number" id="garantiaPeriodo" class="form-input" value="1" min="1" max="10"
                    style="max-width: 150px;">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="cerrarModalGarantia()">
                <i class="fas fa-times"></i>
                <span>Cancelar</span>
            </button>
            <button class="btn btn-accent" onclick="generarGarantia()">
                <i class="fas fa-print"></i>
                <span>Generar Garantía</span>
            </button>
        </div>
    </div>
</div>


<div class="modal-overlay" id="modalActualizarCliente">
    <div class="modal-box" style="max-width: 500px;">
        <div class="modal-header">
            <h3><i class="fas fa-user-edit"></i> Actualizar Datos del Cliente</h3>
            <button class="modal-close" onclick="cerrarModalActualizarCliente()">&times;</button>
        </div>
        <div class="modal-body">
            <p
                style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                <i class="fas fa-info-circle"></i> Este cliente tiene un correo genérico. Por favor actualiza sus datos.
            </p>

            <div class="form-group">
                <label class="form-label">Razón Social / Nombre *</label>
                <input type="text" id="updateClienteNombre" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label">Cédula / RUC</label>
                <input type="text" id="updateClienteCedula" class="form-input" readonly style="background: #f8f9fa;">
            </div>

            <div class="form-group">
                <label class="form-label">Dirección</label>
                <input type="text" id="updateClienteDireccion" class="form-input" placeholder="Opcional">
            </div>

            <div class="form-group">
                <label class="form-label">Teléfono</label>
                <input type="tel" id="updateClienteTelefono" class="form-input" placeholder="Opcional">
            </div>

            <div class="form-group">
                <label class="form-label">Correo Electrónico *</label>
                <div class="email-validation-container">
                    <input type="email" id="updateClienteCorreo" class="form-input" required
                        placeholder="ejemplo@correo.com">
                    <span class="email-validation-icon"><i class="fas fa-check-circle"></i></span>
                </div>
                <div class="email-error-message" id="updateClienteCorreoError"></div>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Debe ser un correo válido (no puede terminar en @cambiar.com)
                </small>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" id="btnNoCorreoUpdate" class="btn-no-correo"
                        onclick="establecerCorreoGenericoUpdate()" style="display: none;">
                        <i class="fas fa-envelope"></i> No tiene correo
                    </button>
                    <button type="button" id="btnComprobarCorreoUpdate" class="btn-comprobar-correo"
                        onclick="imprimirComprobacionCorreoUpdate()" style="display: none;">
                        <i class="fas fa-print"></i> Comprobación de correo
                    </button>
                </div>
            </div>

            <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                * Campos obligatorios
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="cerrarModalActualizarCliente()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn btn-accent" onclick="confirmarActualizacionCliente()">
                <i class="fas fa-save"></i> Guardar y Continuar
            </button>
        </div>
    </div>
</div>


<div class="modal-overlay" id="loadingConsultaAPI" style="display: none;">
    <div
        style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-width: 400px; margin: auto;">
        <div class="spinner-border" style="width: 4rem; height: 4rem; color: #d4a017; margin-bottom: 20px;"
            role="status">
            <div
                style="width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid #d4a017; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;">
            </div>
        </div>
        <h3 style="color: #333; margin-bottom: 10px; font-size: 1.3em;">
            <i class="fas fa-search"></i> Consultando Identificación
        </h3>
        <p style="color: #666; margin: 0; font-size: 1em;">
            Obteniendo datos desde webservices.ec...
        </p>
        <p style="color: #999; margin-top: 10px; font-size: 0.9em;">
            Por favor espere un momento
        </p>
    </div>
</div>

<div class="modal-overlay" id="modalRegistroCliente">
    <div class="modal-box" style="max-width: 550px;">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Registrar Nuevo Cliente</h3>
            <button class="modal-close" onclick="cerrarModalRegistroCliente()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modalRegistroMensaje"
                style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                <i class="fas fa-info-circle"></i> Complete los datos del cliente para registrarlo en el sistema.
            </p>

            <div class="form-group">
                <label class="form-label">Cédula / RUC *</label>
                <input type="text" id="nuevoClienteCedula" class="form-input" readonly style="background: #f8f9fa;">
            </div>

            <div class="form-group">
                <label class="form-label">Razón Social / Nombre *</label>
                <input type="text" id="nuevoClienteNombre" class="form-input" required
                    style="text-transform: uppercase;">
            </div>

            <div class="form-group">
                <label class="form-label">Dirección *</label>
                <input type="text" id="nuevoClienteDireccion" class="form-input" required
                    placeholder="Ingrese dirección completa" style="text-transform: uppercase;">
            </div>

            <div class="form-group">
                <label class="form-label">Teléfono</label>
                <input type="tel" id="nuevoClienteTelefono" class="form-input" placeholder="Opcional">
            </div>

            <div class="form-group">
                <label class="form-label">Correo Electrónico *</label>
                <div class="email-validation-container">
                    <input type="email" id="nuevoClienteCorreo" class="form-input" required
                        placeholder="ejemplo@correo.com">
                    <span class="email-validation-icon"><i class="fas fa-check-circle"></i></span>
                </div>
                <div class="email-error-message" id="nuevoClienteCorreoError"></div>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Debe ser un correo válido y real
                </small>

                <!-- Botones de acción para correo -->
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button type="button" id="btnNoTieneCorreo" class="btn-no-correo"
                        onclick="establecerCorreoGenerico()" style="display: flex;">
                        <i class="fas fa-user-slash"></i>
                        <span>No tiene correo</span>
                    </button>
                    <button type="button" id="btnComprobarCorreo" class="btn-comprobar-correo"
                        onclick="imprimirComprobacionCorreo()" style="display: none;">
                        <i class="fas fa-print"></i>
                        <span>Comprobación de correo</span>
                    </button>
                </div>
            </div>

            <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                * Campos obligatorios
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="cerrarModalRegistroCliente()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn btn-accent" onclick="confirmarRegistroCliente()">
                <i class="fas fa-save"></i> Guardar Cliente
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Botones de acción para correo */
    .btn-no-correo,
    .btn-comprobar-correo {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
    }

    .btn-no-correo {
        background: #ff9800;
        color: white;
    }

    .btn-no-correo:hover {
        background: #f57c00;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
    }

    .btn-comprobar-correo {
        background: #4caf50;
        color: white;
    }

    .btn-comprobar-correo:hover {
        background: #388e3c;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }

    /* Estilos para validación de correo */
    .email-validation-container {
        position: relative;
    }

    .email-validation-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2em;
        pointer-events: none;
        display: none;
    }

    .form-input.email-valid {
        border: 2px solid #4caf50 !important;
        background-color: #f1f8f4 !important;
        padding-right: 40px;
    }

    .form-input.email-invalid {
        border: 2px solid #f44336 !important;
        background-color: #ffebee !important;
        padding-right: 40px;
    }

    .form-input.email-error {
        border: 2px solid #00bcd4 !important;
        background-color: #e0f7fa !important;
        padding-right: 40px;
    }

    .email-valid+.email-validation-icon {
        display: block;
        color: #4caf50;
    }

    .email-invalid+.email-validation-icon {
        display: block;
        color: #f44336;
    }

    .email-error+.email-validation-icon {
        display: block;
        color: #00bcd4;
    }

    .email-error-message {
        display: none;
        color: #f44336;
        font-size: 0.85em;
        margin-top: 5px;
        padding: 8px;
        background-color: #ffebee;
        border-left: 3px solid #f44336;
        border-radius: 4px;
    }

    .email-error-message.show {
        display: block;
    }

    .email-validating {
        pointer-events: none;
        opacity: 0.6;
    }

    .search-results {
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-width: thin;
        width: 100%;
        min-width: 100%;
        max-width: 100%;
    }

    .search-result-item {
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }

    .search-result-item:hover {
        background: #f8f9fa;
        border-color: #d4a017;
        transform: translateX(5px);
    }

    .search-result-item strong {
        color: #1a1a1a;
        display: block;
        margin-bottom: 4px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .search-result-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 8px;
    }

    .search-result-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
    }

    .search-result-item small {
        color: #666;
    }

    .search-result-item .precio {
        color: #28a745;
        font-weight: 700;
        font-size: 1.1em;
        white-space: nowrap;
    }

    .badge-zona-small {
        background: #e9ecef;
        color: #495057;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.65em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
        border: 1px solid #dee2e6;
    }

    .search-result-item .stock {
        color: #666;
        font-size: 0.9em;
    }

    .search-result-item .stock.bajo {
        color: #dc3545;
        font-weight: 600;
    }

    .cliente-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }

    .info-box {
        margin-bottom: 8px;
        padding: 8px;
        background: white;
        border-radius: 6px;
    }

    .info-box strong {
        color: #666;
        margin-right: 8px;
    }


    .cliente-seleccionado-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 16px;
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .cliente-seleccionado-box.consumidor-final {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        color: #212529;
        box-shadow: none;
    }

    .cliente-seleccionado-box.consumidor-final .cliente-icon {
        color: #6c757d;
    }

    .cliente-seleccionado-box.consumidor-final .cliente-nombre {
        color: #212529;
    }

    .cliente-seleccionado-box.consumidor-final .cliente-cedula {
        color: #6c757d;
    }

    .cliente-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .cliente-icon {
        font-size: 2.5em;
        opacity: 0.9;
    }

    .cliente-datos {
        flex: 1;
    }

    .cliente-nombre {
        font-weight: 700;
        font-size: 1.1em;
        margin-bottom: 4px;
    }

    .cliente-cedula {
        font-size: 0.9em;
        opacity: 0.9;
    }

    .cliente-detalles {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 12px;
    }

    .cliente-detalle-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        font-size: 0.9em;
    }

    .cliente-detalle-item i {
        opacity: 0.8;
        width: 16px;
    }

    .cliente-acciones {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }

    .btn-cliente-accion {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.2s ease;
        font-size: 0.9em;
    }

    .btn-cambiar {
        background: rgba(255, 255, 255, 0.25);
        color: white;
    }

    .btn-cambiar:hover {
        background: rgba(255, 255, 255, 0.35);
        transform: translateY(-2px);
    }

    .consumidor-final .btn-cambiar {
        background: #d4a017;
        color: white;
    }

    .consumidor-final .btn-cambiar:hover {
        background: #b8891a;
    }

    .btn-editar {
        background: rgba(255, 255, 255, 0.25);
        color: white;
    }

    .btn-editar:hover {
        background: rgba(255, 255, 255, 0.35);
        transform: translateY(-2px);
    }

    .btn-borrar {
        background: rgba(220, 53, 69, 0.9);
        color: white;
    }

    .btn-borrar:hover {
        background: rgba(220, 53, 69, 1);
        transform: translateY(-2px);
    }


    .cantidad-editable-input {
        width: 70px;
        padding: 8px 6px;
        text-align: center;
        border: 2px solid #d4a017;
        border-radius: 4px;
        font-weight: 600;
        font-size: 1em;
        background: #fffef5;
        transition: all 0.2s ease;
    }

    .cantidad-editable-input:focus {
        outline: none;
        border-color: #b8860b;
        background: white;
        box-shadow: 0 0 0 3px rgba(212, 160, 23, 0.1);
    }


    .cantidad-editable-input::-webkit-inner-spin-button,
    .cantidad-editable-input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .cantidad-editable-input {
        -moz-appearance: textfield;
        appearance: textfield;
    }

    .carrito-item-cantidad {
        width: 60px;
        padding: 6px;
        text-align: center;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
    }

    .action-buttons {
        display: flex;
        gap: 6px;
        justify-content: center;
        align-items: center;
    }

    .btn-remove-item {
        background: #dc3545;
        color: white;
        border: none;
        width: 34px;
        height: 34px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-remove-item:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-warranty-item {
        background: #28a745;
        color: white;
        border: none;
        width: 34px;
        height: 34px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-warranty-item:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .badge-zona {
        background: #e9ecef;
        color: #495057;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
        border: 1px solid #dee2e6;
    }


    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal.show {
        display: flex;
        opacity: 1;
    }


    .container>div>div {
        scrollbar-width: thin;
        scrollbar-color: #d4a017 #f1f1f1;
    }

    .container>div>div::-webkit-scrollbar {
        width: 3px;
    }

    .container>div>div::-webkit-scrollbar-track {
        background: transparent;
    }

    .container>div>div::-webkit-scrollbar-thumb {
        background: #d4a017;
        border-radius: 10px;
    }

    .container>div>div::-webkit-scrollbar-thumb:hover {
        background: #b8860b;
    }

    .search-results::-webkit-scrollbar {
        width: 3px;
    }

    .search-results::-webkit-scrollbar-track {
        background: transparent;
    }

    .search-results::-webkit-scrollbar-thumb {
        background: #d4a017;
        border-radius: 10px;
    }


    .items-counter {
        display: flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 8px 16px;
        border-radius: 8px;
        border: 2px solid #d4a017;
        font-weight: 600;
    }

    .items-counter i {
        color: #d4a017;
        font-size: 1.1em;
    }

    .items-counter #itemsCount {
        font-size: 1.3em;
        color: #d4a017;
        font-weight: 800;
        min-width: 25px;
        text-align: center;
    }

    .items-counter .items-label {
        font-size: 0.9em;
        color: #666;
        text-transform: lowercase;
    }

    /* Botón de Ganancia */
    .ganancia-toggle-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: 2px solid #1e7e34;
        color: white;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 700;
        font-size: 1em;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }

    .ganancia-toggle-btn:hover {
        background: linear-gradient(135deg, #218838 0%, #1a9e7b 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
    }

    .ganancia-toggle-btn.active {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border-color: #bd2130;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }

    .ganancia-toggle-btn.active:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
    }

    .ganancia-toggle-btn i {
        font-size: 0.9em;
    }

    /* Total de Ganancia Inline */
    .ganancia-total-inline {
        display: none;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        padding: 8px 16px;
        border-radius: 8px;
        border: 2px solid #1e7e34;
        animation: expandIn 0.3s ease;
    }

    .ganancia-total-inline.active {
        display: flex;
    }

    @keyframes expandIn {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .ganancia-total-label {
        color: white;
        font-weight: 600;
        font-size: 0.9em;
    }

    .ganancia-total-value {
        color: white;
        font-weight: 800;
        font-size: 1.2em;
    }

    /* Ganancia en filas del carrito */
    .ganancia-fila {
        font-size: 0.75em;
        color: #28a745;
        font-weight: 600;
        margin-top: 2px;
    }

    .ganancia-fila.negativo {
        color: #dc3545;
    }

    .ganancia-fila.loading {
        color: #999;
        font-style: italic;
    }

    /* Panel de Ganancia */
    .ganancia-panel {
        display: none;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid #28a745;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        animation: slideDown 0.3s ease;
    }

    .ganancia-panel.active {
        display: block;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ganancia-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 2px solid #28a745;
    }

    .ganancia-header h4 {
        margin: 0;
        color: #28a745;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ganancia-content {
        max-height: 250px;
        overflow-y: auto;
        margin-bottom: 12px;
    }

    .ganancia-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: white;
        border-radius: 6px;
        margin-bottom: 6px;
        border-left: 3px solid #28a745;
    }

    .ganancia-item-info {
        flex: 1;
    }

    .ganancia-item-nombre {
        font-weight: 600;
        color: #333;
        font-size: 0.95em;
        margin-bottom: 3px;
    }

    .ganancia-item-detalle {
        font-size: 0.8em;
        color: #666;
    }

    .ganancia-item-valor {
        font-weight: 700;
        font-size: 1em;
        color: #28a745;
        white-space: nowrap;
        margin-left: 10px;
    }

    .ganancia-item-valor.negativo {
        color: #dc3545;
    }

    .ganancia-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1.1em;
    }

    .ganancia-total-value {
        font-size: 1.3em;
    }


    .edit-mode-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #007bff;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.85em;
        display: none;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.4);
        z-index: 10;
        animation: slideIn 0.3s ease;
    }

    .edit-mode-badge.active {
        display: flex;
    }

    .edit-mode-indicator {
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        animation: blink 1s infinite;
    }

    @keyframes blink {

        0%,
        50% {
            opacity: 1;
        }

        51%,
        100% {
            opacity: 0.3;
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(-100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }


    .modal-cantidad-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(3px);
    }

    .modal-cantidad-overlay.active {
        display: flex;
        animation: fadeIn 0.2s ease-out;
    }

    .modal-cantidad-box {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: modalBounce 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-cantidad-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 2px solid #f0f0f0;
    }

    .modal-cantidad-header h3 {
        margin: 0;
        color: #1a1a1a;
        font-size: 1.2em;
        font-weight: 700;
    }

    .modal-cantidad-close {
        background: none;
        border: none;
        font-size: 2em;
        color: #999;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 30px;
        height: 30px;
        transition: all 0.2s ease;
    }

    .modal-cantidad-close:hover {
        color: #dc3545;
        transform: rotate(90deg);
    }

    .modal-cantidad-body {
        padding: 25px 20px;
    }

    .stock-disponible {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #28a745;
    }

    .stock-disponible i {
        color: #28a745;
        font-size: 1.2em;
    }

    .stock-disponible span {
        color: #666;
        font-size: 0.95em;
    }

    .stock-disponible strong {
        color: #28a745;
        font-size: 1.3em;
        font-weight: 800;
        margin-left: auto;
    }

    .cantidad-input-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .cantidad-input-group label {
        font-weight: 600;
        color: #666;
        font-size: 0.95em;
    }

    .modal-cantidad-input {
        padding: 15px;
        font-size: 1.3em;
        text-align: center;
        border: 2px solid #d4a017;
        border-radius: 8px;
        font-weight: 700;
        background: #fffef5;
        transition: all 0.2s ease;
    }

    .modal-cantidad-input:focus {
        outline: none;
        border-color: #b8860b;
        background: white;
        box-shadow: 0 0 0 4px rgba(212, 160, 23, 0.1);
    }

    .modal-cantidad-input::-webkit-inner-spin-button,
    .modal-cantidad-input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .modal-cantidad-footer {
        display: flex;
        gap: 10px;
        padding: 20px;
        border-top: 2px solid #f0f0f0;
        justify-content: flex-end;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes modalBounce {
        from {
            transform: scale(0.8);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }


    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease-out;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-box {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 550px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        animation: modalBounce 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 2px solid #f0f0f0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px 16px 0 0;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.3em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-header i {
        font-size: 1.2em;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        cursor: pointer;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .modal-warning {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        border-left: 4px solid #ffc107;
        border-radius: 8px;
        margin-bottom: 24px;
    }

    .modal-warning i {
        color: #856404;
        font-size: 1.3em;
        margin-top: 2px;
    }

    .modal-warning p {
        margin: 0;
        color: #856404;
        font-size: 0.95em;
        line-height: 1.5;
    }

    .modal-form-group {
        margin-bottom: 20px;
    }

    .modal-form-group label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 0.95em;
    }

    .modal-form-group label .required {
        color: #dc3545;
        margin-left: 4px;
    }

    .modal-form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        transition: all 0.2s ease;
        box-sizing: border-box;
    }

    .modal-form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .modal-form-group input:disabled {
        background: #f5f5f5;
        color: #999;
        cursor: not-allowed;
    }

    .modal-form-group small {
        display: block;
        margin-top: 6px;
        color: #666;
        font-size: 0.85em;
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        padding: 20px 24px;
        border-top: 2px solid #f0f0f0;
        justify-content: flex-end;
        background: #fafafa;
        border-radius: 0 0 16px 16px;
    }

    .modal-btn {
        padding: 12px 28px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95em;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .modal-btn-cancel {
        background: #e0e0e0;
        color: #666;
    }

    .modal-btn-cancel:hover {
        background: #d0d0d0;
        transform: translateY(-1px);
    }

    .modal-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .modal-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .modal-required-note {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 16px;
        font-style: italic;
    }


    .carrito-edit-mode {
        border: 3px solid #007bff !important;
        box-shadow: 0 0 20px rgba(0, 123, 255, 0.3) !important;
    }


    .carrito-item-selected {
        background: rgba(40, 167, 69, 0.15) !important;
        border-left: 4px solid #28a745;
    }


    .search-result-selected {
        background: rgba(0, 123, 255, 0.15) !important;
        border-left: 4px solid #007bff;
    }


    .precio-editable {
        border: 1px solid #007bff;
        padding: 4px 8px;
        border-radius: 4px;
        background: #f8f9fa;
        cursor: text;
        width: 80px;
        text-align: right;
        font-size: 0.95em;
    }

    .precio-editable:focus {
        outline: 2px solid #007bff;
        background: white;
    }


    .modal-venta-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
        padding: 20px;
    }

    .modal-venta-overlay.active {
        display: flex;
        animation: fadeIn 0.2s ease-out;
    }

    .modal-caja-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.85);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
        backdrop-filter: blur(6px);
    }

    .modal-caja-overlay.active {
        display: flex;
    }

    .modal-caja-container {
        width: 95%;
        max-width: 1100px;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 25px 70px rgba(15, 23, 42, 0.35);
        overflow: hidden;
        animation: modalBounce 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }

    .modal-caja-header {
        padding: 22px 26px;
        background: linear-gradient(135deg, #38bdf8 0%, #2563eb 100%);
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-shrink: 0;
    }

    .modal-caja-header h2 {
        margin: 0;
        font-size: 1.35em;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-caja-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 18px;
        overflow-y: auto;
    }

    .modal-caja-description {
        margin: 0;
        color: #475569;
        font-size: 0.95em;
        line-height: 1.5;
    }

    .modal-caja-form {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .modal-caja-form label {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.95em;
    }

    .modal-caja-expected {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        background: #f8fafc;
        color: #1f2937;
        font-size: 0.92em;
    }

    .modal-caja-expected-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .modal-caja-expected-text span {
        font-weight: 600;
    }

    .modal-caja-expected-text small {
        font-size: 0.75em;
        color: #64748b;
    }

    .modal-caja-expected strong {
        font-size: 1em;
        color: #0f172a;
    }

    #cajaInicialMontoInput,
    #cajaInicialNotasInput {
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        font-size: 1em;
        width: 100%;
        box-sizing: border-box;
    }

    /* Estilos para denominaciones */
    .denominaciones-section {
        background: #f8fafc;
        border-radius: 12px;
        padding: 18px;
        border: 1px solid #e2e8f0;
    }

    .denominaciones-titulo {
        margin: 0 0 16px 0;
        font-size: 1.05em;
        color: #1e40af;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .denominaciones-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 16px;
    }

    .denominacion-grupo h4 {
        margin: 0 0 12px 0;
        font-size: 0.95em;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 6px;
        padding-bottom: 8px;
        border-bottom: 2px solid #cbd5e1;
    }

    .denominacion-item {
        display: grid;
        grid-template-columns: 60px 50px 1fr 80px;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .denom-esperado {
        font-size: 0.85em;
        color: #64748b;
        text-align: center;
        background: #f1f5f9;
        padding: 4px;
        border-radius: 4px;
        font-weight: 600;
    }

    .denominacion-item label {
        font-weight: 600;
        color: #334155;
        font-size: 0.9em;
    }

    .denom-input {
        padding: 6px 10px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 0.9em;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
    }

    .denom-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .denom-total {
        text-align: right;
        font-weight: 600;
        color: #059669;
        font-size: 0.9em;
    }

    .total-contado {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-radius: 10px;
        border: 2px solid #2563eb;
        margin-top: 4px;
    }

    .total-contado span {
        font-size: 1.05em;
        font-weight: 600;
        color: #1e40af;
    }

    .total-contado strong {
        font-size: 1.4em;
        color: #1e3a8a;
    }

    /* Estilos adicionales para Cierre */
    .cierre-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    .resumen-cierre-card {
        background: #fdf2f2;
        border: 1px solid #fecaca;
        border-radius: 12px;
        padding: 20px;
    }

    .resumen-cierre-card h3 {
        margin: 0 0 16px 0;
        font-size: 1.1em;
        color: #991b1b;
        border-bottom: 2px solid #fca5a5;
        padding-bottom: 8px;
    }

    .cuadre-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.95em;
        color: #4b5563;
    }

    .cuadre-item.separator {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px dashed #cbd5e1;
    }

    .cuadre-item strong {
        color: #111827;
    }

    .cuadre-item.total-esperado {
        padding: 10px;
        background: #f1f5f9;
        border-radius: 8px;
        font-weight: 600;
        margin-top: 5px;
    }

    .cuadre-item.total-contado-resumen {
        padding: 10px;
        font-weight: 600;
    }

    .cuadre-item.desfase-box {
        padding: 12px;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 700;
        margin-top: 10px;
    }

    .desfase-ok { background: #d1fae5; color: #065f46 !important; border: 1px solid #6ee7b7; }
    .desfase-error { background: #fee2e2; color: #991b1b !important; border: 1px solid #fca5a5; }

    .btn-cancelar-caja {
        padding: 12px 22px;
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        background: white;
        color: #475569;
        font-weight: 600;
        cursor: pointer;
        margin-right: 10px;
    }

    .modal-close-simple {
        background: transparent;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        line-height: 1;
    }

    #cajaInicialMontoInput:focus,
    #cajaInicialNotasInput:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .modal-caja-error {
        border-radius: 8px;
        background: #fee2e2;
        border: 1px solid #f87171;
        color: #b91c1c;
        padding: 10px 12px;
        font-size: 0.92em;
    }

    .modal-caja-info {
        border-radius: 8px;
        background: #ecfdf5;
        border: 1px solid #34d399;
        color: #047857;
        padding: 10px 12px;
        font-size: 0.92em;
    }

    .modal-caja-footer {
        padding: 18px 24px 24px;
        display: flex;
        justify-content: flex-end;
    }

    .btn-guardar-caja {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #2563eb;
        color: #ffffff;
        border: none;
        padding: 12px 22px;
        border-radius: 10px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .btn-guardar-caja:hover {
        background: #1d4ed8;
    }

    .btn-guardar-caja:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .modal-venta-container {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 900px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: modalBounce 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-venta-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 30px;
        background: linear-gradient(135deg, #d4a017 0%, #b8891a 100%);
        color: white;
        border-radius: 16px 16px 0 0;
    }

    .modal-venta-header h2 {
        margin: 0;
        font-size: 1.5em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-venta-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8em;
        transition: all 0.2s ease;
    }

    .modal-venta-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .modal-venta-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        padding: 30px;
    }

    .modal-venta-left,
    .modal-venta-right {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .modal-venta-container.credit-modal {
        max-width: 1100px;
    }

    .modal-venta-content.credit-layout {
        grid-template-columns: 1.05fr 0.95fr 0.95fr;
        gap: 18px;
        padding: 24px 28px;
    }

    .modal-venta-content.credit-layout .modal-venta-col {
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .modal-venta-content.credit-layout .venta-section {
        gap: 8px;
    }

    .modal-venta-content.credit-layout .info-box {
        padding: 16px;
    }

    .modal-venta-content.credit-layout .total-grande {
        padding: 18px;
    }

    .modal-venta-content.credit-layout .input-pago {
        padding: 14px;
        font-size: 1.15em;
    }

    .modal-venta-content.credit-layout .input-pago[type="date"],
    .modal-venta-content.credit-layout select.input-pago,
    .modal-venta-content.credit-layout textarea.input-pago {
        font-size: 1em;
        text-align: left;
    }

    .modal-venta-actions.credit-actions {
        margin-top: auto;
        display: flex;
        gap: 12px;
    }

    .modal-venta-actions.credit-actions .btn-modal-cancelar,
    .modal-venta-actions.credit-actions .btn-modal-confirmar {
        flex: 1;
        justify-content: center;
    }

    @media (max-width: 1100px) {
        .modal-venta-content.credit-layout {
            grid-template-columns: 1fr 1fr;
        }

        .modal-venta-content.credit-layout .modal-venta-col:last-child {
            grid-column: span 2;
        }
    }

    @media (max-width: 768px) {
        .modal-venta-content.credit-layout {
            grid-template-columns: 1fr;
        }

        .modal-venta-content.credit-layout .modal-venta-col:last-child {
            grid-column: auto;
        }
    }

    .venta-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .venta-section h3 {
        margin: 0 0 12px 0;
        color: #333;
        font-size: 1em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .venta-section h3 i {
        color: #d4a017;
        font-size: 0.9em;
    }

    .cliente-info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 12px;
        color: white;
    }

    .cliente-info-card .cliente-nombre {
        font-size: 1.3em;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .cliente-info-card .cliente-detalle {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 5px 0;
        font-size: 0.95em;
        opacity: 0.95;
    }

    .cliente-info-card .cliente-detalle i {
        width: 16px;
    }

    .cliente-info-card.consumidor-final {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    }

    .total-grande {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 25px;
        background: linear-gradient(135deg, #fff8e1 0%, #ffe082 100%);
        border-radius: 12px;
        border-left: 5px solid #d4a017;
    }

    .total-grande span {
        font-size: 1.8em;
        font-weight: 800;
        color: #d4a017;
    }

    .total-grande strong {
        font-size: 2.2em;
        font-weight: 900;
        color: #d4a017;
    }

    .pago-group {
        margin-bottom: 15px;
    }

    .pago-group label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        font-size: 0.95em;
    }

    .input-pago {
        width: 100%;
        padding: 18px;
        border: 3px solid #d4a017;
        border-radius: 12px;
        font-size: 1.5em;
        font-weight: 700;
        text-align: center;
        background: #fffef5;
        transition: all 0.2s ease;
        box-sizing: border-box;
    }

    .input-pago:focus {
        outline: none;
        border-color: #b8891a;
        background: white;
        box-shadow: 0 0 0 4px rgba(212, 160, 23, 0.15);
    }

    .vuelto-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 20px;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border-radius: 12px;
        border-left: 5px solid #28a745;
    }

    .vuelto-display span {
        font-weight: 700;
        color: #333;
        font-size: 1.1em;
    }

    .vuelto-display strong {
        font-size: 1.6em;
        font-weight: 900;
        color: #28a745;
    }

    .tipo-comprobante-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .btn-tipo-comprobante {
        padding: 15px 20px;
        border: 3px solid #e0e0e0;
        background: white;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 1em;
        font-weight: 600;
        color: #666;
    }

    .btn-tipo-comprobante i {
        font-size: 1.8em;
        color: #999;
        transition: all 0.2s ease;
    }

    .btn-tipo-comprobante:hover {
        border-color: #d4a017;
        background: #fffef5;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(212, 160, 23, 0.2);
    }

    .btn-tipo-comprobante:hover i {
        color: #d4a017;
    }

    .btn-tipo-comprobante.active {
        border-color: #d4a017;
        background: linear-gradient(135deg, #fff8e1 0%, #ffe082 100%);
        color: #d4a017;
        font-weight: 700;
    }

    .btn-tipo-comprobante.active i {
        color: #d4a017;
    }

    .modal-venta-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 5px;
    }

    .btn-modal-cancelar,
    .btn-modal-confirmar {
        padding: 18px 24px;
        border: none;
        border-radius: 12px;
        font-size: 1.1em;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-modal-cancelar {
        background: #6c757d;
        color: white;
    }

    .btn-modal-cancelar:hover {
        background: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
    }

    .btn-modal-confirmar {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .btn-modal-confirmar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }

    .btn-modal-confirmar:disabled {
        background: #d0d0d0;
        color: #999;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }


    @media (max-width: 768px) {
        .modal-venta-content {
            grid-template-columns: 1fr;
        }
    }


    .custom-confirm-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease;
    }

    .custom-confirm-overlay.active {
        display: flex;
    }

    .custom-confirm-box {
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .custom-confirm-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .custom-confirm-message {
        color: #666;
        margin-bottom: 25px;
        line-height: 1.5;
    }

    .custom-confirm-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-end;
    }

    .custom-confirm-btn {
        padding: 10px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95em;
        transition: all 0.2s ease;
    }

    .custom-confirm-btn-cancel {
        background: #e0e0e0;
        color: #666;
    }

    .custom-confirm-btn-cancel:hover {
        background: #d0d0d0;
    }

    .custom-confirm-btn-confirm {
        background: #28a745;
        color: white;
    }

    .custom-confirm-btn-confirm:hover {
        background: #218838;
    }

    .custom-confirm-btn-danger {
        background: #dc3545;
        color: white;
    }

    .custom-confirm-btn-danger:hover {
        background: #c82333;
    }

    .custom-confirm-btn-primary {
        background: #667eea;
        color: white;
    }

    .custom-confirm-btn-primary:hover {
        background: #5568d3;
    }

    .custom-confirm-btn-secondary {
        background: #6c757d;
        color: white;
    }

    .custom-confirm-btn-secondary:hover {
        background: #5a6268;
    }

    @media (max-width: 992px) {
        .container>div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
            height: auto !important;
        }

        .container>div>div {
            overflow-y: visible !important;
            height: auto !important;
        }
    }
    /* Estilos para Eventualidades */
    .btn-flotante-eventualidad {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #6c5ce7;
        color: white;
        width: 180px;
        height: 60px;
        border-radius: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        z-index: 999;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 3px solid #1a1a1a;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    .btn-flotante-eventualidad:hover {
        transform: scale(1.05) translateY(-5px);
        background: #a29bfe;
        box-shadow: 0 15px 30px rgba(108, 92, 231, 0.4);
    }

    .btn-flotante-eventualidad i {
        font-size: 1.3rem;
    }

    .eventualidad-alerta {
        position: absolute;
        top: -8px;
        right: 15px;
        background: #fdcb6e;
        color: #1a1a1a;
        font-size: 0.65rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 900;
        border: 2px solid #1a1a1a;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

</style>




<!-- Boton Flotante Eventualidad -->
<button class="btn-flotante-eventualidad" onclick="window.abrirModalEventualidad()">
    <span class="eventualidad-alerta">AUDITORIA</span>
    <i class="fas fa-exclamation-circle"></i>
    <span>Eventualidad</span>
</button>

<!-- Modal de Eventualidad -->
<div id="modalEventualidadOverlay" class="custom-confirm-overlay" style="z-index: 10001;">
    <div class="custom-confirm-box" style="max-width: 500px;">
        <div class="custom-confirm-title">
            <i class="fas fa-exclamation-triangle" style="color: #6c5ce7;"></i>
            Registrar Eventualidad
        </div>
        <div class="custom-confirm-message">
            Resume lo que el cliente pidio o la duda que tuvo para mejorar nuestro stock.
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
            <input type="text" id="inputEventualidad" class="form-input" 
                placeholder="Ej: PIDIO SPRAY ROJO, PREGUNTO POR CANDADO..." 
                oninput="this.value = this.value.toUpperCase()"
                style="font-weight: bold; border-radius: 10px; padding: 15px; border: 2px solid #6c5ce7;">
        </div>
        <div class="custom-confirm-buttons">
            <button class="btn btn-secondary" onclick="window.cerrarModalEventualidad()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn btn-accent" id="btnGuardarEventualidad" onclick="window.guardarEventualidad()" 
                style="background: #6c5ce7; border-color: #6c5ce7;">
                <i class="fas fa-check-circle"></i> REGISTRAR
            </button>
        </div>
    </div>
</div>

<script>
    // =====================================================
    // ESTADO DEL PUNTO DE VENTA
    // =====================================================

    // Usar window para evitar redeclaración en recargas
    if (!window.ventaState) {
        window.ventaState = {
            carrito: [],
            clienteSeleccionado: null,
            cajaInicial: null,
            cajaInicialFecha: null,
            cajaInicialVerificada: false,
            cajaInicialEsperada: null,
            tipoComprobante: 'RECIBO',
            // Datos temporales para venta a crédito
            credito: {
                total: 0,
                abono: 0,
                saldo: 0
            },
            // Modo edición
            modoEdicion: false,
            indiceSeleccionado: -1, // -1 = búsqueda, >= 0 = carrito
            busquedaResultados: [],
            busquedaSeleccionado: -1,
            // Búsqueda de clientes
            clientesBusqueda: [],
            clienteSeleccionadoIndex: -1,
            // Modal de actualización de cliente
            clienteTemporal: null,
            clienteAnterior: null
        };

        // Cargar desde localStorage si existe
        const carritoGuardado = localStorage.getItem('ferreteria_carrito');
        if (carritoGuardado) {
            try {
                const data = JSON.parse(carritoGuardado);
                window.ventaState.carrito = data.carrito || [];
                window.ventaState.clienteSeleccionado = data.clienteSeleccionado || null;
                window.ventaState.tipoComprobante = data.tipoComprobante || 'RECIBO';
            } catch (error) {
            }
        }
    }

    // Referencia local para facilitar el código (usar var para evitar redeclaración)
    var ventaState = window.ventaState;
    if (!ventaState.credito) {
        ventaState.credito = { total: 0, abono: 0, saldo: 0 };
    }
    if (typeof ventaState.cajaInicial === 'undefined') {
        ventaState.cajaInicial = null;
    }
    if (typeof ventaState.cajaInicialFecha === 'undefined') {
        ventaState.cajaInicialFecha = null;
    }
    if (typeof ventaState.cajaInicialVerificada === 'undefined') {
        ventaState.cajaInicialVerificada = false;
    }
    if (typeof ventaState.cajaInicialEsperada === 'undefined') {
        ventaState.cajaInicialEsperada = null;
    }

    // =====================================================
    // SISTEMA DE CACHÉ DE INVENTARIO
    // =====================================================

    if (!window.inventarioCache) {
        window.inventarioCache = {
            productos: [],
            ultimaActualizacion: null,
            cargando: false,
            version: 0
        };
    }

    // Cache de clientes
    if (!window.clientesCache) {
        window.clientesCache = {
            clientes: [],
            ultimaActualizacion: null,
            cargando: false,
            version: 0
        };
    }

    // Tokens API para webservices
    let API_TOKENS = {};

    // =====================================================
    // VALIDACIÓN DE CORREO ELECTRÓNICO
    // =====================================================

    /**
     * Valida un correo electrónico usando la API de validación
     * @param {string} email - El correo electrónico a validar
     * @returns {Promise<Object>} - Objeto con email, mensaje y estado válido
     */
    async function validarCorreo(email) {
        try {
            // Usar proxy CORS para resolver el problema de CORS
            const corsProxy = 'https://corsproxy.io/?';
            const url = `${corsProxy}${encodeURIComponent(`https://apicorreo.luispinta.com/validar?email=${encodeURIComponent(email)}`)}`;

            const respuesta = await fetch(url, {
                method: "GET",
                headers: {
                    "Accept": "application/json"
                }
            });

            if (!respuesta.ok) {
                throw new Error(`Error HTTP: ${respuesta.status}`);
            }

            const data = await respuesta.json();

            return {
                email: data.email || email,
                mensaje: data.resultado?.mensaje || "Sin mensaje",
                valido: data.resultado?.valido ?? false
            };

        } catch (error) {
            console.error("Error validando correo:", error);
            return {
                email,
                mensaje: "Error procesando la solicitud",
                valido: false,
                error: true
            };
        }
    }

    /**
     * Actualiza la UI del campo de correo según el resultado de la validación
     * @param {HTMLInputElement} inputElement - El elemento input del correo
     * @param {HTMLElement} errorElement - El elemento para mostrar mensajes de error
     * @param {Object} resultado - El resultado de la validación
     */
    function actualizarUIValidacionCorreo(inputElement, errorElement, resultado) {
        // Limpiar clases previas
        inputElement.classList.remove('email-valid', 'email-invalid', 'email-error', 'email-validating');

        // Obtener el icono
        const iconElement = inputElement.nextElementSibling;

        if (resultado.error) {
            // Error en la petición - azul celeste con signo de pregunta
            inputElement.classList.add('email-error');
            if (iconElement && iconElement.classList.contains('email-validation-icon')) {
                iconElement.innerHTML = '<i class="fas fa-question-circle"></i>';
            }
            errorElement.textContent = '';
            errorElement.classList.remove('show');
        } else if (resultado.valido) {
            // Correo válido - verde con check
            inputElement.classList.add('email-valid');
            if (iconElement && iconElement.classList.contains('email-validation-icon')) {
                iconElement.innerHTML = '<i class="fas fa-check-circle"></i>';
            }
            errorElement.textContent = '';
            errorElement.classList.remove('show');
        } else {
            // Correo inválido - rojo con X
            inputElement.classList.add('email-invalid');
            if (iconElement && iconElement.classList.contains('email-validation-icon')) {
                iconElement.innerHTML = '<i class="fas fa-times-circle"></i>';
            }
            errorElement.textContent = `⚠️ ${resultado.mensaje || 'El correo no existe'}`;
            errorElement.classList.add('show');
        }
    }

    /**
     * Maneja la validación de correo en el evento blur
     * @param {Event} event - El evento blur del input
     * @param {string} errorElementId - El ID del elemento de error
     */
    async function manejarValidacionCorreo(event, errorElementId) {
        const inputElement = event.target;
        const email = inputElement.value.trim();
        const errorElement = document.getElementById(errorElementId);

        // Si el campo está vacío, limpiar validación
        if (!email) {
            inputElement.classList.remove('email-valid', 'email-invalid', 'email-error', 'email-validating');
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.classList.remove('show');
            }
            return;
        }

        // Validación básica de formato de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            actualizarUIValidacionCorreo(inputElement, errorElement, {
                email,
                mensaje: 'Formato de correo inválido',
                valido: false,
                error: false
            });
            return;
        }

        // Mostrar estado de carga
        inputElement.classList.add('email-validating');

        try {
            // Llamar a la API de validación
            const resultado = await validarCorreo(email);

            // Actualizar UI con el resultado
            if (errorElement) {
                actualizarUIValidacionCorreo(inputElement, errorElement, resultado);
            }
        } catch (error) {
            console.error('Error en validación:', error);
            if (errorElement) {
                actualizarUIValidacionCorreo(inputElement, errorElement, {
                    email,
                    mensaje: 'Error procesando la solicitud',
                    valido: false,
                    error: true
                });
            }
        }
    }

    // =====================================================
    // CAJA INICIAL
    // =====================================================

    const cajaInicialUI = {
        overlay: document.getElementById('modalCajaInicial'),
        montoInput: document.getElementById('cajaInicialMontoInput'),
        notasInput: document.getElementById('cajaInicialNotasInput'),
        errorBox: document.getElementById('modalCajaInicialError'),
        infoBox: document.getElementById('modalCajaInicialInfo'),
        submitBtn: document.getElementById('btnGuardarCajaInicial'),
        esperadoWrapper: document.getElementById('cajaInicialEsperadoWrapper'),
        esperadoLabel: document.getElementById('cajaInicialEsperadoLabel'),
        esperadoValor: document.getElementById('cajaInicialEsperadoValor'),
        esperadoFecha: document.getElementById('cajaInicialEsperadoFecha'),
        totalDenominaciones: document.getElementById('totalDenominaciones')
    };

    // Función para calcular el total de denominaciones
    function calcularTotalDenominaciones() {
        const inputs = document.querySelectorAll('.denom-input');
        let total = 0;

        inputs.forEach(input => {
            const cantidad = parseInt(input.value) || 0;
            const valor = parseFloat(input.dataset.valor);
            const subtotal = cantidad * valor;
            
            // Actualizar el subtotal visual
            const totalSpan = input.parentElement.querySelector('.denom-total');
            if (totalSpan) {
                totalSpan.textContent = window.app ? window.app.formatCurrency(subtotal) : `$${subtotal.toFixed(2)}`;
            }
            
            total += subtotal;
        });

        // Actualizar el total general
        const totalElement = cajaInicialUI.totalDenominaciones;
        if (totalElement) {
            totalElement.textContent = window.app ? window.app.formatCurrency(total) : `$${total.toFixed(2)}`;
        }

        // Mostrar diferencia en tiempo real si hay un valor esperado
        const desfaseWrapper = document.getElementById('cajaInicialDesfaseWrapper');
        const desfaseValor = document.getElementById('cajaInicialDesfase');

        if (desfaseWrapper && desfaseValor && ventaState.cajaInicialEsperada && typeof ventaState.cajaInicialEsperada.monto === 'number') {
            const diferencia = total - ventaState.cajaInicialEsperada.monto;
            const diffNormalizada = Math.round(diferencia * 100) / 100;

            desfaseWrapper.style.display = 'block';
            desfaseValor.textContent = window.app.formatCurrency(diffNormalizada);

            if (Math.abs(diffNormalizada) < 0.01) {
                desfaseWrapper.style.background = '#dcfce7';
                desfaseWrapper.style.color = '#166534';
                desfaseValor.textContent = 'Cuadrado';
            } else {
                desfaseWrapper.style.background = '#fee2e2';
                desfaseWrapper.style.color = '#991b1b';
            }
        } else if (desfaseWrapper) {
            desfaseWrapper.style.display = 'none';
        }

        return total;
    }

    // Función para obtener las denominaciones ingresadas
    function obtenerDenominaciones() {
        return {
            billet_100: parseInt(document.getElementById('billet_100')?.value) || 0,
            billet_50: parseInt(document.getElementById('billet_50')?.value) || 0,
            billet_20: parseInt(document.getElementById('billet_20')?.value) || 0,
            billet_10: parseInt(document.getElementById('billet_10')?.value) || 0,
            billet_5: parseInt(document.getElementById('billet_5')?.value) || 0,
            billet_2: parseInt(document.getElementById('billet_2')?.value) || 0,
            billet_1: parseInt(document.getElementById('billet_1')?.value) || 0,
            moneda_1: parseInt(document.getElementById('moneda_1')?.value) || 0,
            moneda_050: parseInt(document.getElementById('moneda_050')?.value) || 0,
            moneda_025: parseInt(document.getElementById('moneda_025')?.value) || 0,
            moneda_010: parseInt(document.getElementById('moneda_010')?.value) || 0,
            moneda_005: parseInt(document.getElementById('moneda_005')?.value) || 0,
            moneda_001: parseInt(document.getElementById('moneda_001')?.value) || 0
        };
    }

    // Función para limpiar las denominaciones
    function limpiarDenominaciones() {
        const inputs = document.querySelectorAll('.denom-input');
        inputs.forEach(input => {
            input.value = '';
        });
        calcularTotalDenominaciones();
    }

    function setupCajaInicialModal() {
        const { submitBtn, montoInput, notasInput } = cajaInicialUI;
        if (!submitBtn || submitBtn.dataset.listeners === 'ready') {
            return;
        }

        // Agregar event listeners a todos los inputs de denominaciones
        const denomInputs = document.querySelectorAll('.denom-input');
        denomInputs.forEach(input => {
            input.addEventListener('input', calcularTotalDenominaciones);
            input.addEventListener('change', calcularTotalDenominaciones);
        });

        submitBtn.addEventListener('click', (event) => {
            event.preventDefault();
            guardarCajaInicial();
        });

        if (montoInput) {
            montoInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    guardarCajaInicial();
                }
            });
        }

        if (notasInput) {
            notasInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && event.ctrlKey) {
                    event.preventDefault();
                    guardarCajaInicial();
                }
            });
        }

        submitBtn.dataset.listeners = 'ready';
    }

    function limpiarMensajesCajaInicial() {
        if (cajaInicialUI.errorBox) {
            cajaInicialUI.errorBox.textContent = '';
            cajaInicialUI.errorBox.style.display = 'none';
        }
        if (cajaInicialUI.infoBox) {
            cajaInicialUI.infoBox.textContent = '';
            cajaInicialUI.infoBox.style.display = 'none';
        }
    }

    function mostrarErrorCajaInicial(mensaje) {
        if (!cajaInicialUI.errorBox) return;
        cajaInicialUI.errorBox.textContent = mensaje;
        cajaInicialUI.errorBox.style.display = 'block';
    }

    function mostrarInfoCajaInicial(mensaje) {
        if (!cajaInicialUI.infoBox) return;
        cajaInicialUI.infoBox.textContent = mensaje;
        cajaInicialUI.infoBox.style.display = mensaje ? 'block' : 'none';
    }

    function actualizarValorEsperadoCajaInicial({ monto, fecha } = {}) {
        const { esperadoWrapper, esperadoLabel, esperadoValor, esperadoFecha } = cajaInicialUI;
        if (!esperadoWrapper || !esperadoLabel || !esperadoValor) {
            return;
        }

        const denomIds = [
            'billet_100', 'billet_50', 'billet_20', 'billet_10', 'billet_5', 'billet_2', 'billet_1',
            'moneda_1', 'moneda_050', 'moneda_025', 'moneda_010', 'moneda_005', 'moneda_001'
        ];

        if (typeof monto !== 'number' || Number.isNaN(monto)) {
            esperadoWrapper.style.display = 'none';
            esperadoLabel.textContent = 'Valor esperado (caja anterior)';
            esperadoValor.textContent = '';
            if (esperadoFecha) {
                esperadoFecha.textContent = '';
            }
            // Limpiar indicadores de denominación esperada
            denomIds.forEach(id => {
                const span = document.getElementById(`esp_${id}`);
                if (span) span.textContent = '0';
            });
            return;
        }

        const montoNormalizado = Math.round(Number(monto) * 100) / 100;
        const formato = (window.app && typeof window.app.formatCurrency === 'function')
            ? window.app.formatCurrency(montoNormalizado)
            : `$${montoNormalizado.toFixed(2)}`;

        esperadoWrapper.style.display = 'flex';
        esperadoLabel.textContent = 'Valor esperado (caja anterior)';
        esperadoValor.textContent = formato;
        if (esperadoFecha) {
            const fechaTexto = formatearFechaCortaLocal(fecha);
            esperadoFecha.textContent = fechaTexto ? `Del ${fechaTexto}` : '';
        }

        // Actualizar indicadores de denominación esperada
        if (ventaState.cajaInicialEsperada && ventaState.cajaInicialEsperada.denominaciones) {
            const denoms = ventaState.cajaInicialEsperada.denominaciones;
            denomIds.forEach(id => {
                const span = document.getElementById(`esp_${id}`);
                if (span) {
                    // Mapear id del input a columna de la DB si es necesario
                    // En este caso coinciden o casi coinciden
                    span.textContent = denoms[id] || 0;
                }
            });
        }
    }

    function setCajaInicialLoading(isLoading) {
        const { submitBtn } = cajaInicialUI;
        if (!submitBtn) return;

        submitBtn.disabled = isLoading;
        submitBtn.innerHTML = isLoading
            ? '<i class="fas fa-spinner fa-spin"></i> Guardando...'
            : '<i class="fas fa-save"></i> Guardar caja inicial';
    }

    // Genera un texto estructurado del desfase para WhatsApp y Auditoría
    function generarTextoDesfase(contado, esperado) {
        if (!contado || !esperado) return null;

        const NOMBRES_ES = {
            billet_100: '$100', billet_50: '$50', billet_20: '$20', billet_10: '$10',
            billet_5: '$5', billet_2: '$2', billet_1: '$1',
            moneda_1: '$1.00', moneda_050: '$0.50', moneda_025: '$0.25',
            moneda_010: '$0.10', moneda_005: '$0.05', moneda_001: '$0.01'
        };

        const faltantes = [];
        const sobrantes = [];

        Object.keys(NOMBRES_ES).forEach(key => {
            const c = parseInt(contado[key]) || 0;
            const e = parseInt(esperado[key]) || 0;
            const diff = c - e;

            if (diff !== 0) {
                const absDiff = Math.abs(diff);
                const esBillete = key.includes('billet');
                const emoji = esBillete ? '💵' : '🪙';
                const label = absDiff === 1 ? (esBillete ? 'billete' : 'moneda') : (esBillete ? 'billetes' : 'monedas');
                const linea = `- ${emoji} ${absDiff} ${label} de ${NOMBRES_ES[key]}`;

                if (diff < 0) {
                    faltantes.push(linea);
                } else {
                    sobrantes.push(linea);
                }
            }
        });

        if (faltantes.length === 0 && sobrantes.length === 0) return null;

        let resultado = "";
        if (sobrantes.length > 0) {
            resultado += `*SOBRANTES:*\n${sobrantes.join('\n')}\n\n`;
        }
        if (faltantes.length > 0) {
            resultado += `*FALTANTES:*\n${faltantes.join('\n')}`;
        }

        return resultado.trim();
    }

    // Análisis detallado de diferencias en denominaciones
    function generarDetalleDesfase(contado, esperado) {
        if (!contado || !esperado) return '';

        const NOMBRES_ES = {
            billet_100: '$100', billet_50: '$50', billet_20: '$20', billet_10: '$10',
            billet_5: '$5', billet_2: '$2', billet_1: '$1',
            moneda_1: '$1.00', moneda_050: '$0.50', moneda_025: '$0.25',
            moneda_010: '$0.10', moneda_005: '$0.05', moneda_001: '$0.01'
        };

        const faltas = [];
        const sobras = [];

        Object.keys(NOMBRES_ES).forEach(key => {
            const c = parseInt(contado[key]) || 0;
            const e = parseInt(esperado[key]) || 0;
            const diff = c - e;

            if (diff !== 0) {
                const absDiff = Math.abs(diff);
                const esBillete = key.includes('billet');
                const label = absDiff === 1 ? (esBillete ? 'billete' : 'moneda') : (esBillete ? 'billetes' : 'monedas');
                const msg = `${absDiff} ${label} de ${NOMBRES_ES[key]}`;

                if (diff < 0) {
                    faltas.push(`Falta${absDiff > 1 ? 'n' : ''} ${msg}`);
                } else {
                    sobras.push(`Sobra${absDiff > 1 ? 'n' : ''} ${msg}`);
                }
            }
        });

        if (faltas.length === 0 && sobras.length === 0) return '';

        let html = '<div class="desfase-detalle" style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 0.9em; text-align: left;">';
        if (faltas.length > 0) {
            html += `<div style="color: #e11d48; margin-bottom: 5px;"><strong><i class="fas fa-minus-circle"></i> Faltantes:</strong><br><ul style="margin: 5px 0; padding-left: 20px;"><li>${faltas.join('</li><li>')}</li></ul></div>`;
        }
        if (sobras.length > 0) {
            html += `<div style="color: #059669;"><strong><i class="fas fa-plus-circle"></i> Sobrantes:</strong><br><ul style="margin: 5px 0; padding-left: 20px;"><li>${sobras.join('</li><li>')}</li></ul></div>`;
        }
        html += '</div>';
        return html;
    }

    function mostrarModalCajaInicial({ focusMonto = false } = {}) {
        const { overlay, montoInput } = cajaInicialUI;
        if (!overlay) return;

        overlay.classList.add('active');

        if (focusMonto && montoInput) {
            setTimeout(() => {
                montoInput.focus();
                montoInput.select();
            }, 50);
        }
    }

    async function obtenerCajaFisicaAnterior(supabase, fechaISO) {
        if (!supabase || !fechaISO) {
            return null;
        }

        try {
            const { data, error } = await supabase
                .from('ferre_caja_diaria')
                .select('*')
                .lt('fecha', fechaISO)
                .order('fecha', { ascending: false })
                .limit(1)
                .maybeSingle();

            if (error && error.code !== 'PGRST116') {
                throw error;
            }

            return data || null;
        } catch (error) {
            console.error('Error al obtener caja física anterior:', error);
            return null;
        }
    }

    function ocultarModalCajaInicial() {
        if (!cajaInicialUI.overlay) return;
        cajaInicialUI.overlay.classList.remove('active');
        limpiarMensajesCajaInicial();
        if (cajaInicialUI.montoInput) {
            cajaInicialUI.montoInput.value = '';
        }
        if (cajaInicialUI.notasInput) {
            cajaInicialUI.notasInput.value = '';
        }
        actualizarValorEsperadoCajaInicial();
        if (ventaState) {
            ventaState.cajaInicialEsperada = null;
        }
        setCajaInicialLoading(false);
    }

    async function verificarCajaInicialDelDia(options = {}) {
        const { forceConsulta = false } = options;
        const fechaISO = obtenerFechaISOHoy();

        if (!forceConsulta && ventaState.cajaInicial && ventaState.cajaInicial.fecha === fechaISO) {
            ventaState.cajaInicialVerificada = true;
            return ventaState.cajaInicial;
        }

        try {
            limpiarMensajesCajaInicial();

            const supabase = typeof getSupabaseClient === 'function' ? getSupabaseClient() : (typeof supabaseClient !== 'undefined' ? supabaseClient : null);
            if (!supabase) {
                throw new Error('No se pudo inicializar la conexión con la base de datos.');
            }

            const { data, error } = await supabase
                .from('ferre_caja_inicial')
                .select('*')
                .eq('fecha', fechaISO)
                .maybeSingle();

            if (error && error.code !== 'PGRST116') {
                throw error;
            }

            if (data) {
                ventaState.cajaInicial = data;
                ventaState.cajaInicialFecha = data.fecha;
                ventaState.cajaInicialVerificada = true;
                ocultarModalCajaInicial();
                return data;
            }

            ventaState.cajaInicial = null;
            ventaState.cajaInicialFecha = fechaISO;
            ventaState.cajaInicialVerificada = true;

            mostrarModalCajaInicial({ focusMonto: false });

            const anterior = await obtenerCajaFisicaAnterior(supabase, fechaISO);
            const montoEsperado = anterior ? Number(anterior.caja_fisica_contada || 0) : null;

            if (anterior && Number.isFinite(montoEsperado)) {
                const montoNormalizado = Math.round(montoEsperado * 100) / 100;
                ventaState.cajaInicialEsperada = {
                    fecha: anterior.fecha,
                    monto: montoNormalizado,
                    denominaciones: anterior // Guardar todo el objeto para tener las denominaciones
                };
                actualizarValorEsperadoCajaInicial({ monto: montoNormalizado, fecha: anterior.fecha });
                
                // Si el usuario quiere, podríamos llenar las denominaciones automáticamente si coinciden
                // Pero por seguridad de auditoría, mejor que las cuenten de nuevo.
                
                const fechaTexto = formatearFechaCortaLocal(anterior.fecha);
                const mensaje = fechaTexto
                    ? `Valor esperado calculado con el cierre del ${fechaTexto}. Ingresa las denominaciones físicamente.`
                    : 'Valor esperado calculado con la última caja cerrada. Ingresa las denominaciones físicamente.';
                mostrarInfoCajaInicial(mensaje);
            } else {
                ventaState.cajaInicialEsperada = null;
                actualizarValorEsperadoCajaInicial();
                mostrarInfoCajaInicial('Registra el efectivo contado por denominaciones antes de iniciar la jornada.');
            }

            if (cajaInicialUI.overlay) {
                setTimeout(() => {
                    const firstInput = document.getElementById('billet_100');
                    if (firstInput) firstInput.focus();
                }, 60);
            }

            setCajaInicialLoading(false);
            return null;
        } catch (error) {
            console.error('Error al verificar caja inicial:', error);
            ventaState.cajaInicialVerificada = false;
            mostrarModalCajaInicial({ focusMonto: true });
            mostrarErrorCajaInicial('No se pudo verificar la caja inicial. Revisa tu conexión e intenta nuevamente.');
            actualizarValorEsperadoCajaInicial();
            ventaState.cajaInicialEsperada = null;
            setCajaInicialLoading(false);
            return null;
        }
    }

    async function guardarCajaInicial() {
        const fechaISO = obtenerFechaISOHoy();
        const { notasInput } = cajaInicialUI;

        // Calcular el total de las denominaciones
        const totalCalculado = calcularTotalDenominaciones();

        if (totalCalculado <= 0) {
            mostrarErrorCajaInicial('El monto total debe ser mayor a 0 para iniciar el día.');
            return;
        }

        // Verificar si hay desfase con respecto al valor esperado (cierre anterior)
        if (ventaState.cajaInicialEsperada && typeof ventaState.cajaInicialEsperada.monto === 'number') {
            const totalContado = totalCalculado;
            const totalEsperado = ventaState.cajaInicialEsperada.monto;
            const desfaseInicial = totalContado - totalEsperado;

            const denomsContadas = obtenerDenominaciones();
            const denomsEsperadas = ventaState.cajaInicialEsperada.denominaciones || {};
            const detalleHTML = generarDetalleDesfase(denomsContadas, denomsEsperadas);

            // Alertar si hay desfase en el TOTAL O si hay diferencias en DENOMINACIONES (detalleHTML no está vacío)
            if (Math.abs(desfaseInicial) > 0.01 || detalleHTML !== '') {
                const titulo = Math.abs(desfaseInicial) > 0.01 
                    ? '<i class="fas fa-exclamation-triangle"></i> Desfase en Apertura' 
                    : '<i class="fas fa-info-circle"></i> Cambio en Denominaciones';
                
                const mensajeBase = Math.abs(desfaseInicial) > 0.01
                    ? `El monto contado (${window.app.formatCurrency(totalContado)}) no coincide con el cierre anterior (${window.app.formatCurrency(totalEsperado)}).<br><br>Diferencia Total: <strong>${window.app.formatCurrency(desfaseInicial)}</strong>.`
                    : `El monto total coincide (${window.app.formatCurrency(totalContado)}), pero las denominaciones son distintas al cierre anterior.`;

                const confirm = await window.app.customConfirm(
                    titulo,
                    `${mensajeBase}${detalleHTML}<br>¿Deseas continuar con el registro?`,
                    [
                        { texto: 'Revisar Conteo', clase: 'btn-secondary', value: false },
                        { texto: 'Sí, Registrar', clase: 'btn-danger', value: true }
                    ]
                );

                if (!confirm) return;

                // Notificación de desfase (solo si hay diferencia de dinero o si el usuario quiere dejar constancia del cambio de piezas)
                await window.app.customConfirm(
                    '<i class="fas fa-envelope-open-text"></i> Notificación de Auditoría',
                    `Se notificará el estado de la apertura al administrador para su revisión periódica.`,
                    [{ texto: 'Entendido', clase: 'btn-primary' }]
                );
            }
        }

        limpiarMensajesCajaInicial();
        setCajaInicialLoading(true);

        try {
            const supabase = typeof getSupabaseClient === 'function' ? getSupabaseClient() : (typeof supabaseClient !== 'undefined' ? supabaseClient : null);
            if (!supabase) {
                throw new Error('No se pudo inicializar la conexión con la base de datos.');
            }

            const usuario = window.auth?.getCurrentUser?.();
            const email = window.auth?.getUserEmail?.() || usuario?.email || null;
            const nombres = window.auth?.getUserNombres?.() || '';
            const apellidos = window.auth?.getUserApellidos?.() || '';
            const nombreCompleto = `${nombres} ${apellidos}`.trim() || email;

            const montoNormalizado = Math.round(totalCalculado * 100) / 100;
            const denominaciones = obtenerDenominaciones();
            
            // Calcular desfase y detalle para guardar en DB
            let desfaseMonto = 0;
            let detalleDesfaseText = null;
            
            if (ventaState.cajaInicialEsperada) {
                desfaseMonto = montoNormalizado - (Number(ventaState.cajaInicialEsperada.monto) || 0);
                detalleDesfaseText = generarTextoDesfase(denominaciones, ventaState.cajaInicialEsperada.denominaciones);
            }

            const payload = {
                fecha: fechaISO,
                monto_inicial: montoNormalizado,
                ...denominaciones,
                desfase: Math.round(desfaseMonto * 100) / 100,
                detalle_desfase: detalleDesfaseText,
                observaciones: notasInput && notasInput.value ? notasInput.value.trim() || null : null,
                registrado_por: usuario?.id || null,
                registrado_por_email: email,
                registrado_por_nombre: nombreCompleto || null
            };

            const { data, error } = await supabase
                .from('ferre_caja_inicial')
                .upsert(payload, { onConflict: 'fecha' })
                .select()
                .maybeSingle();

            if (error) throw error;

            const montoEsperadoFinal = Number(ventaState.cajaInicialEsperada?.monto || 0);

            ventaState.cajaInicial = data;
            ventaState.cajaInicialFecha = data?.fecha || fechaISO;
            ventaState.cajaInicialVerificada = true;

            ocultarModalCajaInicial();
            limpiarDenominaciones();
            window.app.showToast('<i class="fas fa-door-open"></i> Caja inicial registrada correctamente.', 'success', 3000);

            // Enviar notificación a WhatsApp
            enviarNotificacionCaja('APERTURA', {
                montoContado: montoNormalizado,
                montoEsperado: montoEsperadoFinal,
                desfase: desfaseMonto,
                detalleDesfase: detalleDesfaseText,
                usuario: nombreCompleto
            });
        } catch (error) {
            console.error('Error al guardar caja inicial:', error);
            mostrarErrorCajaInicial(error.message || 'No se pudo guardar la caja inicial.');
            setCajaInicialLoading(false);
        }
    }

    // =====================================================
    // CIERRE DE CAJA DIARIA
    // =====================================================

    const cajaDiariaUI = {
        overlay: document.getElementById('modalCajaDiaria'),
        totalDenominaciones: document.getElementById('cierreTotalDenominaciones'),
        ventasEfectivo: document.getElementById('cierreVentasEfectivo'),
        movimientosExtras: document.getElementById('cierreMovimientosExtras'),
        montoInicial: document.getElementById('cierreMontoInicial'),
        totalEsperado: document.getElementById('cierreTotalEsperado'),
        totalContadoResumen: document.getElementById('cierreTotalContadoResumen'),
        desfase: document.getElementById('cierreDesfase'),
        desfaseWrapper: document.getElementById('desfaseWrapper'),
        notas: document.getElementById('cierreNotas'),
        submitBtn: document.getElementById('btnGuardarCierreCaja'),
        errorBox: document.getElementById('modalCajaDiariaError')
    };

    let datosCierreActual = {
        ventas: 0,
        ingresos: 0,
        egresos: 0,
        pagos_cxc: 0,
        transferencias_in: 0,
        transferencias_out: 0,
        proveedores: 0,
        gastos: 0,
        monto_inicial: 0,
        esperado: 0,
        contado: 0,
        desfase: 0
    };

    function setupCierreCajaModal() {
        const { submitBtn } = cajaDiariaUI;
        if (!submitBtn || submitBtn.dataset.listeners === 'ready') return;

        // Listeners para las denominaciones de cierre
        const inputs = document.querySelectorAll('.cierre-denom-input');
        inputs.forEach(input => {
            input.addEventListener('input', calcularTotalCierreDenominaciones);
        });

        submitBtn.addEventListener('click', () => {
            guardarCierreCaja();
        });

        submitBtn.dataset.listeners = 'ready';
    }

    function calcularTotalCierreDenominaciones() {
        const inputs = document.querySelectorAll('.cierre-denom-input');
        let total = 0;

        inputs.forEach(input => {
            const cantidad = parseInt(input.value) || 0;
            const valor = parseFloat(input.dataset.valor);
            const subtotal = cantidad * valor;
            
            const totalSpan = input.parentElement.querySelector('.cierre-denom-total');
            if (totalSpan) {
                totalSpan.textContent = window.app.formatCurrency(subtotal);
            }
            total += subtotal;
        });

        cajaDiariaUI.totalDenominaciones.textContent = window.app.formatCurrency(total);
        cajaDiariaUI.totalContadoResumen.textContent = window.app.formatCurrency(total);
        
        datosCierreActual.contado = total;
        actualizarCalculoDesfase();
    }

    function actualizarCalculoDesfase() {
        const desfase = datosCierreActual.contado - datosCierreActual.esperado;
        datosCierreActual.desfase = Math.round(desfase * 100) / 100;

        cajaDiariaUI.desfase.textContent = window.app.formatCurrency(datosCierreActual.desfase);
        
        cajaDiariaUI.desfaseWrapper.classList.remove('desfase-ok', 'desfase-error');
        if (Math.abs(datosCierreActual.desfase) < 0.01) {
            cajaDiariaUI.desfaseWrapper.classList.add('desfase-ok');
        } else {
            cajaDiariaUI.desfaseWrapper.classList.add('desfase-error');
        }
    }

    async function mostrarModalCierreCaja() {
        if (!ventaState.cajaInicial) {
            window.app.showToast('No puedes cerrar una caja que no ha sido iniciada.', 'error');
            return;
        }

        setupCierreCajaModal();
        cajaDiariaUI.overlay.classList.add('active');
        
        // Cargar datos reales de la BD para el cierre
        await cargarDatosParaCierre();
    }

    function ocultarModalCajaDiaria() {
        cajaDiariaUI.overlay.classList.remove('active');
        // Limpiar los campos para la próxima apertura
        const inputs = document.querySelectorAll('.cierre-denom-input');
        inputs.forEach(input => input.value = '');
        if (cajaDiariaUI.notas) cajaDiariaUI.notas.value = '';
        calcularTotalCierreDenominaciones();
    }

    async function cargarDatosParaCierre() {
        const supabase = getSupabaseClient();
        const fechaISO = obtenerFechaISOHoy();
        
        try {
            // 1. Obtener ventas en EFECTIVO del día
            const { data: ventas, error: eVentas } = await supabase
                .from('ferre_ventas')
                .select('total')
                .eq('fecha_venta', fechaISO)
                .eq('metodo_pago', 'EFECTIVO');
            
            if (eVentas) throw eVentas;
            const totalVentas = ventas.reduce((sum, v) => sum + Number(v.total), 0);

            // 2. Obtener movimientos de caja (ingresos/egresos)
            const { data: movs, error: eMovs } = await supabase
                .from('ferre_movimientos_caja')
                .select('tipo, monto')
                .eq('fecha', fechaISO);
            
            if (eMovs) throw eMovs;
            const ingresos = movs.filter(m => m.tipo === 'INGRESO').reduce((sum, m) => sum + Number(m.monto), 0);
            const egresos = movs.filter(m => m.tipo === 'EGRESO').reduce((sum, m) => sum + Number(m.monto), 0);

            // 3. Pagos de CxC en efectivo
            const { data: pagosCxC, error: eCxC } = await supabase
                .from('ferre_cuentas_por_cobrar_pagos')
                .select('monto_pago')
                .eq('fecha_pago', fechaISO)
                .eq('forma_pago', 'EFECTIVO');
            
            if (eCxC) throw eCxC;
            const totalCxC = pagosCxC.reduce((sum, p) => sum + Number(p.monto_pago), 0);

            // 4. Monto Inicial
            const montoInicial = Number(ventaState.cajaInicial.monto_inicial);

            // Cálculos finales
            datosCierreActual.ventas = totalVentas;
            datosCierreActual.ingresos = ingresos + totalCxC;
            datosCierreActual.egresos = egresos;
            datosCierreActual.monto_inicial = montoInicial;
            
            const movNeto = datosCierreActual.ingresos - datosCierreActual.egresos;
            datosCierreActual.esperado = Math.round((montoInicial + totalVentas + movNeto) * 100) / 100;

            // Actualizar UI
            cajaDiariaUI.ventasEfectivo.textContent = window.app.formatCurrency(totalVentas);
            cajaDiariaUI.movimientosExtras.textContent = window.app.formatCurrency(movNeto);
            cajaDiariaUI.montoInicial.textContent = window.app.formatCurrency(montoInicial);
            cajaDiariaUI.totalEsperado.textContent = window.app.formatCurrency(datosCierreActual.esperado);
            
            calcularTotalCierreDenominaciones();

        } catch (error) {
            console.error('Error al cargar datos de cierre:', error);
            window.app.showToast('Error al cargar datos financieros del día.', 'error');
        }
    }

    async function guardarCierreCaja() {
        if (Math.abs(datosCierreActual.desfase) > 0.01) {
            const confirm = await window.app.customConfirm(
                '<i class="fas fa-exclamation-triangle"></i> Desfase Detectado',
                `Existe un desfase de <strong>${window.app.formatCurrency(datosCierreActual.desfase)}</strong>. ¿Deseas registrar el cierre de todas formas?`,
                [
                    { texto: 'Revisar Conteo', clase: 'btn-secondary', value: false },
                    { texto: 'Sí, Registrar Desfase', clase: 'btn-danger', value: true }
                ]
            );
            
            if (!confirm) return;
            
            // Si hay desfase, mostrar la notificación personalizada que pidió el usuario
            await window.app.customConfirm(
                '<i class="fas fa-envelope-open-text"></i> Notificación de Desfase',
                `Se notificará el desfase de: <strong>${window.app.formatCurrency(datosCierreActual.desfase)}</strong> al administrador.`,
                [{ texto: 'Entendido', clase: 'btn-primary' }]
            );
        }

        const supabase = getSupabaseClient();
        const usuario = window.auth?.getCurrentUser?.();
        const email = window.auth?.getUserEmail?.() || usuario?.email || null;
        const nombreCompleto = `${window.auth?.getUserNombres?.() || ''} ${window.auth?.getUserApellidos?.() || ''}`.trim() || email;

        const denominacionesCierre = {
            billet_100: parseInt(document.getElementById('cierre_billet_100').value) || 0,
            billet_50: parseInt(document.getElementById('cierre_billet_50').value) || 0,
            billet_20: parseInt(document.getElementById('cierre_billet_20').value) || 0,
            billet_10: parseInt(document.getElementById('cierre_billet_10').value) || 0,
            billet_5: parseInt(document.getElementById('cierre_billet_5').value) || 0,
            billet_2: parseInt(document.getElementById('cierre_billet_2').value) || 0,
            billet_1: parseInt(document.getElementById('cierre_billet_1').value) || 0,
            moneda_1: parseInt(document.getElementById('cierre_moneda_1').value) || 0,
            moneda_050: parseInt(document.getElementById('cierre_moneda_050').value) || 0,
            moneda_025: parseInt(document.getElementById('cierre_moneda_025').value) || 0,
            moneda_010: parseInt(document.getElementById('cierre_moneda_010').value) || 0,
            moneda_005: parseInt(document.getElementById('cierre_moneda_005').value) || 0,
            moneda_001: parseInt(document.getElementById('cierre_moneda_001').value) || 0
        };

        const payload = {
            fecha: obtenerFechaISOHoy(),
            caja_inicial_id: ventaState.cajaInicial.id,
            ventas_totales: datosCierreActual.ventas,
            ingresos_total: datosCierreActual.ingresos,
            egresos_total: datosCierreActual.egresos,
            caja_fisica_esperada: datosCierreActual.esperado,
            caja_fisica_contada: datosCierreActual.contado,
            desfase: datosCierreActual.desfase,
            ...denominacionesCierre,
            observaciones: cajaDiariaUI.notas.value.trim() || null,
            cerrado_por: usuario?.id || null,
            cerrado_por_email: email,
            cerrado_por_nombre: nombreCompleto
        };

        try {
            const { error } = await supabase
                .from('ferre_caja_diaria')
                .upsert(payload, { onConflict: 'fecha' });

            if (error) throw error;

            // Enviar notificación a WhatsApp antes de recargar
            await enviarNotificacionCaja('CIERRE', {
                montoContado: payload.caja_fisica_contada,
                montoEsperado: payload.caja_fisica_esperada,
                desfase: payload.desfase,
                detalleDesfase: null, // No hay detalle de piezas en el cierre por ahora
                usuario: nombreCompleto,
                ventas: payload.ventas_totales,
                egresos: payload.egresos_total
            });

            window.app.showToast('Caja cerrada correctamente. Finalizando día...', 'success');
            ocultarModalCajaDiaria();
            
            // Opcional: Recargar la página o bloquear el POS
            setTimeout(() => {
                location.reload(); 
            }, 2000); // Dar un pequeño margen para que se vea el toast

        } catch (error) {
            console.error('Error al guardar cierre:', error);
            window.app.showToast('Error al guardar el cierre de caja.', 'error');
        }
    }

    // Control de actualizaciones automáticas
    let actualizacionTimer = null;
    let ultimaBusqueda = Date.now();
    let cargaInicialCompleta = false;
    let cargaClientesCompleta = false;

    // Cargar tokens de API para webservices
    async function cargarTokensAPI() {
        try {
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

            if (!db) {
                console.error('❌ Base de datos no disponible para cargar tokens');
                return false;
            }


            const { data, error } = await db
                .from('ferre_api')
                .select('service_name, webservices_token')
                .eq('is_active', true);

            if (error) {
                console.error('❌ Error cargando tokens API:', error);
                return false;
            }

            // Mapear tokens por nombre de servicio
            API_TOKENS = data.reduce((acc, item) => {
                acc[item.service_name] = item.webservices_token;
                return acc;
            }, {});

            return true;

        } catch (error) {
            console.error('❌ Error cargando tokens API:', error);
            return false;
        }
    }

    // Cargar clientes completo en cache
    async function cargarClientesCompleto() {
        if (window.clientesCache.cargando) return;

        window.clientesCache.cargando = true;

        try {
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

            if (!db) {
                console.error('❌ Base de datos no disponible para cargar clientes');
                return false;
            }

            const inicio = Date.now();

            const { data, error } = await db
                .from('ferre_clientes')
                .select('*')
                .order('razon_social');

            if (error) {
                console.error('❌ Error cargando clientes:', error);
                return false;
            }

            window.clientesCache.clientes = data || [];
            window.clientesCache.ultimaActualizacion = Date.now();
            window.clientesCache.version++;

            cargaClientesCompleta = true;
            return true;

        } catch (error) {
            console.error('❌ Error cargando clientes:', error);
            return false;
        } finally {
            window.clientesCache.cargando = false;
        }
    }

    // Consultar cédula en API externa
    async function consultarCedula(cedula) {
        try {
            const url = `https://webservices.ec/api/cedula/${cedula}`;
            const token = API_TOKENS['webservices_cedula'];

            if (!token) {
                throw new Error('Token de cédula no configurado');
            }

            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('Error consultando cédula:', error);
            return null;
        }
    }

    // Consultar RUC en API externa
    async function consultarRuc(ruc) {
        try {
            const url = `https://webservices.ec/api/ruc/${ruc}`;
            const token = API_TOKENS['webservices_ruc'];

            if (!token) {
                throw new Error('Token de RUC no configurado');
            }

            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('Error consultando RUC:', error);
            return null;
        }
    }

    // Cargar inventario completo al inicializar
    async function cargarInventarioCompleto() {
        if (window.inventarioCache.cargando) return;

        window.inventarioCache.cargando = true;

        // Mostrar indicador de carga
        const loadingCache = document.getElementById('loadingCache');
        if (loadingCache) {
            loadingCache.style.display = 'block';
        }

        try {
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

            if (!db) {
                console.error('❌ Base de datos no disponible');
                return false;
            }

            const inicio = Date.now();

            const { data, error } = await db
                .from('ferre_inventario')
                .select('*')
                .order('producto');

            if (error) {
                console.error('❌ Error cargando inventario:', error);
                return false;
            }

            window.inventarioCache.productos = data || [];
            window.inventarioCache.ultimaActualizacion = Date.now();
            window.inventarioCache.version++;

            cargaInicialCompleta = true;
            actualizarIndicadorCache();

            return true;

        } catch (error) {
            console.error('❌ Error cargando inventario:', error);
            return false;
        } finally {
            window.inventarioCache.cargando = false;

            // Ocultar indicador de carga
            const loadingCache = document.getElementById('loadingCache');
            if (loadingCache) {
                loadingCache.style.display = 'none';
            }
        }
    }

    // Actualizar caché silenciosamente en background
    async function actualizarCacheSilencioso() {
        try {
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

            const { data, error } = await db
                .from('ferre_inventario')
                .select('*')
                .order('producto');

            if (!error && data) {
                window.inventarioCache.productos = data;
                window.inventarioCache.ultimaActualizacion = Date.now();
                window.inventarioCache.version++;
                console.log('🔄 Caché actualizado:', data.length, 'productos');
                actualizarIndicadorCache();
            }
        } catch (error) {
            console.error('⚠️ Error actualizando caché:', error);
        }
    }

    // Iniciar actualizaciones periódicas
    function iniciarActualizacionesPeriodicas() {
        if (actualizacionTimer) return; // Ya está activo

        console.log('▶️ Iniciando actualizaciones automáticas (cada 60s)');

        // Actualizar badge cada 5 segundos para mostrar tiempo transcurrido
        setInterval(() => {
            if (cargaInicialCompleta) {
                actualizarIndicadorCache();
            }
        }, 5000);

        actualizacionTimer = setInterval(async () => {
            // Si hace más de 60 seg sin buscar → detener
            const tiempoInactivo = Date.now() - ultimaBusqueda;

            if (tiempoInactivo > 60000) {
                clearInterval(actualizacionTimer);
                actualizacionTimer = null;
                console.log('⏸️ Actualizaciones pausadas (60s de inactividad)');
                return;
            }

            // Actualizar caché en background
            await actualizarCacheSilencioso();
        }, 60000); // Cada 60 segundos
    }

    // Detener actualizaciones
    function detenerActualizacionesPeriodicas() {
        if (actualizacionTimer) {
            clearInterval(actualizacionTimer);
            actualizacionTimer = null;
            console.log('⏹️ Actualizaciones detenidas');
        }
    }

    // Actualizar indicador visual de última actualización
    function actualizarIndicadorCache() {
        const searchResults = document.getElementById('searchResults');
        if (!searchResults) return;

        // Agregar badge de caché si no existe
        let badge = document.getElementById('cache-badge');
        if (!badge) {
            badge = document.createElement('div');
            badge.id = 'cache-badge';
            badge.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(212, 160, 23, 0.1);
                border: 1px solid rgba(212, 160, 23, 0.3);
                color: #d4a017;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.75em;
                display: flex;
                align-items: center;
                gap: 4px;
                z-index: 10;
            `;
            const searchCard = searchResults.closest('.card');
            if (searchCard) {
                searchCard.style.position = 'relative';
                searchCard.appendChild(badge);
            }
        }

        if (window.inventarioCache.ultimaActualizacion) {
            const ahora = Date.now();
            const diff = Math.floor((ahora - window.inventarioCache.ultimaActualizacion) / 1000);
            const tiempo = diff < 60 ? `${diff}s` : `${Math.floor(diff / 60)}m`;
            badge.innerHTML = `<i class="fas fa-database"></i> ${window.inventarioCache.productos.length} productos (${tiempo})`;
        }
    }

    // Buscar en caché local (instantáneo)
    function buscarEnCache(query) {
        if (!window.inventarioCache.productos || window.inventarioCache.productos.length === 0) {
            return [];
        }

        const queryLower = query.toLowerCase().trim();
        const palabras = queryLower.split(/\s+/).filter(p => p.length > 0);

        // Verificar si es búsqueda numérica de 4+ dígitos
        const esNumerico = /^\d+$/.test(query.trim());
        const longitudNumeros = query.trim().length;

        let resultados = [];

        if (esNumerico && longitudNumeros >= 4) {
            // Búsqueda por código que empiece con los dígitos
            resultados = window.inventarioCache.productos.filter(p =>
                p.codigo.toLowerCase().startsWith(queryLower)
            );
        } else if (palabras.length === 1) {
            // Una sola palabra: buscar en código O producto
            const palabra = palabras[0];
            resultados = window.inventarioCache.productos.filter(p => {
                const producto = p.producto.toLowerCase();
                const codigo = p.codigo.toLowerCase();
                return producto.includes(palabra) || codigo.includes(palabra);
            });
        } else {
            // Múltiples palabras: TODAS deben estar en el producto o código
            resultados = window.inventarioCache.productos.filter(p => {
                const producto = p.producto.toLowerCase();
                const codigo = p.codigo.toLowerCase();

                // Verificar que TODAS las palabras estén presentes
                return palabras.every(palabra =>
                    producto.includes(palabra) || codigo.includes(palabra)
                );
            });
        }

        // Ordenar resultados por relevancia
        resultados.sort((a, b) => {
            const codigoA = a.codigo.toLowerCase();
            const codigoB = b.codigo.toLowerCase();
            const nombreA = a.producto.toLowerCase();
            const nombreB = b.producto.toLowerCase();

            // Prioridad 1: Coincidencia exacta de código
            const exactoCodigoA = codigoA === queryLower;
            const exactoCodigoB = codigoB === queryLower;
            if (exactoCodigoA && !exactoCodigoB) return -1;
            if (!exactoCodigoA && exactoCodigoB) return 1;

            // Prioridad 2: Código que empieza con el query
            const empiezaCodigoA = codigoA.startsWith(queryLower);
            const empiezaCodigoB = codigoB.startsWith(queryLower);
            if (empiezaCodigoA && !empiezaCodigoB) return -1;
            if (!empiezaCodigoA && empiezaCodigoB) return 1;

            // Prioridad 3: Coincidencia exacta de nombre
            const exactoNombreA = nombreA === queryLower;
            const exactoNombreB = nombreB === queryLower;
            if (exactoNombreA && !exactoNombreB) return -1;
            if (!exactoNombreA && exactoNombreB) return 1;

            // Prioridad 4: Nombre que empieza con el query
            const empiezaNombreA = nombreA.startsWith(queryLower);
            const empiezaNombreB = nombreB.startsWith(queryLower);
            if (empiezaNombreA && !empiezaNombreB) return -1;
            if (!empiezaNombreA && empiezaNombreB) return 1;

            // Por defecto: orden alfabético
            return codigoA.localeCompare(codigoB);
        });

        // Limitar a 50 resultados
        return resultados.slice(0, 50);
    }

    // Guardar carrito en localStorage
    function guardarCarritoEnCache() {
        try {
            const data = {
                carrito: ventaState.carrito,
                clienteSeleccionado: ventaState.clienteSeleccionado,
                tipoComprobante: ventaState.tipoComprobante,
                fecha: new Date().toISOString()
            };
            localStorage.setItem('ferreteria_carrito', JSON.stringify(data));
        } catch (error) {
        }
    }

    // Limpiar caché del carrito
    function limpiarCarritoCache() {
        try {
            localStorage.removeItem('ferreteria_carrito');
        } catch (error) {
        }
    }

    // Sistema de confirmación personalizado
    function mostrarConfirmacion(titulo = 'Confirmación', mensaje, botones = null) {
        return new Promise((resolve) => {
            const overlay = document.getElementById('customConfirmOverlay');
            const titleEl = document.getElementById('customConfirmTitle');
            const messageEl = document.getElementById('customConfirmMessage');
            const buttonsContainer = document.getElementById('customConfirmButtons');

            // Si no se pasaron botones personalizados, usar los por defecto
            if (!botones) {
                const cancelBtn = document.getElementById('customConfirmCancel');
                const okBtn = document.getElementById('customConfirmOk');

                titleEl.innerHTML = `<i class="fas fa-question-circle"></i><span>${titulo}</span>`;
                messageEl.innerHTML = mensaje;

                // Mostrar botones por defecto
                cancelBtn.style.display = 'block';
                okBtn.style.display = 'block';

                // Mostrar overlay
                overlay.classList.add('active');

                const handleConfirm = () => {
                    overlay.classList.remove('active');
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    overlay.classList.remove('active');
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    okBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    document.removeEventListener('keydown', handleKeys);
                };

                okBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);

                // ESC para cancelar, Enter para confirmar
                const handleKeys = (e) => {
                    if (e.key === 'Escape') {
                        handleCancel();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        handleConfirm();
                    }
                };
                document.addEventListener('keydown', handleKeys);
            } else {
                // Usar botones personalizados
                titleEl.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${titulo}</span>`;
                messageEl.innerHTML = mensaje;

                // Crear botones personalizados
                buttonsContainer.innerHTML = '';

                botones.forEach((boton, index) => {
                    const btn = document.createElement('button');
                    // Asegurar que siempre tenga la clase base custom-confirm-btn
                    const clases = boton.clase || 'custom-confirm-btn-confirm';
                    btn.className = clases.includes('custom-confirm-btn') ? clases : `custom-confirm-btn ${clases}`;
                    btn.innerHTML = boton.texto;
                    btn.style.cssText = 'white-space: nowrap;'; // Evitar que el texto se rompa
                    btn.onclick = () => {
                        overlay.classList.remove('active');
                        document.removeEventListener('keydown', handleKeys);
                        if (boton.callback) boton.callback();
                        resolve(boton.value !== undefined ? boton.value : true);
                    };
                    buttonsContainer.appendChild(btn);
                });

                // Mostrar overlay
                overlay.classList.add('active');

                // ESC para cerrar, Enter para confirmar el primer botón (usualmente el principal)
                const handleKeys = (e) => {
                    if (e.key === 'Escape') {
                        overlay.classList.remove('active');
                        document.removeEventListener('keydown', handleKeys);
                        resolve(false);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        // Ejecutar el primer botón que sea de tipo "confirm", "primary" o "danger"
                        const confirmButton = botones.find(b =>
                            b.clase && (b.clase.includes('primary') || b.clase.includes('confirm') || b.clase.includes('danger') || b.clase.includes('btn-accent'))
                        ) || botones[0];
                        overlay.classList.remove('active');
                        document.removeEventListener('keydown', handleKeys);
                        if (confirmButton.callback) confirmButton.callback();
                        resolve(confirmButton.value !== undefined ? confirmButton.value : true);
                    }
                };
                document.addEventListener('keydown', handleKeys);
            }
        });
    }

    // Vincular al objeto global app para evitar errores de referencia
    if (window.app) {
        window.app.customConfirm = mostrarConfirmacion;
    }

    // =====================================================
    // FUNCIONES AUXILIARES
    // =====================================================

    // Calcular stock restante considerando el carrito
    function calcularStockRestante(codigo, stockTotal) {
        const itemEnCarrito = ventaState.carrito.find(item => item.codigo === codigo);
        if (!itemEnCarrito) {
            return stockTotal;
        }
        return stockTotal - itemEnCarrito.cantidad;
    }

    // =====================================================
    // NOTIFICACIONES WHATSAPP
    // =====================================================

    async function enviarNotificacionCaja(tipo, datos) {
        try {
            const db = window.app ? window.app.db : (typeof getSupabaseClient === 'function' ? getSupabaseClient() : null);
            if (!db) return;

            const { data: ferredatos, error } = await db
                .from('ferre_ferredatos')
                .select('*')
                .limit(1)
                .single();

            if (error || !ferredatos) {
                console.error('Configuración de WhatsApp no disponible para notificaciones de caja');
                return;
            }

            const { montoContado, montoEsperado, desfase, detalleDesfase, usuario, ventas, egresos } = datos;
            const absDesfase = Math.abs(desfase);
            const tieneDesfaseMonto = absDesfase > 0.01;
            const tieneDesfaseDenom = detalleDesfase && detalleDesfase !== '';

            let titulo = tipo === 'APERTURA' ? '🏁 *APERTURA DE CAJA*' : '🔒 *CIERRE DE CAJA*';
            let mensajeAlerta = '';
            let recomendacion = '';

            if (!tieneDesfaseMonto && !tieneDesfaseDenom) {
                mensajeAlerta = '✅ *ESTADO: CORRECTO*\n🎊 ¡Felicitaciones! La caja cuadra perfectamente.';
            } else if (tieneDesfaseMonto) {
                const alerta = obtenerNivelAlerta(desfase);
                const tipoDesfase = desfase < 0 ? 'FALTANTE' : 'SOBRANTE';
                mensajeAlerta = `${alerta.icono} *ESTADO: ${alerta.nivel} (${tipoDesfase})*`;
                
                if (desfase > 0) {
                    recomendacion = '\n\n💡 *Recomendación:* Revisar por qué hay un sobrante de dinero. Podrían ser ventas no registradas o errores en vueltos.';
                }
            } else if (tieneDesfaseDenom) {
                mensajeAlerta = '⚠️ *ESTADO: DIFERENCIA SOLO EN DENOMINACIONES*\nEl monto total cuadra, pero se detectó un cambio en la composición física del efectivo.';
            }

            const format = (v) => window.app ? window.app.formatCurrency(v) : `$${(v || 0).toFixed(2)}`;
            const fechaFormateada = new Date().toLocaleDateString('es-EC', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const horaFormateada = new Date().toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' });

            // Bloque dinámico para ventas y egresos si es cierre
            let resumenOperativo = '';
            if (tipo === 'CIERRE') {
                resumenOperativo = `
📈 *Ventas Totales:* ${format(ventas)}
📉 *Egresos Totales:* ${format(egresos)}`;
            }

            const texto = `${titulo}

${mensajeAlerta}

📅 *Fecha:* ${fechaFormateada}
🕐 *Hora:* ${horaFormateada}
${resumenOperativo}

💰 *Monto Contado:* ${format(montoContado)}
📊 *Monto Esperado:* ${format(montoEsperado)}
⚖️ *Diferencia:* ${format(desfase)}

${tieneDesfaseDenom ? `📝 *Detalle de Diferencias:*\n${detalleDesfase}` : ''}${recomendacion}

👤 *Usuario:* ${usuario}
_Sistema de Gestión Ferrisoluciones_`;

            const url = `https://api.ferrisoluciones.com/message/sendText/${ferredatos.instance}`;

            await fetch(url, {
                method: 'POST',
                headers: {
                    'apikey': ferredatos.apikey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    number: ferredatos.number,
                    text: texto,
                    delay: 1000,
                    linkPreview: false
                })
            });

        } catch (error) {
            console.error('Error enviando notificación de caja:', error);
        }
    }

    function obtenerNivelAlerta(desfase) {
        const absDesfase = Math.abs(desfase);
        if (desfase < 0) { // Faltante
            if (absDesfase <= 5) return { nivel: 'PRESTAR ATENCIÓN', icono: '⚠️' };
            if (absDesfase <= 10) return { nivel: 'PREOCUPANTE', icono: '😟' };
            if (absDesfase <= 20) return { nivel: 'GRAVE', icono: '🔴' };
            return { nivel: 'CRÍTICO', icono: '💀' };
        } else { // Sobrante
            if (absDesfase <= 5) return { nivel: 'REVISAR', icono: '🔍' };
            if (absDesfase <= 20) return { nivel: 'PRESTAR ATENCIÓN', icono: '⚠️' };
            if (absDesfase <= 50) return { nivel: 'GRAVE', icono: '🔴' };
            return { nivel: 'CRÍTICO', icono: '💀' };
        }
    }

    // =====================================================
    // MODO EDICIÓN
    // =====================================================

    function toggleModoEdicion() {
        ventaState.modoEdicion = !ventaState.modoEdicion;

        const badge = document.getElementById('editModeBadge');
        const carritoCard = document.getElementById('carritoCard');
        const carritoColumn = document.getElementById('carritoColumn');

        if (ventaState.modoEdicion) {
            // Activar modo edición
            badge.classList.add('active');
            carritoCard.classList.add('carrito-edit-mode');
            ventaState.indiceSeleccionado = ventaState.carrito.length > 0 ? 0 : -1;
            ventaState.busquedaSeleccionado = -1;
            actualizarCarrito();

            // Scroll al inicio del carrito
            if (carritoColumn) {
                carritoColumn.scrollTo({ top: 0, behavior: 'smooth' });
            }
        } else {
            // Desactivar modo edición
            badge.classList.remove('active');
            carritoCard.classList.remove('carrito-edit-mode');
            ventaState.indiceSeleccionado = -1;
            actualizarCarrito();

            // Scroll al inicio del carrito
            if (carritoColumn) {
                carritoColumn.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
    }

    function navegarCarrito(direccion) {
        if (ventaState.carrito.length === 0) return;

        ventaState.indiceSeleccionado += direccion;

        // Limitar índice
        if (ventaState.indiceSeleccionado < 0) {
            ventaState.indiceSeleccionado = ventaState.carrito.length - 1;
        } else if (ventaState.indiceSeleccionado >= ventaState.carrito.length) {
            ventaState.indiceSeleccionado = 0;
        }

        actualizarCarrito();

        // Hacer scroll al elemento seleccionado
        const rows = document.querySelectorAll('#carritoBody tr');
        if (rows[ventaState.indiceSeleccionado]) {
            rows[ventaState.indiceSeleccionado].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function navegarBusqueda(direccion) {
        if (ventaState.busquedaResultados.length === 0) return;

        ventaState.busquedaSeleccionado += direccion;

        // Limitar índice
        if (ventaState.busquedaSeleccionado < 0) {
            ventaState.busquedaSeleccionado = ventaState.busquedaResultados.length - 1;
        } else if (ventaState.busquedaSeleccionado >= ventaState.busquedaResultados.length) {
            ventaState.busquedaSeleccionado = 0;
        }

        // Pasar skipAutoScroll=true para evitar conflicto con scroll manual
        mostrarResultadosBusqueda(ventaState.busquedaResultados, true);

        // Hacer scroll al elemento seleccionado
        const items = document.querySelectorAll('.search-result-item');
        if (items[ventaState.busquedaSeleccionado]) {
            items[ventaState.busquedaSeleccionado].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function ajustarCantidad(delta) {
        if (ventaState.indiceSeleccionado < 0 || ventaState.indiceSeleccionado >= ventaState.carrito.length) {
            return;
        }

        const item = ventaState.carrito[ventaState.indiceSeleccionado];
        const nuevaCantidad = item.cantidad + delta;

        // Validar límites
        if (nuevaCantidad <= 0) {
            window.app.showToast('Usa la X para eliminar el producto', 'warning', 2000);
            return;
        }

        if (nuevaCantidad > item.stock) {
            window.app.showToast('No hay suficiente stock disponible', 'warning', 2000);
            return;
        }

        item.cantidad = nuevaCantidad;
        actualizarCarrito();
        guardarCarritoEnCache();
    }

    // =====================================================
    // INICIALIZACIÓN
    // =====================================================

    async function initPuntoVenta() {
        // Resetear guards de eventos para permitir re-vinculación al recargar módulo
        window._clienteBusquedaListenerAdded = false;
        
        setupCajaInicialModal();
        await verificarCajaInicialDelDia({ forceConsulta: true });

        // Cargar carrito desde caché y actualizar vista
        actualizarCarrito();

        // Event listeners
        setupEventListeners();

        // Cargar datos en background

        // Cargar tokens API primero
        cargarTokensAPI();

        // Cargar inventario y clientes en paralelo
        Promise.all([
            cargarInventarioCompleto(),
            cargarClientesCompleto()
        ]).then(([exitoInventario, exitoClientes]) => {
            if (exitoInventario && exitoClientes) {

            }
        });

        // Focus en búsqueda después de configurar listeners
        setTimeout(() => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.focus();
            }
        }, 100);
    }

    function setupEventListeners() {
        // Listener explícito para el botón de simulación
        const btnSimulacion = document.getElementById('btnSimularTransferencia');
        if (btnSimulacion) {
            btnSimulacion.onclick = function (e) {
                e.preventDefault();
                console.log('Click en botón simulación');
                abrirModalSimulacion();
            };
        }

        // Atajos de teclado globales - Evitar duplicados
        if (!window._puntoVentaKeydownListenerAdded) {
            document.addEventListener('keydown', function (e) {
                // Verificar que el módulo esté activo
                if (!document.getElementById('searchInput')) return;

                // Verificar si hay algún modal abierto
                const modalCantidad = document.getElementById('modalCantidadOverlay');
                const modalVenta = document.getElementById('modalVenta');
                const modalCredito = document.getElementById('modalCreditoVenta');
                const customConfirm = document.getElementById('custom-confirm-overlay');
                const modalActualizarCliente = document.getElementById('modalActualizarCliente');
                const modalRegistroCliente = document.getElementById('modalRegistroCliente');
                const modalCajaInicial = document.getElementById('modalCajaInicial');

                const hayModalAbierto = (modalCantidad && modalCantidad.classList.contains('active')) ||
                    (modalVenta && modalVenta.classList.contains('active')) ||
                    (modalCredito && modalCredito.classList.contains('active')) ||
                    (customConfirm && customConfirm.classList.contains('active')) ||
                    (modalActualizarCliente && modalActualizarCliente.classList.contains('active')) ||
                    (modalRegistroCliente && modalRegistroCliente.classList.contains('active')) ||
                    (modalCajaInicial && modalCajaInicial.classList.contains('active'));

                // ESC cierra modales
                if (e.key === 'Escape') {
                    if (modalCajaInicial && modalCajaInicial.classList.contains('active')) {
                        e.preventDefault();
                        return;
                    }
                    if (modalRegistroCliente && modalRegistroCliente.classList.contains('active')) {
                        e.preventDefault();
                        cerrarModalRegistroCliente();
                        return;
                    }
                    if (modalActualizarCliente && modalActualizarCliente.classList.contains('active')) {
                        e.preventDefault();
                        cerrarModalActualizarCliente();
                        return;
                    }
                    if (modalCantidad && modalCantidad.classList.contains('active')) {
                        e.preventDefault();
                        cerrarModalCantidad();
                        return;
                    }
                }

                // Si hay modal abierto, no procesar teclas de atajo
                if (hayModalAbierto && e.key !== 'Escape') {
                    return;
                }

                // F1 - Procesar Venta
                if (e.key === 'F1') {
                    e.preventDefault();
                    if (ventaState.carrito.length > 0) {
                        procesarVenta();
                    } else {
                        window.app.showToast('<i class="fas fa-exclamation-triangle"></i> El carrito está vacío. Agrega productos para continuar.', 'warning', 3000);
                    }
                }
                // F9 - Enviar a cuentas por cobrar
                if (e.key === 'F9') {
                    e.preventDefault();
                    procesarVentaCredito();
                }
                // Suprimir (Delete) - Eliminar el último producto agregado al carrito
                if (e.key === 'Delete') {
                    if (ventaState.carrito.length > 0) {
                        e.preventDefault();
                        eliminarDelCarrito(ventaState.carrito[0].codigo);
                    }
                }
                // F3 - Toggle búsqueda de cliente (activar/desactivar)
                if (e.key === 'F3') {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleBusquedaCliente();
                }

                // Tab - Siempre enfoca búsqueda de productos
                if (e.key === 'Tab') {
                    const clienteBusquedaBox = document.getElementById('clienteBusquedaBox');
                    const searchInput = document.getElementById('searchInput');

                    // Si no hay ningún modal abierto y Tab está disponible
                    if (!hayModalAbierto && searchInput) {
                        e.preventDefault();
                        searchInput.focus();
                        searchInput.select();
                    }
                }
                // F10 - Limpiar Venta
                if (e.key === 'F10') {
                    e.preventDefault();
                    e.stopPropagation();
                    limpiarVenta();
                }
                // F2 - Toggle Modo Edición
                if (e.key === 'F2') {
                    e.preventDefault();
                    toggleModoEdicion();
                }

                // Navegación con flechas
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    if (ventaState.modoEdicion) {
                        // Navegar en carrito
                        e.preventDefault();
                        navegarCarrito(e.key === 'ArrowDown' ? 1 : -1);
                    } else {
                        // Navegar en resultados de búsqueda
                        if (ventaState.busquedaResultados.length > 0) {
                            e.preventDefault();
                            navegarBusqueda(e.key === 'ArrowDown' ? 1 : -1);
                        }
                    }
                }

                // + y - para ajustar cantidad (solo en modo edición)
                if (ventaState.modoEdicion && ventaState.indiceSeleccionado >= 0) {
                    if (e.key === '+' || e.key === '=') {
                        e.preventDefault();
                        ajustarCantidad(1);
                    } else if (e.key === '-' || e.key === '_') {
                        e.preventDefault();
                        ajustarCantidad(-1);
                    }
                }

                // Enter para agregar desde búsqueda (solo cuando no está en modo edición)
                if (e.key === 'Enter' && !ventaState.modoEdicion) {
                    const searchInput = document.getElementById('searchInput');
                    if (document.activeElement === searchInput) {
                        return; // Dejar que el otro handler lo maneje
                    }
                    // Si hay un resultado seleccionado en búsqueda, agregarlo
                    if (ventaState.busquedaSeleccionado >= 0 && ventaState.busquedaResultados[ventaState.busquedaSeleccionado]) {
                        e.preventDefault();
                        const producto = ventaState.busquedaResultados[ventaState.busquedaSeleccionado];
                        agregarProducto(producto.codigo);
                    }
                }
            });
            window._puntoVentaKeydownListenerAdded = true;
        }

        // Listeners adicionales (modal crédito + búsqueda)
        setupCreditoVentaListeners();

        // Búsqueda de productos (con debounce)
        const searchInput = document.getElementById('searchInput');

        if (!searchInput) {
            return;
        }

        // Al hacer focus, iniciar actualizaciones y cargar caché si es necesario
        searchInput.addEventListener('focus', async function () {
            if (!cargaInicialCompleta) {
                await cargarInventarioCompleto();
            }
            iniciarActualizacionesPeriodicas();
        });

        // Input con debounce inteligente (solo para fallback a BD)
        let debounceTimer;
        let currentSearchId = 0;

        searchInput.addEventListener('input', function (e) {
            let valor = e.target.value;
            clearTimeout(debounceTimer);

            // SUPRIMIR 0 INICIAL: Si son 5+ dígitos numéricos que empiezan con 0, quitarlo
            if (/^0\d{4,}$/.test(valor.trim())) {
                const codigoLimpio = valor.trim().replace(/^0+/, '') || '0';
                e.target.value = codigoLimpio;
                valor = codigoLimpio;
                console.log(`🧮 Código limpiado: ${valor.trim()} → ${codigoLimpio}`);
            }

            // Si está vacío, limpiar resultados inmediatamente
            if (!valor || valor.trim().length === 0) {
                document.getElementById('searchResults').innerHTML = '';
                ventaState.busquedaResultados = [];
                ventaState.busquedaSeleccionado = -1;
                return;
            }

            // Resetear selección cuando cambia el texto
            ventaState.busquedaSeleccionado = -1;

            // Detectar si es búsqueda por código (4+ dígitos numéricos)
            const esCodigoNumerico = /^\d{4,}$/.test(valor.trim());

            // Si hay caché disponible O es código numérico → búsqueda instantánea (sin debounce)
            if (cargaInicialCompleta || esCodigoNumerico) {
                currentSearchId++;
                window.currentSearchId = currentSearchId;
                const searchId = currentSearchId;
                buscarProductos(valor, searchId);
            } else {
                // Si no hay caché y es búsqueda alfanumérica → usar debounce corto (100ms)
                debounceTimer = setTimeout(function () {
                    currentSearchId++;
                    window.currentSearchId = currentSearchId;
                    const searchId = currentSearchId;
                    buscarProductos(valor, searchId);
                }, 100);
            }
        });

        searchInput.addEventListener('keydown', async function (e) {
            // Si hay algún modal abierto, no procesar Shift o Enter
            const modalCantidad = document.getElementById('modalCantidadOverlay');
            const modalVenta = document.getElementById('modalVenta');
            const customConfirm = document.getElementById('custom-confirm-overlay');

            const hayModalAbierto = (modalCantidad && modalCantidad.classList.contains('active')) ||
                (modalVenta && modalVenta.classList.contains('active')) ||
                (customConfirm && customConfirm.classList.contains('active'));

            // Si se presiona SOLO Alt (sin otra tecla), abrir modal de ingreso con cantidad pre-definida
            if (e.key === 'Alt' && !hayModalAbierto) {
                const valor = e.target.value.trim();

                // Si el campo tiene números, usar como cantidad
                if (valor && /^\d+(\.\d+)?$/.test(valor)) {
                    e.preventDefault();

                    const cantidad = parseFloat(valor);

                    if (cantidad > 0) {
                        // Limpiar campo de búsqueda y resultados
                        e.target.value = '';
                        document.getElementById('searchResults').innerHTML = '';
                        ventaState.busquedaResultados = [];
                        ventaState.busquedaSeleccionado = -1;

                        // Abrir modal con cantidad pre-definida
                        mostrarModalIngresoDirecto('', cantidad);
                        setTimeout(() => {
                            document.getElementById('modalIngresoCodigoInput').focus();
                        }, 150);
                    }
                }
                return;
            }

            // Si se presiona SOLO Shift (sin otra tecla), abrir modal de cantidad rápida
            if (e.key === 'Shift' && !hayModalAbierto) {
                const valor = e.target.value.trim();

                if (valor) {
                    // Si hay un producto seleccionado en los resultados
                    if (ventaState.busquedaResultados.length > 0 && ventaState.busquedaSeleccionado >= 0) {
                        const productoSeleccionado = ventaState.busquedaResultados[ventaState.busquedaSeleccionado];
                        if (productoSeleccionado) {
                            mostrarModalCantidadRapida(productoSeleccionado);
                            return;
                        }
                    }

                    // Si es solo números, buscar el producto por código
                    if (!/\D/.test(valor)) {
                        try {
                            // Buscar primero en caché
                            let producto = null;
                            if (cargaInicialCompleta && window.inventarioCache.productos) {
                                producto = window.inventarioCache.productos.find(p => p.codigo === valor);
                            }

                            // Si no está en caché, buscar en BD
                            if (!producto) {
                                const db = window.app.db;
                                const { data, error } = await db
                                    .from('ferre_inventario')
                                    .select('*')
                                    .eq('codigo', valor)
                                    .single();

                                if (!error && data) {
                                    producto = data;
                                }
                            }

                            if (producto) {
                                mostrarModalCantidadRapida(producto);
                                return;
                            }
                        } catch (error) {
                        }
                    }
                }
                return;
            }

            if (e.key === 'Enter' && !hayModalAbierto) {
                const valor = e.target.value.trim();
                // Si hay resultados de búsqueda y uno está seleccionado, usar ese
                if (valor && ventaState.busquedaResultados.length > 0 && ventaState.busquedaSeleccionado >= 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    const productoSeleccionado = ventaState.busquedaResultados[ventaState.busquedaSeleccionado];
                    if (productoSeleccionado) {
                        await agregarProducto(productoSeleccionado.codigo);
                        return;
                    }
                }
            }
        });

        // Enfocar el campo
        searchInput.focus();

        // Búsqueda de cliente
        const clienteCedula = document.getElementById('clienteCedula');
        if (clienteCedula) {
            clienteCedula.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarCliente();
                }
            });
        }

        // Tipo de comprobante
        const tipoComprobante = document.getElementById('tipoComprobante');
        if (tipoComprobante) {
            tipoComprobante.addEventListener('change', function (e) {
                ventaState.tipoComprobante = e.target.value;
            });
        }

        // Modal de cantidad rápida - Confirmar con Enter
        const modalCantidadInput = document.getElementById('modalCantidadInput');
        if (modalCantidadInput) {
            modalCantidadInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation(); // Evitar que se propague al searchInput
                    confirmarCantidadRapida();
                }
            });

            modalCantidadInput.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.stopPropagation(); // Evitar propagación
                    cerrarModalCantidad();
                }
            });
        }

        // Modal de garantía - Confirmar con Enter
        const garantiaPeriodoInput = document.getElementById('garantiaPeriodo');
        if (garantiaPeriodoInput) {
            garantiaPeriodoInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    generarGarantia();
                }
            });
        }

        // Modal de actualización de cliente - Confirmar con Enter
        const modalActualizarClienteInputs = [
            document.getElementById('updateClienteNombre'),
            document.getElementById('updateClienteDireccion'),
            document.getElementById('updateClienteTelefono'),
            document.getElementById('updateClienteCorreo')
        ].filter(input => input !== null);

        modalActualizarClienteInputs.forEach(input => {
            input.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    confirmarActualizacionCliente();
                }
            });
        });

        // Event listener para mostrar/ocultar botones de correo en modal actualizar
        const updateClienteCorreoInput = document.getElementById('updateClienteCorreo');
        if (updateClienteCorreoInput) {
            updateClienteCorreoInput.addEventListener('input', function () {
                const btnNoCorreo = document.getElementById('btnNoCorreoUpdate');
                const btnComprobarCorreo = document.getElementById('btnComprobarCorreoUpdate');

                if (this.value.trim()) {
                    if (btnNoCorreo) btnNoCorreo.style.display = 'none';
                    if (btnComprobarCorreo) btnComprobarCorreo.style.display = 'inline-flex';
                } else {
                    if (btnNoCorreo) btnNoCorreo.style.display = 'inline-flex';
                    if (btnComprobarCorreo) btnComprobarCorreo.style.display = 'none';
                }
            });

            // Event listener para validar correo cuando se pierde el foco
            updateClienteCorreoInput.addEventListener('blur', function (e) {
                manejarValidacionCorreo(e, 'updateClienteCorreoError');
            });
        }

        // Event listener para mostrar/ocultar botones de correo en modal registro
        const nuevoClienteCorreoInput = document.getElementById('nuevoClienteCorreo');
        if (nuevoClienteCorreoInput) {
            nuevoClienteCorreoInput.addEventListener('input', function () {
                const btnNoCorreo = document.getElementById('btnNoCorreo');
                const btnComprobarCorreo = document.getElementById('btnComprobarCorreo');

                if (this.value.trim()) {
                    if (btnNoCorreo) btnNoCorreo.style.display = 'none';
                    if (btnComprobarCorreo) btnComprobarCorreo.style.display = 'inline-flex';
                } else {
                    if (btnNoCorreo) btnNoCorreo.style.display = 'inline-flex';
                    if (btnComprobarCorreo) btnComprobarCorreo.style.display = 'none';
                }
            });

            // Event listener para validar correo cuando se pierde el foco
            nuevoClienteCorreoInput.addEventListener('blur', function (e) {
                manejarValidacionCorreo(e, 'nuevoClienteCorreoError');
            });
        }

        // Modal de ingreso directo - Confirmar con Enter
        const modalIngresoCodigoInput = document.getElementById('modalIngresoCodigoInput');

        if (modalIngresoCodigoInput) {
            // Remover listeners previos si existen
            const oldInput = modalIngresoCodigoInput.cloneNode(true);
            modalIngresoCodigoInput.parentNode.replaceChild(oldInput, modalIngresoCodigoInput);
            const newInput = document.getElementById('modalIngresoCodigoInput');

            newInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    // Enter confirma directamente
                    confirmarIngresoDirecto();
                }
            });

            newInput.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.stopPropagation();
                    cerrarModalIngresoDirecto();
                }
            });
        }
    }

    // =====================================================
    // BÚSQUEDA DE PRODUCTOS
    // =====================================================

    async function buscarProductos(query, searchId) {
        // Limpiar si no hay query o es muy corto
        if (!query || query.trim().length < 2) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }

        // Actualizar timestamp de última búsqueda
        ultimaBusqueda = Date.now();

        try {
            // FASE 1: Buscar en caché (instantáneo)
            if (cargaInicialCompleta && window.inventarioCache.productos.length > 0) {
                const inicio = Date.now();
                const resultados = buscarEnCache(query);
                const tiempo = Date.now() - inicio;

                console.log(`⚡ Búsqueda en caché: ${resultados.length} resultados en ${tiempo}ms`);

                // Verificar si esta búsqueda sigue siendo válida
                if (searchId && searchId !== window.currentSearchId) {
                    return; // Búsqueda obsoleta, ignorar resultados
                }

                mostrarResultadosBusqueda(resultados);
                return;
            }

            // FALLBACK: Si no hay caché, buscar en BD (primera vez o error)
            console.log('🔍 Caché no disponible, buscando en BD...');

            if (!window.app || !window.app.db) {
                const dbDirect = typeof getDB === 'function' ? getDB() : (typeof supabaseClient !== 'undefined' ? supabaseClient : null);

                if (!dbDirect) {
                    window.app.showToast('Error: Base de datos no inicializada', 'danger');
                    return;
                }
            }

            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

            // Búsqueda en BD con lógica mejorada
            const palabras = query.trim().split(/\s+/).filter(p => p.length > 0);
            let queryBuilder = db.from('ferre_inventario').select('*');

            // Verificar si es búsqueda numérica de 4+ dígitos
            const esNumerico = /^\d+$/.test(query.trim());
            const longitudNumeros = query.trim().length;

            if (esNumerico && longitudNumeros >= 4) {
                // Búsqueda por código
                queryBuilder = queryBuilder.ilike('codigo', `${query.trim()}%`);
            } else if (palabras.length === 1) {
                // Una palabra: código O producto
                const searchPattern = `%${palabras[0]}%`;
                queryBuilder = queryBuilder.or(`codigo.ilike.${searchPattern},producto.ilike.${searchPattern}`);
            } else {
                // Múltiples palabras: encadenar ilike para AND lógico
                palabras.forEach(palabra => {
                    queryBuilder = queryBuilder.ilike('producto', `%${palabra}%`);
                });
            }

            const { data, error } = await queryBuilder.limit(50);

            if (error) {
                throw error;
            }

            // Verificar si esta búsqueda sigue siendo válida
            if (searchId && searchId !== window.currentSearchId) {
                return;
            }

            mostrarResultadosBusqueda(data || []);

        } catch (error) {
            console.error('❌ Error en búsqueda:', error);
            if (window.app && window.app.showToast) {
                window.app.showToast('Error al buscar productos: ' + error.message, 'danger');
            }
        }
    }

    function mostrarResultadosBusqueda(productos, skipAutoScroll = false) {
        const container = document.getElementById('searchResults');

        // Guardar resultados para navegación
        ventaState.busquedaResultados = productos || [];

        if (!productos || productos.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No se encontraron productos</p>';
            ventaState.busquedaResultados = [];
            ventaState.busquedaResultados = [];
            ventaState.busquedaSeleccionado = -1;
            return;
        }

        // Seleccionar el primer resultado por defecto si no hay ninguno seleccionado
        if (ventaState.busquedaSeleccionado === -1) {
            ventaState.busquedaSeleccionado = 0;
        }

        container.innerHTML = productos.map((p, index) => {
            const stockRestante = calcularStockRestante(p.codigo, p.stock);
            const isSelected = index === ventaState.busquedaSeleccionado;
            return `
                <div class="search-result-item ${isSelected ? 'search-result-selected' : ''}" onclick="agregarProducto('${p.codigo}')">
                    <div class="search-result-header">
                        <div>
                            <strong>${p.producto}</strong>
                            <div class="search-result-meta">
                                <small>Código: ${p.codigo}</small>
                                ${p.zona ? `<span class="badge-zona-small">ZONA: ${p.zona}</span>` : ''}
                            </div>
                        </div>
                        <span class="precio">${window.app.formatCurrency(p.precio)}</span>
                    </div>
                    <div class="stock ${stockRestante < 10 ? 'bajo' : ''}">
                        Stock: ${stockRestante} ${p.unidad_paquete}
                    </div>
                </div>
            `;
        }).join('');

        // AUTO-SCROLL ARRIBA: Solo cuando aparecen nuevos resultados (no al navegar con flechas)
        if (!skipAutoScroll) {
            container.scrollTop = 0;
        }
    }

    async function agregarProductoPorCodigo(codigo) {
        try {
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);
            const { data, error } = await db
                .from('ferre_inventario')
                .select('*')
                .eq('codigo', codigo)
                .single();

            if (error) {
                window.app.showToast(`Producto no encontrado: ${codigo}`, 'warning');
                return;
            }

            agregarAlCarrito(data);

        } catch (error) {
            window.app.showToast('Error al agregar producto', 'danger');
        }
    }

    async function agregarProducto(codigo) {
        // Buscar si existen productos con código exacto y código + 001
        const codigoConUnidades = codigo + '001';

        // Limpiar búsqueda inmediatamente para dar sensación de velocidad
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
        ventaState.busquedaResultados = [];
        ventaState.busquedaSeleccionado = -1;

        try {
            let productoExacto = null;
            let productoUnidades = null;

            // OPTIMIZACIÓN: Buscar primero en caché (instantáneo)
            if (cargaInicialCompleta && window.inventarioCache.productos) {
                productoExacto = window.inventarioCache.productos.find(p => p.codigo === codigo);
                productoUnidades = window.inventarioCache.productos.find(p => p.codigo === codigoConUnidades);
            }

            // Si no están en caché o caché no está listo, buscar en BD
            if (!productoExacto && !productoUnidades) {
                const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

                const [respuestaExacto, respuestaUnidades] = await Promise.all([
                    db.from('ferre_inventario').select('*').eq('codigo', codigo).maybeSingle(),
                    db.from('ferre_inventario').select('*').eq('codigo', codigoConUnidades).maybeSingle()
                ]);

                productoExacto = respuestaExacto.data;
                productoUnidades = respuestaUnidades.data;
            }

            // Si existen ambos productos, mostrar modal de selección
            if (productoExacto && productoUnidades) {
                mostrarModalSeleccionProducto([productoExacto, productoUnidades]);
                return;
            }

            // Si solo existe uno, agregarlo directamente
            if (productoExacto) {
                await agregarAlCarrito(productoExacto);
            } else if (productoUnidades) {
                await agregarAlCarrito(productoUnidades);
            } else {
                window.app.showToast(`Producto no encontrado: ${codigo}`, 'warning');
            }

        } catch (error) {
            console.error('Error al buscar producto:', error);
            window.app.showToast('Error al buscar producto', 'danger');
        }

        document.getElementById('searchInput').focus();
    }

    // =====================================================
    // VENTA A CRÉDITO (F9)
    // =====================================================

    function setupCreditoVentaListeners() {
        const modal = document.getElementById('modalCreditoVenta');
        if (!modal) {
            return;
        }

        if (modal.dataset.listeners === 'ready') {
            return;
        }

        const abonoInput = document.getElementById('creditoAbonoInput');
        const vencimientoInput = document.getElementById('creditoVencimientoInput');

        if (abonoInput) {
            const handleAbonoChange = () => actualizarResumenCredito();
            abonoInput.addEventListener('input', handleAbonoChange);
            abonoInput.addEventListener('change', handleAbonoChange);
            abonoInput.addEventListener('blur', handleAbonoChange);
        }

        if (vencimientoInput) {
            const asegurarMinimo = () => {
                const hoy = obtenerFechaISOHoy();
                vencimientoInput.min = hoy;
                if (vencimientoInput.value && vencimientoInput.value < hoy) {
                    vencimientoInput.value = hoy;
                }
            };
            asegurarMinimo();
            vencimientoInput.addEventListener('focus', asegurarMinimo);
            vencimientoInput.addEventListener('click', asegurarMinimo);
        }

        modal.dataset.listeners = 'ready';
    }

    function obtenerFechaISOHoy(offsetDias = 0) {
        const fecha = new Date();
        fecha.setHours(0, 0, 0, 0);
        if (offsetDias) {
            fecha.setDate(fecha.getDate() + offsetDias);
        }
        return fecha.toISOString().split('T')[0];
    }

    function formatearFechaCortaLocal(fechaISO) {
        if (!fechaISO || typeof fechaISO !== 'string') {
            return '';
        }
        const partes = fechaISO.split('-');
        if (partes.length !== 3) {
            return '';
        }
        const year = Number(partes[0]);
        const month = Number(partes[1]) - 1;
        const day = Number(partes[2]);
        if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) {
            return '';
        }
        const fecha = new Date(year, month, day);
        if (Number.isNaN(fecha.getTime())) {
            return '';
        }
        return fecha.toLocaleDateString('es-EC', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function normalizarMontoCredito(valor) {
        const numero = Number(valor) || 0;
        return Math.round(numero * 100) / 100;
    }

    function mostrarAvisoCredito(mensaje, tipo = 'info') {
        const wrapper = document.getElementById('modalCreditoAvisoWrapper');
        const aviso = document.getElementById('modalCreditoAviso');
        const texto = document.getElementById('modalCreditoAvisoTexto');

        if (!wrapper || !aviso || !texto) {
            return;
        }

        if (!mensaje) {
            wrapper.style.display = 'none';
            texto.textContent = '';
            aviso.style.color = '';
            aviso.style.borderColor = '';
            return;
        }

        wrapper.style.display = 'block';
        texto.textContent = mensaje;

        const colores = {
            danger: 'var(--color-danger)',
            warning: '#d4a017',
            success: 'var(--color-success)',
            info: 'var(--text-secondary)'
        };

        const color = colores[tipo] || colores.info;
        aviso.style.color = color;
        aviso.style.borderColor = color;
    }

    function limpiarAvisoCredito() {
        mostrarAvisoCredito('');
    }

    function obtenerTotalVentaActual() {
        return normalizarMontoCredito(
            ventaState.carrito.reduce((acc, item) => acc + (item.cantidad * item.precio), 0)
        );
    }

    function actualizarResumenCredito() {
        const total = obtenerTotalVentaActual();
        const abonoInput = document.getElementById('creditoAbonoInput');
        const totalDisplay = document.getElementById('creditoTotalDisplay');
        const totalResumen = document.getElementById('creditoTotalResumen');
        const abonoResumen = document.getElementById('creditoAbonoResumen');
        const saldoResumen = document.getElementById('creditoSaldoResumen');
        const saldoDisplay = document.getElementById('creditoSaldoDisplay');
        const warning = document.getElementById('creditoAbonoWarning');
        const confirmarBtn = document.getElementById('btnConfirmarCreditoVenta');

        const abono = normalizarMontoCredito(abonoInput && abonoInput.value ? abonoInput.value : 0);
        const saldo = Math.max(total - abono, 0);

        if (totalDisplay) totalDisplay.textContent = window.app.formatCurrency(total);
        if (totalResumen) totalResumen.textContent = window.app.formatCurrency(total);
        if (abonoResumen) abonoResumen.textContent = window.app.formatCurrency(abono);
        if (saldoResumen) saldoResumen.textContent = window.app.formatCurrency(saldo);
        if (saldoDisplay) saldoDisplay.textContent = window.app.formatCurrency(saldo);

        if (!ventaState.credito) {
            ventaState.credito = { total: 0, abono: 0, saldo: 0 };
        }
        ventaState.credito.total = total;
        ventaState.credito.abono = abono;
        ventaState.credito.saldo = saldo;

        let avisoMostrado = false;

        if (warning) {
            if (abono > total) {
                warning.textContent = 'El abono no puede ser mayor que el total de la venta.';
                warning.style.display = 'block';
                mostrarAvisoCredito('Corrige el abono para continuar.', 'danger');
                avisoMostrado = true;
                if (confirmarBtn) confirmarBtn.disabled = true;
            } else {
                warning.textContent = '';
                warning.style.display = 'none';
                if (confirmarBtn) confirmarBtn.disabled = false;
            }
        }

        if (!avisoMostrado) {
            if (saldo === total) {
                mostrarAvisoCredito('El cliente no realiza abono inicial. Se registrará la deuda por el total.', 'warning');
            } else if (saldo === 0) {
                mostrarAvisoCredito('El abono cubre el 100% de la venta. Considera procesarla como pago inmediato.', 'info');
            } else {
                mostrarAvisoCredito('Se creará una cuenta por cobrar con el saldo pendiente.', 'info');
            }
        }
    }

    async function procesarVentaCredito() {
        if (ventaState.carrito.length === 0) {
            window.app.showToast('El carrito está vacío', 'warning');
            return;
        }

        const cliente = ventaState.clienteSeleccionado;
        if (!cliente || cliente.cedula === '9999999999999') {
            window.app.showToast('Selecciona un cliente antes de registrar crédito', 'warning', 3500);
            // Auto-activar búsqueda de cliente (como F3)
            activarBusquedaCliente();
            return;
        }

        await abrirModalCreditoVenta();
    }

    async function abrirModalCreditoVenta() {
        setupCreditoVentaListeners();

        const modal = document.getElementById('modalCreditoVenta');
        const abonoInput = document.getElementById('creditoAbonoInput');
        const vencimientoInput = document.getElementById('creditoVencimientoInput');
        const motivoInput = document.getElementById('creditoMotivoInput');
        const notasInput = document.getElementById('creditoNotasInput');
        const metodoSelect = document.getElementById('creditoMetodoSelect');
        const clienteCard = document.getElementById('modalCreditoCliente');
        const totalDisplay = document.getElementById('creditoTotalDisplay');
        const totalResumen = document.getElementById('creditoTotalResumen');
        const abonoResumen = document.getElementById('creditoAbonoResumen');
        const saldoResumen = document.getElementById('creditoSaldoResumen');
        const saldoDisplay = document.getElementById('creditoSaldoDisplay');

        if (!modal || !abonoInput || !vencimientoInput || !motivoInput || !notasInput || !metodoSelect || !clienteCard) {
            console.warn('Faltan elementos para inicializar el modal de crédito.');
            return;
        }

        const total = obtenerTotalVentaActual();
        ventaState.credito = { total, abono: 0, saldo: total };

        abonoInput.value = '';
        motivoInput.value = 'Venta a crédito';
        notasInput.value = '';
        metodoSelect.value = 'EFECTIVO';
        vencimientoInput.value = obtenerFechaISOHoy(30);
        vencimientoInput.min = obtenerFechaISOHoy();

        if (totalDisplay) totalDisplay.textContent = window.app.formatCurrency(total);
        if (totalResumen) totalResumen.textContent = window.app.formatCurrency(total);
        if (abonoResumen) abonoResumen.textContent = window.app.formatCurrency(0);
        if (saldoResumen) saldoResumen.textContent = window.app.formatCurrency(total);
        if (saldoDisplay) saldoDisplay.textContent = window.app.formatCurrency(total);

        const cliente = ventaState.clienteSeleccionado;
        clienteCard.innerHTML = `
            <div class="cliente-nombre">${cliente.razon_social}</div>
            <div class="cliente-detalle">
                <i class="fas fa-id-card"></i>
                <span>${cliente.cedula}</span>
            </div>
            <div class="cliente-detalle">
                <i class="fas fa-envelope"></i>
                <span>${cliente.correo || 'Sin correo'}</span>
            </div>
            <div class="cliente-detalle">
                <i class="fas fa-phone"></i>
                <span>${cliente.telefono || 'Sin teléfono'}</span>
            </div>
        `;

        limpiarAvisoCredito();
        mostrarAvisoCredito('Confirma para enviar esta venta al módulo de Cuentas por Cobrar.', 'info');

        modal.classList.add('active');

        setTimeout(() => {
            abonoInput.focus();
            abonoInput.select();
        }, 120);
    }

    function cerrarModalCreditoVenta() {
        const modal = document.getElementById('modalCreditoVenta');
        if (modal) {
            modal.classList.remove('active');
        }
        limpiarAvisoCredito();
    }

    function generarCodigoCuenta(tipo = 'VENTA') {
        const prefijo = tipo === 'VENTA' ? 'V' : tipo === 'EFECTIVO' ? 'E' : 'O';
        return `${prefijo}${Date.now()}`;
    }

    function obtenerUsuarioActual() {
        if (window.auth && typeof window.auth.getUserEmail === 'function') {
            const email = window.auth.getUserEmail();
            const nombres = window.auth.getUserNombres ? window.auth.getUserNombres() : '';
            const apellidos = window.auth.getUserApellidos ? window.auth.getUserApellidos() : '';
            const nombreCompleto = `${nombres || ''} ${apellidos || ''}`.trim();
            return {
                email,
                nombre: nombreCompleto || email || 'Usuario'
            };
        }
        return { email: null, nombre: 'Usuario' };
    }

    async function ensureDeudorParaCliente(db, cliente) {
        if (!cliente || !cliente.cedula) {
            throw new Error('Cliente inválido para crear cuenta por cobrar.');
        }

        const documento = cliente.cedula.trim();

        console.log('🔍 Buscando deudor existente con cédula:', documento);

        const { data: deudorExistente, error: errorDeudor } = await db
            .from('ferre_deudores')
            .select('*')
            .eq('cedula_ruc', documento)
            .maybeSingle();

        if (errorDeudor) {
            throw errorDeudor;
        }

        if (deudorExistente) {
            console.log('✅ Deudor encontrado:', deudorExistente);
            console.log('💰 Crédito disponible actual:', deudorExistente.credito_disponible);
            return deudorExistente;
        }

        console.log('⚠️ Deudor no existe, creando nuevo...');
        console.log('📄 Datos del cliente:', cliente);

        // Si el cliente no tiene límite de crédito, usar un límite por defecto de 1000
        const limite = cliente.limite_credito != null && Number(cliente.limite_credito) > 0
            ? Number(cliente.limite_credito)
            : 1000;
        const creditoDisponible = cliente.credito_disponible != null && Number(cliente.credito_disponible) > 0
            ? Number(cliente.credito_disponible)
            : limite;

        console.log('💳 Límite de crédito a usar:', limite);
        console.log('💰 Crédito disponible inicial:', creditoDisponible);

        const payload = {
            cedula_ruc: documento,
            nombre: cliente.razon_social,
            direccion: cliente.direccion || null,
            telefono: cliente.telefono || null,
            email: cliente.correo || null,
            limite_credito: normalizarMontoCredito(limite),
            credito_disponible: normalizarMontoCredito(creditoDisponible),
            notas: 'Creado automáticamente desde Punto de Venta'
        };

        console.log('📝 Payload para crear deudor:', payload);

        const { data: nuevoDeudor, error: errorInsert } = await db
            .from('ferre_deudores')
            .insert([payload])
            .select()
            .single();

        if (errorInsert) {
            console.error('❌ Error creando deudor:', errorInsert);
            throw errorInsert;
        }

        console.log('✅ Deudor creado exitosamente:', nuevoDeudor);
        return nuevoDeudor;
    }

    function abrirTicketCredito({ cuenta, deudor, abonoInicial = 0, usuario, notas, productos = [], ventaId = null }) {
        if (!cuenta) {
            return;
        }

        const params = new URLSearchParams();
        params.set('codigo', cuenta.codigo || '');
        params.set('tipo', cuenta.tipo || '');
        params.set('motivo', cuenta.motivo || '');
        params.set('monto', normalizarMontoCredito(cuenta.monto).toFixed(2));
        params.set('saldo', normalizarMontoCredito(cuenta.saldo_pendiente).toFixed(2));
        params.set('abono_inicial', normalizarMontoCredito(abonoInicial).toFixed(2));
        params.set('fecha', cuenta.fecha_otorgada || '');
        params.set('vencimiento', cuenta.fecha_vencimiento || '');
        params.set('estado', cuenta.estado || '');
        params.set('aprobado_por', usuario?.nombre || usuario?.email || '');
        params.set('deudor_nombre', deudor?.nombre || '');
        params.set('deudor_documento', deudor?.cedula_ruc || '');
        params.set('deudor_direccion', deudor?.direccion || '');
        params.set('deudor_telefono', deudor?.telefono || '');
        params.set('deudor_email', deudor?.email || '');
        params.set('notas', notas || '');
        params.set('venta_id', ventaId || '');

        if (productos && productos.length) {
            const items = productos.map(item => {
                const cantidadRaw = item.cantidad != null ? parseFloat(item.cantidad) : 1;
                const cantidadValida = Number.isFinite(cantidadRaw) ? cantidadRaw : 1;
                const cantidadLabel = Number.isInteger(cantidadValida)
                    ? cantidadValida
                    : cantidadValida.toFixed(3).replace(/\.0+$|0+$/g, '').replace(/\.$/, '');
                const precio = normalizarMontoCredito(item.precio || 0);
                return `${cantidadLabel}x ${item.nombre || item.codigo || ''} — ${window.app.formatCurrency(precio)}`;
            }).join('|');
            params.set('items', items);
        }

        const url = `views/ticket_cxc_deuda.html?${params.toString()}`;
        window.open(url, '_blank');
    }

    async function confirmarCreditoVenta() {
        const cliente = ventaState.clienteSeleccionado;

        if (ventaState.carrito.length === 0) {
            window.app.showToast('El carrito está vacío', 'warning');
            return;
        }

        if (!cliente || cliente.cedula === '9999999999999') {
            window.app.showToast('Selecciona un cliente válido antes de confirmar crédito', 'warning', 3500);
            return;
        }

        const total = obtenerTotalVentaActual();
        if (total <= 0) {
            window.app.showToast('El total debe ser mayor a 0 para generar crédito', 'warning');
            return;
        }

        const abonoInput = document.getElementById('creditoAbonoInput');
        const vencimientoInput = document.getElementById('creditoVencimientoInput');
        const motivoInput = document.getElementById('creditoMotivoInput');
        const metodoSelect = document.getElementById('creditoMetodoSelect');
        const notasInput = document.getElementById('creditoNotasInput');
        const confirmarBtn = document.getElementById('btnConfirmarCreditoVenta');

        const abono = normalizarMontoCredito(abonoInput && abonoInput.value ? abonoInput.value : 0);
        if (abono > total) {
            window.app.showToast('El abono no puede exceder el total de la venta', 'danger');
            if (abonoInput) {
                abonoInput.focus();
            }
            return;
        }

        const saldo = Math.max(total - abono, 0);
        const vencimiento = vencimientoInput && vencimientoInput.value ? vencimientoInput.value : '';

        if (!vencimiento) {
            window.app.showToast('Selecciona una fecha de vencimiento válida', 'warning');
            if (vencimientoInput) {
                vencimientoInput.focus();
            }
            return;
        }

        const hoy = obtenerFechaISOHoy();
        if (vencimiento < hoy) {
            window.app.showToast('La fecha de vencimiento no puede ser anterior a hoy', 'warning');
            if (vencimientoInput) {
                vencimientoInput.focus();
            }
            return;
        }

        const motivo = motivoInput && motivoInput.value.trim() ? motivoInput.value.trim() : 'Venta a crédito';
        const metodo = metodoSelect ? metodoSelect.value : 'EFECTIVO';
        const notas = notasInput && notasInput.value.trim() ? notasInput.value.trim() : '';

        const db = window.app ? window.app.db : (typeof getSupabaseClient === 'function' ? getSupabaseClient() : (typeof getDB === 'function' ? getDB() : supabaseClient));
        if (!db || typeof db.from !== 'function') {
            window.app.showToast('No se pudo acceder a la base de datos', 'danger');
            return;
        }

        const usuario = obtenerUsuarioActual();
        const botonTextoOriginal = confirmarBtn ? confirmarBtn.innerHTML : '';
        try {
            if (confirmarBtn) {
                confirmarBtn.disabled = true;
                confirmarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            }

            console.log('📋 Iniciando registro de crédito...');
            console.log('👤 Cliente:', cliente);
            console.log('🛒 Carrito:', ventaState.carrito);
            console.log('💰 Total:', total, 'Abono:', abono, 'Saldo:', saldo);

            const deudor = await ensureDeudorParaCliente(db, cliente);
            console.log('✅ Deudor verificado/creado:', deudor);

            const ventaIdText = `S${Date.now()}`;
            const fechaActualISO = new Date().toISOString();

            const ventaPayload = {
                id_venta: ventaIdText,
                fecha_hora_venta: fechaActualISO,
                cliente_id: cliente.cedula,
                total: normalizarMontoCredito(total),
                pagado_con: normalizarMontoCredito(abono),
                vuelto: 0,
                tipo: 'RECIBO',
                estado: 'COMPLETADO',
                usuario_email: usuario.email || null,
                doc: null,
                clave_acceso: null,
                fecha_factura: null
            };

            console.log('📝 Insertando venta:', ventaPayload);

            const { data: ventaInsertada, error: ventaError } = await db
                .from('ferre_ventas')
                .insert([ventaPayload])
                .select()
                .single();

            if (ventaError) {
                console.error('❌ Error insertando venta:', ventaError);
                throw new Error(ventaError.message || 'No se pudo registrar la venta.');
            }

            console.log('✅ Venta insertada:', ventaInsertada);

            const detallesPayload = ventaState.carrito.map((item, index) => ({
                id_detalle: `${ventaIdText}_${index + 1}`,
                venta_id: ventaInsertada.id,
                id_venta: ventaIdText,
                producto_id: item.codigo,
                cantidad: parseFloat(item.cantidad),
                precio: normalizarMontoCredito(item.precio),
                estado: 'ACTIVO'
            }));

            console.log('📦 Insertando detalles de venta:', detallesPayload);

            const { error: detalleError } = await db
                .from('ferre_ventas_detalle')
                .insert(detallesPayload);

            if (detalleError) {
                console.error('❌ Error insertando detalles:', detalleError);
                console.log('🔄 Rollback: eliminando venta...');
                await db.from('ferre_ventas').delete().eq('id', ventaInsertada.id);
                throw new Error(detalleError.message || 'No se pudieron registrar los productos de la venta.');
            }

            console.log('✅ Detalles insertados correctamente');

            const codigoCuenta = generarCodigoCuenta('VENTA');
            const estadoCuenta = saldo <= 0 ? 'PAGADO' : (saldo < total ? 'PARCIAL' : 'PENDIENTE');
            const vencimientoISO = new Date(`${vencimiento}T23:59:59`).toISOString();

            const cuentaPayload = {
                codigo: codigoCuenta,
                tipo: 'VENTA',
                motivo,
                monto: normalizarMontoCredito(total),
                saldo_pendiente: normalizarMontoCredito(total),
                venta_id: ventaInsertada.id,
                deudor_id: deudor.id,
                estado: estadoCuenta,
                fecha_otorgada: fechaActualISO,
                fecha_vencimiento: vencimientoISO,
                aprobado_por: usuario.nombre || usuario.email || 'Usuario',
                otros_detalles: notas || 'Generado automáticamente desde Punto de Venta'
            };

            console.log('💳 Insertando cuenta por cobrar:', cuentaPayload);

            const { data: cuentaInsertada, error: cuentaError } = await db
                .from('ferre_cuentas_por_cobrar')
                .insert([cuentaPayload])
                .select()
                .single();

            if (cuentaError) {
                console.error('❌ Error insertando cuenta:', cuentaError);
                console.log('🔄 Rollback: eliminando venta y detalles...');
                await db.from('ferre_ventas_detalle').delete().eq('venta_id', ventaInsertada.id);
                await db.from('ferre_ventas').delete().eq('id', ventaInsertada.id);
                throw new Error(cuentaError.message || 'No se pudo registrar la cuenta por cobrar.');
            }

            console.log('✅ Cuenta insertada:', cuentaInsertada);

            if (abono > 0) {
                const pagoPayload = {
                    cuenta_id: cuentaInsertada.id,
                    monto_pago: normalizarMontoCredito(abono),
                    forma_pago: metodo,
                    numero_referencia: null,
                    notas: notas ? `Pago inicial: ${notas}` : 'Pago inicial registrado desde Punto de Venta',
                    recibido_por: usuario.nombre || usuario.email || 'Usuario'
                };

                console.log('💰 Insertando pago inicial:', pagoPayload);

                const { error: pagoError } = await db
                    .from('ferre_pagos_cuentas_por_cobrar')
                    .insert([pagoPayload]);

                if (pagoError) {
                    console.error('❌ Error registrando pago inicial:', pagoError);
                    window.app.showToast('Crédito creado, pero el pago inicial no se guardó. Regístralo manualmente.', 'warning', 6000);
                } else {
                    console.log('✅ Pago inicial registrado');
                }
            }

            console.log('🎉 Crédito registrado exitosamente');

            cerrarModalCreditoVenta();
            window.app.showToast('Venta registrada como crédito exitosamente', 'success', 4000);

            abrirTicketCredito({
                cuenta: {
                    ...cuentaInsertada,
                    monto: total,
                    saldo_pendiente: saldo,
                    estado: estadoCuenta,
                    fecha_otorgada: fechaActualISO,
                    fecha_vencimiento: vencimientoISO
                },
                deudor,
                abonoInicial: abono,
                usuario,
                notas,
                productos: ventaState.carrito,
                ventaId: ventaIdText
            });

            ventaState.carrito = [];
            ventaState.clienteSeleccionado = null;
            ventaState.tipoComprobante = 'RECIBO';
            ventaState.credito = { total: 0, abono: 0, saldo: 0 };

            limpiarCarritoCache();
            actualizarCarrito();
            mostrarClienteSeleccionado();
            const clienteCedulaInput = document.getElementById('clienteCedula');
            if (clienteCedulaInput) {
                clienteCedulaInput.value = '';
            }
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.focus();
            }
        } catch (error) {
            console.error('❌ Error al confirmar crédito:', error);
            console.error('Stack trace:', error.stack);
            window.app.showToast('No se pudo registrar el crédito: ' + (error.message || error), 'danger', 6000);
        } finally {
            if (confirmarBtn) {
                confirmarBtn.disabled = false;
                confirmarBtn.innerHTML = botonTextoOriginal || '<i class="fas fa-hand-holding-usd"></i> Guardar crédito';
            }
        }
    }

    window.procesarVentaCredito = procesarVentaCredito;
    window.cerrarModalCreditoVenta = cerrarModalCreditoVenta;
    window.confirmarCreditoVenta = confirmarCreditoVenta;

    // =====================================================
    // GESTIÓN DEL CARRITO
    // =====================================================

    async function agregarAlCarrito(producto) {
        // OPTIMIZACIÓN: Usar caché si está disponible, verificar BD solo en background
        let stockActual = producto.stock;
        let precioActual = producto.precio;

        // Si el caché está disponible, usarlo inmediatamente
        if (cargaInicialCompleta && window.inventarioCache.productos) {
            const productoCache = window.inventarioCache.productos.find(p => p.codigo === producto.codigo);
            if (productoCache) {
                stockActual = productoCache.stock;
                precioActual = productoCache.precio;
            }
        }

        // Verificar stock en BD en background (sin bloquear la UI)
        // Solo para mantener caché sincronizado
        if (cargaInicialCompleta) {
            verificarStockEnBackground(producto.codigo).then(stockData => {
                if (stockData && window.inventarioCache.productos) {
                    const productoCache = window.inventarioCache.productos.find(p => p.codigo === producto.codigo);
                    if (productoCache) {
                        productoCache.stock = stockData.stock;
                        productoCache.precio = stockData.precio;
                    }
                }
            }).catch(err => console.warn('Error actualizando stock en background:', err));
        }

        // Verificar stock disponible
        if (stockActual <= 0) {
            window.app.showToast('⚠️ Producto sin stock disponible', 'danger');
            actualizarCacheSilencioso();
            return;
        }

        // Buscar si ya existe en el carrito
        const existente = ventaState.carrito.find(item => item.codigo === producto.codigo);

        if (existente) {
            // Verificar que no exceda el stock
            if (existente.cantidad >= stockActual) {
                window.app.showToast('No hay suficiente stock disponible', 'warning');
                return;
            }
            existente.cantidad++;
            // Actualizar solo la fila existente (más rápido que re-renderizar todo)
            actualizarFilaCarrito(producto.codigo);
        } else {
            // Agregar al inicio del array (más antiguo arriba)
            ventaState.carrito.unshift({
                codigo: producto.codigo,
                nombre: producto.producto,
                precio: precioActual,
                cantidad: 1,
                stock: stockActual,
                costo: producto.costo || 0,
                unidad: producto.unidad_paquete || 'UNIDADES'
            });
            // Agregar solo la nueva fila (más rápido que re-renderizar todo)
            agregarFilaCarrito(producto, precioActual, stockActual);
        }

        // Actualizar totales (rápido, solo números)
        calcularTotales();
        actualizarContadorItems();
        guardarCarritoEnCache();

        // Hacer scroll al inicio del carrito para ver el producto recién agregado
        const carritoColumn = document.getElementById('carritoColumn');
        if (carritoColumn) {
            carritoColumn.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.app.showToast(`✓ ${producto.producto}`, 'success', 2000);
    }

    // Función auxiliar para verificar stock en background sin bloquear
    async function verificarStockEnBackground(codigo) {
        try {
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);
            const { data, error } = await db
                .from('ferre_inventario')
                .select('stock, precio')
                .eq('codigo', codigo)
                .single();

            if (!error && data) {
                return data;
            }
        } catch (error) {
            console.warn('Error verificando stock en background:', error);
        }
        return null;
    }

    function actualizarCantidad(codigo, cantidad) {
        const item = ventaState.carrito.find(i => i.codigo === codigo);
        if (!item) return;

        cantidad = parseFloat(cantidad);

        if (cantidad <= 0) {
            eliminarDelCarrito(codigo);
            return;
        }

        if (cantidad > item.stock) {
            window.app.showToast('Cantidad excede el stock disponible', 'warning');
            return;
        }

        item.cantidad = cantidad;
        actualizarCarrito();
        guardarCarritoEnCache();
    }

    function manejarTeclasCantidad(event, codigo, cantidadActual) {
        // Detectar teclas + y -
        if (event.key === '+' || event.key === '=') {
            event.preventDefault();
            const nuevaCantidad = parseFloat(cantidadActual) + 1;
            actualizarCantidad(codigo, nuevaCantidad);
        } else if (event.key === '-' || event.key === '_') {
            event.preventDefault();
            const nuevaCantidad = parseFloat(cantidadActual) - 1;
            actualizarCantidad(codigo, nuevaCantidad);
        }
    }

    function eliminarDelCarrito(codigo) {
        ventaState.carrito = ventaState.carrito.filter(item => item.codigo !== codigo);

        // Ajustar índice seleccionado si es necesario
        if (ventaState.modoEdicion && ventaState.indiceSeleccionado >= ventaState.carrito.length) {
            ventaState.indiceSeleccionado = Math.max(0, ventaState.carrito.length - 1);
        }

        actualizarCarrito();
        guardarCarritoEnCache();
        window.app.showToast('Producto eliminado del carrito', 'info', 2000);
    }

    function actualizarPrecio(codigo, nuevoPrecio) {
        const item = ventaState.carrito.find(i => i.codigo === codigo);
        if (!item) return;

        const precio = parseFloat(nuevoPrecio);

        if (isNaN(precio) || precio <= 0) {
            window.app.showToast('Precio inválido', 'warning');
            actualizarCarrito();
            return;
        }

        item.precio = precio;
        actualizarCarrito();
        guardarCarritoEnCache();
        window.app.showToast('Precio actualizado', 'success', 1500);
    }

    function actualizarCarrito() {
        const tbody = document.getElementById('carritoBody');

        if (ventaState.carrito.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: #999; padding: 40px;">
                        Carrito vacío. Escanea productos para comenzar.
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = ventaState.carrito.map((item, index) => {
                return generarFilaCarrito(item, index);
            }).join('');

            // Cargar ganancias solo si el botón está activo
            const btn = document.getElementById('gananciaToggleBtn');
            if (btn && btn.classList.contains('active')) {
                cargarGananciasCarrito();
            }
        }

        calcularTotales();
        actualizarContadorItems();
    }

    // Función auxiliar para generar HTML de una fila
    function generarFilaCarrito(item, index) {
        const subtotal = item.cantidad * item.precio;
        const stockRestante = item.stock - item.cantidad;
        const isSelected = ventaState.modoEdicion && index === ventaState.indiceSeleccionado;
        const precioId = `precio-${item.codigo}`;
        const cantidadId = `cantidad-${item.codigo}`;
        const gananciaId = `ganancia-${item.codigo}`;

        // Calcular ganancia si ya está disponible en el cache y el botón está activo
        const btn = document.getElementById('gananciaToggleBtn');
        const mostrarGanancia = btn && btn.classList.contains('active');

        let gananciaHTML = '';
        let gananciaSubtotalHTML = '';

        if (mostrarGanancia) {
            if (item.precio_proveedor !== undefined) {
                const precioConImpuesto = item.precio_proveedor * 1.15;
                const gananciaPorUnidad = item.precio - precioConImpuesto;
                const gananciaTotal = gananciaPorUnidad * item.cantidad;
                const esNegativo = gananciaPorUnidad < 0;

                gananciaHTML = `<div class="ganancia-fila ${esNegativo ? 'negativo' : ''}" id="${gananciaId}-precio">
                    G: ${esNegativo ? '-' : '+'}$${Math.abs(gananciaPorUnidad).toFixed(2)}
                </div>`;

                gananciaSubtotalHTML = `<div class="ganancia-fila ${esNegativo ? 'negativo' : ''}" id="${gananciaId}-subtotal">
                    G: ${esNegativo ? '-' : '+'}$${Math.abs(gananciaTotal).toFixed(2)}
                </div>`;
            } else {
                gananciaHTML = `<div class="ganancia-fila loading" id="${gananciaId}-precio">Calculando...</div>`;
                gananciaSubtotalHTML = `<div class="ganancia-fila loading" id="${gananciaId}-subtotal">Calculando...</div>`;
            }
        }

        return `
            <tr class="${isSelected ? 'carrito-item-selected' : ''}" data-codigo="${item.codigo}">
                <td>
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${item.nombre}</strong><br>
                            <small style="color: #666;">${item.codigo}</small><br>
                            <small style="color: ${stockRestante < 10 ? '#dc3545' : '#28a745'};">
                                Stock restante: ${stockRestante} ${item.unidad}
                            </small>
                        </div>
                        ${item.zona ? `<span class="badge-zona">ZONA: ${item.zona}</span>` : ''}
                    </div>
                </td>
                <td style="text-align: center;">
                    ${ventaState.modoEdicion ?
                `<input type="number" 
                            id="${cantidadId}" 
                            class="cantidad-editable-input" 
                            value="${item.cantidad}" 
                            step="0.001" 
                            min="0.001"
                            max="${item.stock}"
                            onchange="actualizarCantidad('${item.codigo}', this.value)"
                            onkeydown="manejarTeclasCantidad(event, '${item.codigo}', ${item.cantidad})"
                            onclick="this.select()">`
                :
                `<strong>${item.cantidad}</strong>`
            }
                </td>
                <td>
                    ${ventaState.modoEdicion ?
                `<input type="number" 
                            id="${precioId}" 
                            class="precio-editable" 
                            value="${item.precio}" 
                            step="0.01" 
                            min="0.01"
                            onchange="actualizarPrecio('${item.codigo}', this.value)"
                            onclick="this.select()">`
                :
                `<div>
                            ${window.app.formatCurrency(item.precio)}
                            ${gananciaHTML}
                        </div>`
            }
                </td>
                <td>
                    <strong>${window.app.formatCurrency(subtotal)}</strong>
                    ${gananciaSubtotalHTML}
                </td>
                <td>
                    <div class="action-buttons">
                        ${item.nombre.toLowerCase().includes('ducha') ?
                `<button class="btn-warranty-item" onclick="abrirModalGarantia('${item.codigo}')" title="Generar Garantía">
                                <i class="fas fa-shield-alt"></i>
                            </button>`
                : ''
            }
                        <button class="btn-remove-item" onclick="eliminarDelCarrito('${item.codigo}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }

    // OPTIMIZACIÓN: Agregar solo una nueva fila al carrito (sin re-renderizar todo)
    function agregarFilaCarrito(producto, precio, stock) {
        const tbody = document.getElementById('carritoBody');

        // Si estaba vacío, limpiar mensaje
        if (ventaState.carrito.length === 1) {
            tbody.innerHTML = '';
        }

        const item = {
            codigo: producto.codigo,
            nombre: producto.producto,
            precio: precio,
            cantidad: 1,
            stock: stock,
            unidad: producto.unidad_paquete || 'UNIDADES',
            zona: producto.zona
        };

        // Insertar al inicio (prepend)
        tbody.insertAdjacentHTML('afterbegin', generarFilaCarrito(item, 0));

        // Hacer scroll al inicio
        const carritoColumn = document.getElementById('carritoColumn');
        if (carritoColumn) {
            carritoColumn.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // OPTIMIZACIÓN: Actualizar solo una fila existente
    function actualizarFilaCarrito(codigo) {
        const tbody = document.getElementById('carritoBody');
        const fila = tbody.querySelector(`tr[data-codigo="${codigo}"]`);

        if (!fila) {
            // Si no encuentra la fila, re-renderizar todo (fallback)
            actualizarCarrito();
            return;
        }

        const item = ventaState.carrito.find(i => i.codigo === codigo);
        if (!item) return;

        const index = ventaState.carrito.indexOf(item);

        // Reemplazar la fila
        fila.outerHTML = generarFilaCarrito(item, index);
    }

    function actualizarContadorItems() {
        const itemsCount = document.getElementById('itemsCount');
        if (itemsCount) {
            const totalItems = ventaState.carrito.length;
            itemsCount.textContent = totalItems;
        }

        // Actualizar total de ganancia si está activo
        const totalInline = document.getElementById('gananciaTotalInline');
        if (totalInline && totalInline.classList.contains('active')) {
            actualizarGananciaTotal();
        }
    }

    function calcularTotales() {
        // El precio ya incluye IVA, solo sumamos el total
        const total = ventaState.carrito.reduce((sum, item) => sum + (item.cantidad * item.precio), 0);

        // Actualizar total en navbar usando la función global
        if (window.app && window.app.updateNavbarCounter) {
            window.app.updateNavbarCounter('punto-venta', total);
        }
    }

    // ===== FUNCIONES DE GANANCIA =====

    window.toggleGananciaPanel = function () {
        const totalInline = document.getElementById('gananciaTotalInline');
        const btn = document.getElementById('gananciaToggleBtn');

        if (totalInline.classList.contains('active')) {
            totalInline.classList.remove('active');
            btn.classList.remove('active');
            // Ocultar ganancias en las filas
            actualizarCarrito();
        } else {
            totalInline.classList.add('active');
            btn.classList.add('active');
            // Mostrar ganancias en las filas
            actualizarCarrito();
            actualizarGananciaTotal();
        }
    }

    function cargarGananciasCarrito() {
        if (ventaState.carrito.length === 0) return;

        // Verificar que el caché de inventario esté disponible
        if (!window.inventarioCache || !window.inventarioCache.productos) {
            console.warn('Caché de inventario no disponible para cargar ganancias');
            return;
        }

        let totalGanancia = 0;

        for (const item of ventaState.carrito) {
            try {
                // Obtener precio_proveedor del caché de inventario
                let precioProveedor = item.precio_proveedor;

                if (precioProveedor === undefined) {
                    // Buscar en el caché de inventario
                    const productoCache = window.inventarioCache.productos.find(p => p.codigo === item.codigo);

                    if (productoCache && productoCache.precio_proveedor !== undefined) {
                        precioProveedor = productoCache.precio_proveedor;
                        // Guardar en el item del carrito para futuros cálculos
                        item.precio_proveedor = precioProveedor;
                    }
                }

                if (precioProveedor !== undefined) {
                    // Fórmula: precioVenta - (precio_proveedor * 1.15)
                    const precioConImpuesto = precioProveedor * 1.15;
                    const gananciaPorUnidad = item.precio - precioConImpuesto;
                    const gananciaTotal = gananciaPorUnidad * item.cantidad;

                    totalGanancia += gananciaTotal;

                    const esNegativo = gananciaPorUnidad < 0;

                    // Actualizar ganancia en precio
                    const gananciaIdPrecio = document.getElementById(`ganancia-${item.codigo}-precio`);
                    if (gananciaIdPrecio) {
                        gananciaIdPrecio.className = `ganancia-fila ${esNegativo ? 'negativo' : ''}`;
                        gananciaIdPrecio.textContent = `G: ${esNegativo ? '-' : '+'}$${Math.abs(gananciaPorUnidad).toFixed(2)}`;
                    }

                    // Actualizar ganancia en subtotal
                    const gananciaIdSubtotal = document.getElementById(`ganancia-${item.codigo}-subtotal`);
                    if (gananciaIdSubtotal) {
                        gananciaIdSubtotal.className = `ganancia-fila ${esNegativo ? 'negativo' : ''}`;
                        gananciaIdSubtotal.textContent = `G: ${esNegativo ? '-' : '+'}$${Math.abs(gananciaTotal).toFixed(2)}`;
                    }
                }
            } catch (err) {
                console.error(`Error procesando item ${item.codigo}:`, err);
            }
        }

        // Actualizar total si está visible
        const totalInline = document.getElementById('gananciaTotalInline');
        if (totalInline && totalInline.classList.contains('active')) {
            const esNegativo = totalGanancia < 0;
            document.getElementById('gananciaTotalValue').textContent =
                `${esNegativo ? '-' : ''}$${Math.abs(totalGanancia).toFixed(2)}`;
        }
    }

    async function actualizarGananciaTotal() {
        if (ventaState.carrito.length === 0) {
            document.getElementById('gananciaTotalValue').textContent = '$0.00';
            return;
        }

        let totalGanancia = 0;

        for (const item of ventaState.carrito) {
            if (item.precio_proveedor !== undefined) {
                const precioConImpuesto = item.precio_proveedor * 1.15;
                const gananciaPorUnidad = item.precio - precioConImpuesto;
                const gananciaTotal = gananciaPorUnidad * item.cantidad;
                totalGanancia += gananciaTotal;
            }
        }

        const esNegativo = totalGanancia < 0;
        document.getElementById('gananciaTotalValue').textContent =
            `${esNegativo ? '-' : ''}$${Math.abs(totalGanancia).toFixed(2)}`;
    }

    async function limpiarVenta() {
        if (ventaState.carrito.length > 0 || ventaState.clienteSeleccionado) {
            const confirmado = await mostrarConfirmacion(
                'Limpiar Todo',
                '¿Estás seguro de limpiar todo? Se eliminará el carrito y el cliente seleccionado.',
                null
            );

            if (!confirmado) {
                return;
            }
        }

        // Limpiar TODO
        ventaState.carrito = [];
        ventaState.clienteSeleccionado = null;
        ventaState.busquedaResultados = [];
        ventaState.busquedaSeleccionado = -1;
        ventaState.clientesBusqueda = [];
        ventaState.clienteSeleccionadoIndex = -1;

        // Limpiar campos de búsqueda de productos
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';

        // Limpiar campos de búsqueda de clientes
        document.getElementById('clienteCedula').value = '';
        document.getElementById('clienteSearchResults').innerHTML = '';

        // Restablecer vista de cliente a Consumidor Final
        document.getElementById('clienteSeleccionadoBox').style.display = 'block';
        document.getElementById('clienteBusquedaBox').style.display = 'none';

        // Actualizar UI
        actualizarCarrito();
        mostrarClienteSeleccionado();
        limpiarCarritoCache();

        // Enfocar en búsqueda de productos
        document.getElementById('searchInput').focus();

        window.app.showToast('<i class="fas fa-check-circle"></i> Todo limpiado - Listo para nueva venta', 'success', 2500);
    }

    // =====================================================
    // BÚSQUEDA DE CLIENTE
    // =====================================================

    async function buscarCliente() {
        const query = document.getElementById('clienteCedula').value.trim();

        if (!query || query.length < 2) {
            document.getElementById('clienteSearchResults').innerHTML = '';
            ventaState.clientesBusqueda = [];
            ventaState.clienteSeleccionadoIndex = -1;
            return;
        }

        try {
            // Determinar si es búsqueda por cédula (solo números) o por nombre
            const esNumerico = /^\d+$/.test(query);

            let resultados = [];

            // Buscar en cache si está cargado
            if (cargaClientesCompleta && window.clientesCache.clientes.length > 0) {
                if (esNumerico) {
                    // Buscar por cédula que EMPIECE con el query
                    resultados = window.clientesCache.clientes.filter(c =>
                        c.cedula.startsWith(query)
                    );
                } else {
                    // Buscar por razón social que CONTENGA el query (case insensitive)
                    const queryLower = query.toLowerCase();
                    resultados = window.clientesCache.clientes.filter(c =>
                        c.razon_social.toLowerCase().includes(queryLower)
                    );
                }

                resultados = resultados.slice(0, 10); // Limitar a 10 resultados
            } else {
                // Fallback a búsqueda en DB si cache no está listo
                const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

                let queryBuilder = db.from('ferre_clientes').select('*');

                if (esNumerico) {
                    queryBuilder = queryBuilder.ilike('cedula', `${query}%`);
                } else {
                    queryBuilder = queryBuilder.ilike('razon_social', `%${query}%`);
                }

                const { data, error } = await queryBuilder.limit(10);

                if (error) {
                    console.error('Error buscando clientes:', error);
                    return;
                }

                resultados = data || [];
            }

            // Guardar resultados
            ventaState.clientesBusqueda = resultados;
            ventaState.clienteSeleccionadoIndex = resultados.length > 0 ? 0 : -1;

            mostrarResultadosClientes();

        } catch (error) {
            console.error('Error buscando clientes:', error);
        }
    }

    // Consultar e iniciar registro de cliente
    async function consultarYRegistrarCliente(numero) {
        // Mostrar overlay de carga con animación
        const loadingOverlay = document.getElementById('loadingConsultaAPI');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }

        try {
            const isCedula = numero.length === 10;

            // Consultar API externa
            const response = isCedula ?
                await consultarCedula(numero) :
                await consultarRuc(numero);

            // Ocultar loading
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }

            // Si la API falla o no devuelve datos, activar ingreso manual
            if (!response || !response.data) {
                console.warn('⚠️ API no respondió correctamente, activando ingreso manual');
                window.app.showToast('⚠️ Servicio de consulta no disponible. Ingrese los datos manualmente.', 'warning', 4000);

                // Mostrar modal con campos vacíos para ingreso manual
                const datosClienteManual = {
                    cedula: numero,
                    razon_social: '',
                    direccion: '',
                    telefono: '',
                    correo: '',
                    ingresoManual: true, // Flag para saber que es ingreso manual
                    tieneRuc: !isCedula
                };

                mostrarModalRegistroCliente(datosClienteManual);
                return;
            }

            // Extraer datos según tipo
            const datosCliente = {
                cedula: numero,
                razon_social: isCedula ?
                    response.data.response.nombreCompleto :
                    response.data.main[0].razonSocial,
                direccion: !isCedula ?
                    (response.data.addit.find(est => est.tipoEstablecimiento === 'MAT')?.direccionCompleta || '') :
                    '',
                telefono: '',
                correo: '',
                ingresoManual: false,
                tieneRuc: !isCedula // Flag para saber si es RUC
            };

            // Mostrar modal de registro con datos pre-llenados
            mostrarModalRegistroCliente(datosCliente);

        } catch (error) {
            console.error('❌ Error en consulta:', error);

            // Ocultar loading
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }

            // Fallback: Activar ingreso manual en caso de error
            window.app.showToast('⚠️ Servicio de consulta no disponible. Ingrese los datos manualmente.', 'warning', 4000);

            const isCedula = numero.length === 10;
            const datosClienteManual = {
                cedula: numero,
                razon_social: '',
                direccion: '',
                telefono: '',
                correo: '',
                ingresoManual: true, // Flag para indicar ingreso manual
                tieneRuc: !isCedula
            };

            mostrarModalRegistroCliente(datosClienteManual);
        }
    }

    function mostrarResultadosClientes() {
        const container = document.getElementById('clienteSearchResults');
        const clientes = ventaState.clientesBusqueda || [];

        if (!clientes || clientes.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 15px; margin: 10px 0;">No se encontraron clientes</p>';
            return;
        }

        container.innerHTML = clientes.map((cliente, index) => {
            const isSelected = index === ventaState.clienteSeleccionadoIndex;
            return `
                <div class="search-result-item ${isSelected ? 'selected' : ''}" 
                     onclick="seleccionarCliente('${cliente.cedula}')"
                     style="cursor: pointer;">
                    <strong>${cliente.razon_social}</strong>
                    <small>CI/RUC: ${cliente.cedula}</small>
                    <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
                        ${cliente.correo ? `<i class="fas fa-envelope"></i> ${cliente.correo}` : ''}
                        ${cliente.telefono ? ` | <i class="fas fa-phone"></i> ${cliente.telefono}` : ''}
                    </div>
                </div>
            `;
        }).join('');

        actualizarSeleccionVisualCliente();
    }

    async function seleccionarCliente(cedula) {
        try {
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);
            const { data, error } = await db
                .from('ferre_clientes')
                .select('*')
                .eq('cedula', cedula)
                .single();

            if (error || !data) {
                window.app.showToast('Error al seleccionar cliente', 'danger');
                return;
            }

            // *** VERIFICAR SI ES UN CORREO GENÉRICO ***
            if (data.correo && data.correo.toLowerCase().includes('@cambiar.com')) {
                // Ocultar búsqueda primero
                document.getElementById('clienteBusquedaBox').style.display = 'none';
                document.getElementById('clienteCedula').value = '';
                document.getElementById('clienteSearchResults').innerHTML = '';

                // Remover listener de click fuera
                document.removeEventListener('click', handleClickOutsideClienteSearch);

                // Abrir modal para actualizar datos
                mostrarModalActualizarCliente(data);
                return;  // No seleccionar hasta que actualice los datos
            }

            ventaState.clienteSeleccionado = data;
            mostrarClienteSeleccionado();

            // Ocultar búsqueda y mostrar cliente seleccionado
            document.getElementById('clienteSeleccionadoBox').style.display = 'block';
            document.getElementById('clienteBusquedaBox').style.display = 'none';
            document.getElementById('clienteCedula').value = '';
            document.getElementById('clienteSearchResults').innerHTML = '';

            // Remover listener de click fuera
            document.removeEventListener('click', handleClickOutsideClienteSearch);

            window.app.showToast(`Cliente seleccionado: ${data.razon_social}`, 'success', 2000);

        } catch (error) {
            console.error('Error seleccionando cliente:', error);
            window.app.showToast('Error al seleccionar cliente', 'danger');
        }
    }

    // Función para toggle de búsqueda de cliente (F3)
    function toggleBusquedaCliente() {
        const clienteBox = document.getElementById('clienteSeleccionadoBox');
        const busquedaBox = document.getElementById('clienteBusquedaBox');
        const searchInput = document.getElementById('searchInput');

        // Si la búsqueda de cliente está activa, cancelarla
        if (busquedaBox.style.display === 'block') {
            cancelarBusqueda();
            // Enfocar en búsqueda de productos
            setTimeout(() => {
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }, 100);
        } else {
            // Si no está activa, activarla
            activarBusquedaCliente();
        }
    }

    // Función para activar búsqueda de cliente (F3)
    function activarBusquedaCliente() {
        // Mostrar el campo de búsqueda de cliente
        document.getElementById('clienteSeleccionadoBox').style.display = 'none';
        document.getElementById('clienteBusquedaBox').style.display = 'block';

        // Enfocar en el input de búsqueda de cliente con un pequeño delay para asegurar visibilidad
        setTimeout(() => {
            const inputCliente = document.getElementById('clienteCedula');
            if (inputCliente) {
                inputCliente.focus();
                inputCliente.select();
                asegurarEventosBusquedaCliente();
            }
        }, 50);

        window.app.showToast('<i class="fas fa-search"></i> Buscar cliente - Escribe cédula o nombre', 'info', 2000);
    }

    // Función para buscar con Enter (primer resultado o búsqueda exacta)
    async function buscarClienteDirecto() {
        const query = document.getElementById('clienteCedula').value.trim();

        if (!query) {
            return;
        }

        // Si hay resultados de búsqueda y uno está seleccionado, usar ese
        if (ventaState.clientesBusqueda && ventaState.clientesBusqueda.length > 0 && ventaState.clienteSeleccionadoIndex >= 0) {
            const clienteSeleccionado = ventaState.clientesBusqueda[ventaState.clienteSeleccionadoIndex];
            if (clienteSeleccionado) {
                seleccionarCliente(clienteSeleccionado.cedula);
                return;
            }
        }

        // Si no hay resultados y es cédula/RUC válido, consultar API
        const esNumerico = /^\d+$/.test(query);
        if (esNumerico && (query.length === 10 || query.length === 13)) {
            await consultarYRegistrarCliente(query);
        } else {
            window.app.showToast('No se encontraron clientes', 'warning');
        }
    }

    function mostrarClienteSeleccionado() {
        const cliente = ventaState.clienteSeleccionado;
        const detallesBox = document.getElementById('clienteDetallesBox');
        const btnQuitar = document.getElementById('btnQuitarCliente');
        const btnEditar = document.getElementById('btnEditarCliente');
        const clienteBox = document.getElementById('clienteSeleccionadoBox');

        if (!cliente) {
            // Mostrar Consumidor Final
            document.getElementById('clienteNombreSeleccionado').textContent = 'Consumidor Final';
            document.getElementById('clienteCedulaSeleccionado').textContent = 'CI/RUC: 9999999999999';
            detallesBox.style.display = 'none';
            btnQuitar.style.display = 'none';
            btnEditar.style.display = 'none'; // Ocultar botón editar para Consumidor Final
            clienteBox.classList.add('consumidor-final');
            return;
        }

        // Actualizar datos del cliente (usar razon_social)
        document.getElementById('clienteNombreSeleccionado').textContent = cliente.razon_social;
        document.getElementById('clienteCedulaSeleccionado').textContent = `CI/RUC: ${cliente.cedula}`;
        document.getElementById('clienteCorreoSeleccionado').textContent = cliente.correo || 'No registrado';
        document.getElementById('clienteTelefonoSeleccionado').textContent = cliente.telefono || 'No registrado';

        // Mostrar detalles, botón quitar y botón editar
        detallesBox.style.display = 'block';
        btnQuitar.style.display = 'flex';
        btnEditar.style.display = 'flex'; // Mostrar botón editar para clientes reales
        clienteBox.classList.remove('consumidor-final');
    }

    function asegurarEventosBusquedaCliente() {
        if (window._clienteBusquedaListenerAdded) {
            return;
        }

        const clienteInput = document.getElementById('clienteCedula');
        if (!clienteInput) {
            return;
        }

        let debounceTimer;

        clienteInput.addEventListener('input', function (e) {
            const valor = e.target.value;
            clearTimeout(debounceTimer);

            ventaState.clienteSeleccionadoIndex = 0;

            if (!valor || valor.trim().length === 0) {
                document.getElementById('clienteSearchResults').innerHTML = '';
                ventaState.clientesBusqueda = [];
                ventaState.clienteSeleccionadoIndex = -1;
                return;
            }

            const resultsContainer = document.getElementById('clienteSearchResults');
            if (resultsContainer) {
                resultsContainer.scrollTop = 0;
            }

            debounceTimer = setTimeout(() => {
                buscarCliente();
            }, 300);
        });

        clienteInput.addEventListener('keydown', function (e) {
            const resultsContainer = document.getElementById('clienteSearchResults');
            const resultItems = resultsContainer?.querySelectorAll('.search-result-item') || [];

            if (resultItems.length === 0) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarClienteDirecto();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelarBusqueda();
                }
                return;
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                e.stopPropagation();
                navegarClientes(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                e.stopPropagation();
                navegarClientes(-1);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                buscarClienteDirecto();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                e.stopPropagation();
                cancelarBusqueda();
            }
        });

        window._clienteBusquedaListenerAdded = true;
    }

    function cambiarCliente() {
        // Limpiar input de búsqueda
        document.getElementById('clienteCedula').value = '';
        document.getElementById('clienteSearchResults').innerHTML = '';
        ventaState.clientesBusqueda = [];
        ventaState.clienteSeleccionadoIndex = -1;

        // Mostrar formulario de búsqueda
        document.getElementById('clienteSeleccionadoBox').style.display = 'none';
        document.getElementById('clienteBusquedaBox').style.display = 'block';

        // Enfocar en el input
        setTimeout(() => {
            const input = document.getElementById('clienteCedula');
            if (input) {
                input.focus();
                input.select();
                asegurarEventosBusquedaCliente();
            }
        }, 100);

        // Agregar listener para click fuera del formulario
        setTimeout(() => {
            document.addEventListener('click', handleClickOutsideClienteSearch);
        }, 200);
    }

    // Navegar resultados de búsqueda de clientes con flechas (arriba/abajo)
    function navegarClientes(direccion) {
        if (!ventaState.clientesBusqueda || ventaState.clientesBusqueda.length === 0) return;

        ventaState.clienteSeleccionadoIndex += direccion;

        // Limitar índice con wrap-around
        if (ventaState.clienteSeleccionadoIndex < 0) {
            ventaState.clienteSeleccionadoIndex = ventaState.clientesBusqueda.length - 1;
        } else if (ventaState.clienteSeleccionadoIndex >= ventaState.clientesBusqueda.length) {
            ventaState.clienteSeleccionadoIndex = 0;
        }

        actualizarSeleccionVisualCliente();
        scrollToSelectedCliente();
    }

    function actualizarSeleccionVisualCliente() {
        const resultsContainer = document.getElementById('clienteSearchResults');
        if (!resultsContainer) return;

        const resultItems = resultsContainer.querySelectorAll('.search-result-item');
        if (resultItems.length === 0) return;

        resultItems.forEach((item, index) => {
            if (index === ventaState.clienteSeleccionadoIndex) {
                item.classList.add('selected');
                item.style.backgroundColor = '#e8f4f8';
                item.style.borderLeft = '3px solid #2196F3';
            } else {
                item.classList.remove('selected');
                item.style.backgroundColor = '';
                item.style.borderLeft = '';
            }
        });
    }

    function scrollToSelectedCliente() {
        const resultsContainer = document.getElementById('clienteSearchResults');
        if (!resultsContainer) return;

        const selectedItem = resultsContainer.querySelector('.search-result-item.selected');
        if (!selectedItem) return;

        const containerRect = resultsContainer.getBoundingClientRect();
        const itemRect = selectedItem.getBoundingClientRect();

        const itemTop = itemRect.top - containerRect.top + resultsContainer.scrollTop;
        const itemBottom = itemTop + itemRect.height;
        const visibleTop = resultsContainer.scrollTop;
        const visibleBottom = visibleTop + containerRect.height;

        // Si el item está fuera de la vista, hacer scroll
        if (itemBottom > visibleBottom) {
            // Item está abajo, scroll hacia abajo
            resultsContainer.scrollTop = itemBottom - containerRect.height;
        } else if (itemTop < visibleTop) {
            // Item está arriba, scroll hacia arriba
            resultsContainer.scrollTop = itemTop;
        }
    }

    function cancelarBusqueda() {
        // Volver a mostrar el cliente actual (o consumidor final)
        document.getElementById('clienteSeleccionadoBox').style.display = 'block';
        document.getElementById('clienteBusquedaBox').style.display = 'none';
        document.getElementById('clienteCedula').value = '';
        document.getElementById('clienteSearchResults').innerHTML = '';
        ventaState.clientesBusqueda = [];
        ventaState.clienteSeleccionadoIndex = -1;

        // Remover listener de click fuera
        document.removeEventListener('click', handleClickOutsideClienteSearch);
    }

    function handleClickOutsideClienteSearch(e) {
        const busquedaBox = document.getElementById('clienteBusquedaBox');
        const clienteBox = document.getElementById('clienteSeleccionadoBox');

        // Verificar si el clic fue fuera del formulario de búsqueda
        if (busquedaBox.style.display === 'block' &&
            !busquedaBox.contains(e.target) &&
            !clienteBox.contains(e.target)) {

            const inputValue = document.getElementById('clienteCedula').value.trim();

            // Solo cancelar si no hay nada escrito
            if (!inputValue) {
                cancelarBusqueda();
            }
        }
    }

    function borrarCliente() {
        ventaState.clienteSeleccionado = null;
        mostrarClienteSeleccionado();
        cancelarBusqueda();

        // Remover listener si existe
        document.removeEventListener('click', handleClickOutsideClienteSearch);

        window.app.showToast('Cliente removido - Consumidor Final activo', 'info', 2000);
    }

    function editarCliente() {
        const cliente = ventaState.clienteSeleccionado;

        if (!cliente) {
            window.app.showToast('No hay cliente seleccionado para editar', 'warning', 2000);
            return;
        }

        // Abrir modal de actualización con los datos actuales del cliente
        mostrarModalActualizarCliente(cliente);
    }

    // Exportar funciones al scope global
    window.buscarCliente = buscarCliente;
    window.seleccionarCliente = seleccionarCliente;
    window.buscarClienteDirecto = buscarClienteDirecto;
    window.cambiarCliente = cambiarCliente;
    window.cancelarBusqueda = cancelarBusqueda;
    window.borrarCliente = borrarCliente;
    window.editarCliente = editarCliente;

    // =====================================================
    // PROCESAR VENTA
    // =====================================================

    function procesarVenta() {
        if (ventaState.carrito.length === 0) {
            window.app.showToast('El carrito está vacío', 'warning');
            return;
        }

        // Mostrar modal de confirmación
        mostrarModalVenta();
    }

    function mostrarModalVenta() {
        // El precio ya incluye IVA
        const totalConIva = ventaState.carrito.reduce((sum, item) => sum + (item.cantidad * item.precio), 0);

        // Información del cliente
        const cliente = ventaState.clienteSeleccionado;
        const clienteHTML = cliente ? `
            <div class="cliente-nombre">${cliente.razon_social}</div>
            <div class="cliente-detalle">
                <i class="fas fa-id-card"></i>
                <span>${cliente.cedula}</span>
            </div>
        ` : `
            <div class="cliente-nombre">Consumidor Final</div>
            <div class="cliente-detalle">
                <i class="fas fa-id-card"></i>
                <span>9999999999999</span>
            </div>
        `;

        document.getElementById('modalClienteInfo').innerHTML = clienteHTML;
        document.getElementById('modalClienteInfo').className = cliente ? 'cliente-info-card' : 'cliente-info-card consumidor-final';

        // Total
        document.getElementById('modalTotal').textContent = window.app.formatCurrency(totalConIva);

        // Input de pago
        document.getElementById('pagadoCon').value = totalConIva.toFixed(2);

        // Establecer tipo de comprobante por defecto (RECIBO)
        if (!ventaState.tipoComprobante) {
            ventaState.tipoComprobante = 'RECIBO';
        }

        // Actualizar UI del selector de tipo
        const btnTipoSelector = document.querySelector(`[data-tipo="${ventaState.tipoComprobante}"]`);
        if (btnTipoSelector) {
            document.querySelectorAll('.btn-tipo-comprobante').forEach(btn => {
                btn.classList.remove('active');
            });
            btnTipoSelector.classList.add('active');
        }

        // Mostrar modal
        document.getElementById('modalVenta').classList.add('active');

        // Initial Payment Type State (Default to Effective)
        const radioEfectivo = document.querySelector('input[name="tipoPagoVenta"][value="EFECTIVO"]');
        if (radioEfectivo) {
            radioEfectivo.checked = true;
            if (typeof cambiarTipoPagoVenta === 'function') cambiarTipoPagoVenta();
        }

        // SOLUCIÓN BUG: Forzar habilitación del botón antes de calcular
        const btnConfirmar = document.getElementById('btnConfirmarVenta');
        if (btnConfirmar) {
            btnConfirmar.disabled = false;
            btnConfirmar.style.opacity = '1';
            btnConfirmar.style.cursor = 'pointer';
        }

        // Focus en el input de pago
        setTimeout(() => {
            const inputPagado = document.getElementById('pagadoCon');
            if (inputPagado) {
                // Agregar listener de respaldo por si oninput falla
                inputPagado.addEventListener('change', calcularVuelto);
                inputPagado.addEventListener('keyup', calcularVuelto);

                inputPagado.focus();
                inputPagado.select();
            }

            // Calcular vuelto después de que el modal esté listo
            calcularVuelto();

            // Validación de seguridad: recalcular después de 200ms
            setTimeout(() => {
                calcularVuelto();
                console.log('✅ Modal de venta listo. Botón:', btnConfirmar ? (btnConfirmar.disabled ? 'DESHABILITADO' : 'HABILITADO') : 'NO ENCONTRADO');
            }, 200);
        }, 100);
    }

    window.cambiarTipoPagoVenta = cambiarTipoPagoVenta;

    function cambiarTipoPagoVenta() {
        const radio = document.querySelector('input[name="tipoPagoVenta"]:checked');
        if (!radio) return;
        const tipo = radio.value;
        const pagoGroup = document.getElementById('pagoGroupEfectivo');
        const infoTransfer = document.getElementById('infoTransferencia');
        const vueltoSection = document.getElementById('vueltoSection');
        const inputPagado = document.getElementById('pagadoCon');
        const labelPagado = document.getElementById('labelPagadoCon');

        if (tipo === 'EFECTIVO') {
            if (pagoGroup) pagoGroup.style.display = 'block';
            if (infoTransfer) infoTransfer.style.display = 'none';
            if (vueltoSection) vueltoSection.style.display = 'flex';
            if (inputPagado) inputPagado.disabled = false;
        } else if (tipo === 'TRANSFERENCIA') {
            if (pagoGroup) pagoGroup.style.display = 'none';
            if (infoTransfer) infoTransfer.style.display = 'block';
            if (vueltoSection) vueltoSection.style.display = 'none';
            // Para transferencia, asumimos monto exacto
            if (inputPagado) {
                const totalConIva = Math.round(ventaState.carrito.reduce((sum, item) => sum + (item.cantidad * item.precio), 0) * 100) / 100;
                inputPagado.value = totalConIva.toFixed(2);
            }
        } else if (tipo === 'MIXTO') {
            if (pagoGroup) pagoGroup.style.display = 'block';
            if (infoTransfer) infoTransfer.style.display = 'block';
            if (vueltoSection) vueltoSection.style.display = 'none';
            if (inputPagado) {
                inputPagado.disabled = false;
                // Limpiar valor o dejarlo en 0 para que el usuario ingrese
                // Un valor por defecto ayuda
                inputPagado.value = "0.00";
                inputPagado.focus();
                inputPagado.select();
            }
        }
        calcularVuelto();
    }

    function calcularVuelto() {
        // Redondear a 2 decimales para evitar problemas de precisión de float
        const totalConIva = Math.round(ventaState.carrito.reduce((sum, item) => sum + (item.cantidad * item.precio), 0) * 100) / 100;

        const inputPagado = document.getElementById('pagadoCon');
        const pagadoConRaw = parseFloat(inputPagado ? inputPagado.value : 0);
        const pagadoCon = isNaN(pagadoConRaw) ? 0 : Math.round(pagadoConRaw * 100) / 100;

        const radio = document.querySelector('input[name="tipoPagoVenta"]:checked');
        const tipoPago = radio ? radio.value : 'EFECTIVO';

        let vuelto = 0;
        let montoTransferencia = 0;
        let isValid = true;
        let msg = '';

        if (tipoPago === 'EFECTIVO') {
            // Efectivo: Pago debe ser >= Total
            if (pagadoCon < totalConIva - 0.01) {
                isValid = false;
                msg = `Faltan $${(totalConIva - pagadoCon).toFixed(2)}`;
            }
            vuelto = Math.max(0, pagadoCon - totalConIva);
            montoTransferencia = 0;

        } else if (tipoPago === 'TRANSFERENCIA') {
            // Transferencia: Monto exacto (automático).
            // Input ignorado para validación, asumimos total.
            vuelto = 0;
            montoTransferencia = totalConIva;
            isValid = true;

        } else if (tipoPago === 'MIXTO') {
            // Mixto: Pago (Efectivo) puede ser < Total. El resto es Transferencia.
            // Si Pago (Efectivo) > Total -> Error? O cambio?
            // "si es mixto es el unico que podemos poner en el campo un valor menor al total"
            if (pagadoCon > totalConIva) {
                // Si pone más efectivo que el total, ya no es mixto real, es efectivo con vuelto.
                // Pero permitimos, con transferencia = 0.
                vuelto = pagadoCon - totalConIva;
                montoTransferencia = 0;
            } else {
                vuelto = 0;
                montoTransferencia = totalConIva - pagadoCon;
            }
            isValid = true; // Siempre válido a menos que sea negativo
        }

        const vueltoDisplay = document.getElementById('vueltoDisplay');
        if (vueltoDisplay) vueltoDisplay.textContent = window.app.formatCurrency(vuelto);

        const transferDisplay = document.getElementById('montoTransferenciaDisplay');
        if (transferDisplay) transferDisplay.textContent = window.app.formatCurrency(montoTransferencia);

        // Deshabilitar botón si no es válido
        const btnConfirmar = document.getElementById('btnConfirmarVenta');

        if (!btnConfirmar) return;

        if (!isValid) {
            btnConfirmar.disabled = true;
            btnConfirmar.style.opacity = '0.5';
            btnConfirmar.style.cursor = 'not-allowed';
            btnConfirmar.title = msg;
        } else {
            btnConfirmar.disabled = false;
            btnConfirmar.style.opacity = '1';
            btnConfirmar.style.cursor = 'pointer';
            btnConfirmar.title = 'Confirmar venta';
        }
    }

    function seleccionarTipoComprobante(tipo) {
        // Actualizar estado
        ventaState.tipoComprobante = tipo;

        // Actualizar UI - remover active de todos
        document.querySelectorAll('.btn-tipo-comprobante').forEach(btn => {
            btn.classList.remove('active');
        });

        // Agregar active al seleccionado
        document.querySelector(`[data-tipo="${tipo}"]`).classList.add('active');
    }

    async function procesarVentaConValidacion() {
        // Validar que el carrito no esté vacío
        if (ventaState.carrito.length === 0) {
            window.app.showToast('<i class="fas fa-exclamation-triangle"></i> El carrito está vacío. Agrega productos para continuar.', 'warning', 3000);
            return;
        }

        const hoyISO = obtenerFechaISOHoy();
        if (!ventaState.cajaInicial || ventaState.cajaInicial.fecha !== hoyISO) {
            await verificarCajaInicialDelDia({ forceConsulta: true });
            if (!ventaState.cajaInicial || ventaState.cajaInicial.fecha !== hoyISO) {
                window.app.showToast('<i class="fas fa-door-closed"></i> Debes registrar la caja inicial antes de confirmar una venta.', 'warning', 3500);
                mostrarModalCajaInicial({ focusMonto: true });
                return;
            }
        }

        // SOLUCIÓN BUG: Validación de seguridad del botón
        const btnConfirmar = document.getElementById('btnConfirmarVenta');
        if (btnConfirmar && btnConfirmar.disabled) {
            // Si el botón está deshabilitado, recalcular vuelto
            console.warn('⚠️ Botón deshabilitado detectado. Recalculando...');
            calcularVuelto();

            // Si sigue deshabilitado después de recalcular, verificar pago
            setTimeout(() => {
                if (btnConfirmar.disabled) {
                    const totalConIva = Math.round(ventaState.carrito.reduce((sum, item) => sum + (item.cantidad * item.precio), 0) * 100) / 100;
                    const pagadoCon = Math.round((parseFloat(document.getElementById('pagadoCon').value) || 0) * 100) / 100;

                    const radio = document.querySelector('input[name="tipoPagoVenta"]:checked');
                    const tipoPago = radio ? radio.value : 'EFECTIVO';

                    // Solo validar monto si es EFECTIVO. Transferencia y Mixto siempre habilitan.
                    if (tipoPago !== 'EFECTIVO' || pagadoCon >= totalConIva - 0.01) {
                        // Forzar habilitación
                        console.log('✅ Forzando habilitación del botón (pago suficiente o no efectivo)');
                        btnConfirmar.disabled = false;
                        btnConfirmar.style.opacity = '1';
                        btnConfirmar.style.cursor = 'pointer';
                    } else {
                        window.app.showToast(`⚠️ El monto pagado ($${pagadoCon.toFixed(2)}) es menor al total ($${totalConIva.toFixed(2)})`, 'warning', 3000);
                        return;
                    }
                }
            }, 50);
        }

        const cliente = ventaState.clienteSeleccionado;
        const tipoComprobante = ventaState.tipoComprobante;
        const esConsumidorFinal = !cliente || cliente.cedula === '9999999999999';

        // Caso 1: Consumidor Final + Recibo → Procesar directo
        if (esConsumidorFinal && tipoComprobante === 'RECIBO') {
            confirmarVenta();
            return;
        }

        // Caso 2: Cliente + Factura → Procesar directo
        if (!esConsumidorFinal && tipoComprobante === 'FACTURA') {
            confirmarVenta();
            return;
        }

        // Caso 3: Cliente + Recibo → Alerta
        if (!esConsumidorFinal && tipoComprobante === 'RECIBO') {
            mostrarAlertaClienteConRecibo();
            return;
        }

        // Caso 4: Consumidor Final + Factura → Alerta
        if (esConsumidorFinal && tipoComprobante === 'FACTURA') {
            mostrarAlertaConsumidorFinalConFactura();
            return;
        }
    }

    function mostrarAlertaClienteConRecibo() {
        const cliente = ventaState.clienteSeleccionado;

        mostrarConfirmacion(
            '<i class="fas fa-exclamation-triangle"></i> Cliente Seleccionado',
            `Tienes seleccionado a <strong>${cliente.razon_social}</strong>.<br>¿Estás seguro de que deseas emitir un <strong>RECIBO</strong>?`,
            [
                {
                    texto: '<i class="fas fa-receipt"></i> Sí, Emitir Recibo',
                    clase: 'custom-confirm-btn custom-confirm-btn-confirm',
                    callback: () => {
                        confirmarVenta();
                    }
                },
                {
                    texto: '<i class="fas fa-file-invoice-dollar"></i> Cambiar a Factura',
                    clase: 'custom-confirm-btn custom-confirm-btn-primary',
                    callback: () => {
                        seleccionarTipoComprobante('FACTURA');
                        window.app.showToast('Cambiado a Factura. Presiona "Confirmar Venta" para continuar.', 'info', 3000);
                    }
                }
            ]
        );
    }

    function mostrarAlertaConsumidorFinalConFactura() {
        mostrarConfirmacion(
            '<i class="fas fa-exclamation-triangle"></i> Consumidor Final',
            '¿Estás seguro de que deseas emitir una <strong>FACTURA</strong> con Consumidor Final?',
            [
                {
                    texto: '<i class="fas fa-user-plus"></i> Agregar Cliente',
                    clase: 'custom-confirm-btn custom-confirm-btn-primary',
                    callback: () => {
                        cerrarModalVenta();
                        cambiarCliente();
                        window.app.showToast('Busca y selecciona un cliente para la factura', 'info', 3000);
                    }
                },
                {
                    texto: '<i class="fas fa-file-invoice-dollar"></i> Sí, Emitir Factura',
                    clase: 'custom-confirm-btn custom-confirm-btn-confirm',
                    callback: () => {
                        confirmarVenta();
                    }
                },
                {
                    texto: '<i class="fas fa-receipt"></i> Cambiar a Recibo',
                    clase: 'custom-confirm-btn custom-confirm-btn-secondary',
                    callback: () => {
                        seleccionarTipoComprobante('RECIBO');
                        confirmarVenta();
                    }
                }
            ]
        );
    }

    function cerrarModalVenta() {
        document.getElementById('modalVenta').classList.remove('active');
    }

    // Funciones para Modal de Cantidad Rápida
    function mostrarModalCantidadRapida(producto) {
        if (!producto) return;

        // Actualizar información del producto en el modal
        const modalProducto = document.getElementById('modalCantidadProducto');
        const modalStock = document.getElementById('modalCantidadStock');
        const inputCantidad = document.getElementById('modalCantidadInput');
        const modal = document.getElementById('modalCantidadOverlay');

        if (!modalProducto || !modalStock || !inputCantidad || !modal) {
            console.error('❌ No se encontraron todos los elementos del modal');
            return;
        }

        // Calcular stock disponible (restando lo que ya está en el carrito)
        const enCarrito = ventaState.carrito.find(item => item.codigo === producto.codigo);
        const cantidadEnCarrito = enCarrito ? enCarrito.cantidad : 0;
        const stockDisponible = (producto.stock || 0) - cantidadEnCarrito;

        modalProducto.textContent = producto.producto;
        modalStock.textContent = `Stock disponible: ${stockDisponible}`;

        // Limpiar y preparar input
        inputCantidad.value = '';
        inputCantidad.max = stockDisponible; // Establecer límite máximo

        // Mostrar modal
        modal.classList.add('active');

        // Enfocar input después de la animación
        setTimeout(() => {
            inputCantidad.focus();
        }, 100);

        // Guardar producto temporalmente con stock disponible
        ventaState.productoTemporal = {
            ...producto,
            stockDisponible: stockDisponible
        };
    }

    function cerrarModalCantidad() {
        const modal = document.getElementById('modalCantidadOverlay');
        modal.classList.remove('active');

        // Limpiar datos temporales
        ventaState.productoTemporal = null;
        document.getElementById('modalCantidadInput').value = '';

        // Volver a enfocar búsqueda
        setTimeout(() => {
            document.getElementById('searchInput').focus();
        }, 200);
    }

    function confirmarCantidadRapida() {
        const producto = ventaState.productoTemporal;
        if (!producto) return;

        const inputCantidad = document.getElementById('modalCantidadInput');
        const cantidad = parseFloat(inputCantidad.value);

        // Validar cantidad
        if (!cantidad || cantidad <= 0) {
            window.app.showToast('Ingrese una cantidad válida', 'warning', 2000);
            inputCantidad.focus();
            return;
        }

        // Validar stock disponible (ya considerando lo que está en el carrito)
        if (cantidad > producto.stockDisponible) {
            window.app.showToast(`Stock insuficiente. Disponible: ${producto.stockDisponible}`, 'warning', 3000);
            inputCantidad.focus();
            return;
        }

        // Verificar si el producto ya está en el carrito
        const productoExistente = ventaState.carrito.find(item => item.codigo === producto.codigo);

        if (productoExistente) {
            // Si ya existe, incrementar la cantidad
            productoExistente.cantidad += cantidad;
        } else {
            // Si no existe, agregar nuevo item con la cantidad especificada
            ventaState.carrito.push({
                codigo: producto.codigo,
                nombre: producto.producto,
                precio: producto.precio,
                cantidad: cantidad,
                stock: producto.stock,
                costo: producto.costo || 0,
                unidad: producto.unidad_paquete || 'UNIDADES'
            });
        }

        // Actualizar vista y guardar
        actualizarCarrito();
        guardarCarritoEnCache();

        // Limpiar búsqueda
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
        ventaState.busquedaResultados = [];
        ventaState.busquedaSeleccionado = -1;

        // Mostrar confirmación
        window.app.showToast(`✓ ${cantidad} unidad(es) agregada(s)`, 'success', 2000);

        // Cerrar modal
        cerrarModalCantidad();
    }

    // Exportar funciones al scope global para que los botones onclick puedan accederlas
    window.mostrarModalCantidadRapida = mostrarModalCantidadRapida;
    window.cerrarModalCantidad = cerrarModalCantidad;
    window.confirmarCantidadRapida = confirmarCantidadRapida;

    // ========= MODAL DE INGRESO DIRECTO POR CÓDIGO =========
    let cantidadPredefinida = 1; // Variable global para la cantidad

    function mostrarModalIngresoDirecto(codigoInicial = '', cantidad = 1) {
        const modal = document.getElementById('modalIngresoDirecto');
        const inputCodigo = document.getElementById('modalIngresoCodigoInput');
        const mensaje = document.getElementById('modalIngresoMensaje');
        const cantidadTexto = document.getElementById('modalIngresoCantidadTexto');
        const titulo = document.getElementById('modalIngresoDirectoTitulo');

        // Guardar cantidad predefinida
        cantidadPredefinida = cantidad;

        // Actualizar título y cantidad
        titulo.innerHTML = `<i class="fas fa-barcode"></i> Escanee el Producto para Agregar ${cantidad} Unidad(es)`;
        cantidadTexto.textContent = cantidad;

        // Limpiar y preparar input
        inputCodigo.value = codigoInicial;
        mensaje.style.display = 'none';

        // Mostrar modal
        modal.classList.add('active');

        // Enfocar input de código
        setTimeout(() => {
            inputCodigo.focus();
            if (codigoInicial) {
                inputCodigo.select();
            }
        }, 100);
    }

    function cerrarModalIngresoDirecto() {
        const modal = document.getElementById('modalIngresoDirecto');
        modal.classList.remove('active');

        // Resetear cantidad predefinida
        cantidadPredefinida = 1;

        // Limpiar inputs
        document.getElementById('modalIngresoCodigoInput').value = '';
        document.getElementById('modalIngresoMensaje').style.display = 'none';

        // Volver a enfocar búsqueda
        setTimeout(() => {
            document.getElementById('searchInput').focus();
        }, 200);
    }

    async function confirmarIngresoDirecto() {
        const inputCodigo = document.getElementById('modalIngresoCodigoInput');
        const mensaje = document.getElementById('modalIngresoMensaje');

        let codigo = inputCodigo.value.trim();
        const cantidad = cantidadPredefinida;

        // Validar código
        if (!codigo) {
            mostrarMensajeModal('⚠️ Ingresa o escanea un código de producto', 'warning');
            inputCodigo.focus();
            return;
        }

        // Suprimir 0 inicial si tiene 5+ dígitos numéricos
        if (/^0\d{4,}$/.test(codigo)) {
            codigo = codigo.replace(/^0+/, '') || '0';
            console.log(`🧮 Código limpiado en modal: ${inputCodigo.value} → ${codigo}`);
        }

        try {
            // Buscar producto por código EXACTO
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

            // Buscar primero en caché
            let producto = null;
            if (cargaInicialCompleta && window.inventarioCache.productos) {
                producto = window.inventarioCache.productos.find(p => p.codigo === codigo);
            }

            // Si no está en caché, buscar en BD
            if (!producto) {
                const { data, error } = await db
                    .from('ferre_inventario')
                    .select('*')
                    .eq('codigo', codigo)
                    .single();

                if (error || !data) {
                    mostrarMensajeModal(`❌ Producto no encontrado: ${codigo}`, 'danger');
                    inputCodigo.focus();
                    inputCodigo.select();
                    return;
                }

                producto = data;
            }

            // Verificar stock
            if (producto.stock <= 0) {
                mostrarMensajeModal('⚠️ Producto sin stock disponible', 'danger');
                return;
            }

            // Calcular stock disponible
            const enCarrito = ventaState.carrito.find(item => item.codigo === producto.codigo);
            const cantidadEnCarrito = enCarrito ? enCarrito.cantidad : 0;
            const stockDisponible = producto.stock - cantidadEnCarrito;

            // Validar que no exceda stock
            if (cantidad > stockDisponible) {
                mostrarMensajeModal(`⚠️ Stock insuficiente. Disponible: ${stockDisponible}`, 'warning');
                return;
            }

            // Agregar al carrito
            if (enCarrito) {
                enCarrito.cantidad += cantidad;
            } else {
                ventaState.carrito.unshift({
                    codigo: producto.codigo,
                    nombre: producto.producto,
                    precio: producto.precio,
                    cantidad: cantidad,
                    stock: producto.stock,
                    costo: producto.costo || 0,
                    unidad: producto.unidad_paquete || 'UNIDADES'
                });
            }

            // Actualizar vista
            actualizarCarrito();
            guardarCarritoEnCache();

            // Limpiar búsqueda
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
            ventaState.busquedaResultados = [];
            ventaState.busquedaSeleccionado = -1;

            // Mostrar confirmación
            window.app.showToast(`✓ ${cantidad} × ${producto.producto}`, 'success', 2000);

            // Cerrar modal
            cerrarModalIngresoDirecto();

        } catch (error) {
            console.error('Error al buscar producto:', error);
            mostrarMensajeModal('❌ Error al buscar producto', 'danger');
        }
    }

    function mostrarMensajeModal(texto, tipo) {
        const mensaje = document.getElementById('modalIngresoMensaje');
        mensaje.textContent = texto;
        mensaje.style.display = 'block';

        // Colores según tipo
        if (tipo === 'warning') {
            mensaje.style.background = '#fff3cd';
            mensaje.style.color = '#856404';
            mensaje.style.border = '1px solid #ffc107';
        } else if (tipo === 'danger') {
            mensaje.style.background = '#f8d7da';
            mensaje.style.color = '#721c24';
            mensaje.style.border = '1px solid #dc3545';
        } else {
            mensaje.style.background = '#d1ecf1';
            mensaje.style.color = '#0c5460';
            mensaje.style.border = '1px solid #17a2b8';
        }
    }

    // Exportar funciones al scope global
    window.mostrarModalIngresoDirecto = mostrarModalIngresoDirecto;
    window.cerrarModalIngresoDirecto = cerrarModalIngresoDirecto;
    window.confirmarIngresoDirecto = confirmarIngresoDirecto;

    // ========= MODAL DE SELECCIÓN DE PRODUCTO =========
    function mostrarModalSeleccionProducto(productos) {
        const modal = document.getElementById('modalSeleccionProducto');
        const opcionesContainer = document.getElementById('opcionesProductos');

        // Limpiar opciones previas
        opcionesContainer.innerHTML = '';

        // Crear opción para cada producto
        productos.forEach((producto, index) => {
            const esPaquete = !producto.codigo.endsWith('001');
            const iconoTipo = esPaquete ? 'fa-boxes' : 'fa-box';
            const labelTipo = esPaquete ? 'PAQUETE/FUNDA' : 'UNIDADES';
            const colorTipo = esPaquete ? '#2196F3' : '#4CAF50';

            // Calcular stock disponible (descontando lo que está en el carrito)
            const enCarrito = ventaState.carrito.find(item => item.codigo === producto.codigo);
            const cantidadEnCarrito = enCarrito ? enCarrito.cantidad : 0;
            const stockDisponible = producto.stock - cantidadEnCarrito;

            const opcion = document.createElement('div');
            opcion.style.cssText = `
                padding: 20px;
                border: 2px solid ${colorTipo};
                border-radius: 12px;
                background: white;
                display: grid;
                grid-template-columns: auto 1fr auto;
                align-items: center;
                gap: 20px;
                transition: all 0.3s;
            `;

            const inputId = `cantidadProducto${index}`;
            const cantidadInicial = esPaquete ? 0 : 1; // Unidades por defecto en 1

            // Mostrar alerta si no hay stock disponible
            const stockInfo = stockDisponible > 0
                ? `Stock: <strong style="color: ${colorTipo};">${stockDisponible}</strong>`
                : `<strong style="color: #f44336;">SIN STOCK</strong>`;

            const carritoInfo = cantidadEnCarrito > 0
                ? ` <span style="color: #ff9800; font-size: 0.85em;">(${cantidadEnCarrito} en carrito)</span>`
                : '';

            opcion.innerHTML = `
                <div style="text-align: center;">
                    <i class="fas ${iconoTipo}" style="font-size: 2.5em; color: ${colorTipo}; margin-bottom: 8px;"></i>
                    <div style="background: ${colorTipo}; color: white; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 0.85em;">
                        ${labelTipo}
                    </div>
                </div>
                <div>
                    <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 5px; color: #333;">${producto.producto}</div>
                    <div style="color: #666; font-size: 0.9em; margin-bottom: 3px;">Código: <strong>${producto.codigo}</strong></div>
                    <div style="color: #666; font-size: 0.9em;">${stockInfo}${carritoInfo} | Precio: <strong style="color: #d4a017;">$${producto.precio.toFixed(2)}</strong></div>
                </div>
                <div style="text-align: center; min-width: 120px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.9em; font-weight: 600;">Cantidad:</label>
                    <input 
                        type="number" 
                        id="${inputId}"
                        class="input-cantidad-seleccion"
                        value="${cantidadInicial}"
                        min="0"
                        max="${stockDisponible}"
                        step="0.001"
                        style="width: 100%; padding: 12px; font-size: 1.2em; font-weight: bold; text-align: center; border: 2px solid ${colorTipo}; border-radius: 8px; outline: none;"
                        data-codigo="${producto.codigo}"
                        data-producto='${JSON.stringify(producto).replace(/'/g, "&apos;")}'
                        data-stock-disponible="${stockDisponible}"
                        ${stockDisponible <= 0 ? 'disabled' : ''}
                    >
                </div>
            `;

            opcionesContainer.appendChild(opcion);

            // Agregar event listeners después de insertar en el DOM
            setTimeout(() => {
                const input = document.getElementById(inputId);
                if (!input) return;

                // Enfocar el input de unidades por defecto (solo si tiene stock)
                if (!esPaquete && stockDisponible > 0) {
                    input.focus();
                    input.select();
                } else if (esPaquete && stockDisponible > 0) {
                    // Si unidades no tiene stock, enfocar paquete si tiene
                    const inputUnidades = document.getElementById(`cantidadProducto${1 - index}`);
                    if (!inputUnidades || inputUnidades.disabled) {
                        input.focus();
                        input.select();
                    }
                }

                // Cambiar borde al enfocar
                input.addEventListener('focus', function () {
                    this.style.borderColor = colorTipo;
                    this.style.boxShadow = `0 0 0 3px ${colorTipo}33`;
                    opcion.style.borderColor = colorTipo;
                    opcion.style.boxShadow = `0 4px 12px ${colorTipo}44`;
                    opcion.style.transform = 'scale(1.02)';
                });

                input.addEventListener('blur', function () {
                    this.style.boxShadow = 'none';
                    opcion.style.boxShadow = 'none';
                    opcion.style.transform = 'scale(1)';
                });

                // Enter para agregar
                input.addEventListener('keydown', async function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        const cantidad = parseFloat(this.value);
                        const stockDisponible = parseFloat(this.dataset.stockDisponible);

                        if (cantidad > 0) {
                            const codigo = this.dataset.codigo;
                            const productoData = JSON.parse(this.dataset.producto);

                            // Validar stock disponible (descontando lo que ya está en el carrito)
                            if (cantidad > stockDisponible) {
                                window.app.showToast(`Stock insuficiente. Disponible: ${stockDisponible}`, 'warning', 3000);
                                this.value = stockDisponible;
                                return;
                            }

                            cerrarModalSeleccionProducto();

                            // Agregar al carrito con la cantidad especificada
                            await agregarAlCarritoConCantidad(productoData, cantidad);

                            // Enfocar búsqueda inmediatamente
                            document.getElementById('searchInput').focus();
                        } else {
                            window.app.showToast('Ingrese una cantidad mayor a 0', 'warning', 2000);
                            this.focus();
                        }
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        // Buscar el otro input
                        const inputs = opcionesContainer.querySelectorAll('.input-cantidad-seleccion:not([disabled])');
                        const currentIndex = Array.from(inputs).indexOf(this);
                        const nextIndex = (currentIndex + 1) % inputs.length;
                        inputs[nextIndex].focus();
                        inputs[nextIndex].select();
                    } else if (e.key === 'Escape') {
                        cerrarModalSeleccionProducto();
                    }
                });

                // Validar que no sea negativo ni mayor al stock disponible
                input.addEventListener('input', function () {
                    const stockDisponible = parseFloat(this.dataset.stockDisponible);
                    if (this.value < 0) this.value = 0;
                    if (this.value > stockDisponible) this.value = stockDisponible;
                });
            }, 50);
        });

        // Mostrar modal
        modal.classList.add('active');
    }

    async function agregarAlCarritoConCantidad(producto, cantidad) {
        // Verificar stock real en BD antes de agregar
        try {
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

            const { data: productoActual, error } = await db
                .from('ferre_inventario')
                .select('stock, precio')
                .eq('codigo', producto.codigo)
                .single();

            if (error || !productoActual) {
                window.app.showToast('Error al verificar stock', 'danger');
                return;
            }

            // Actualizar stock y precio
            producto.stock = productoActual.stock;
            producto.precio = productoActual.precio;

        } catch (error) {
            console.error('Error verificando stock:', error);
        }

        // Verificar stock
        if (producto.stock <= 0) {
            window.app.showToast('⚠️ Producto sin stock disponible', 'danger');
            return;
        }

        if (cantidad > producto.stock) {
            window.app.showToast(`Stock insuficiente. Disponible: ${producto.stock}`, 'warning');
            return;
        }

        // Buscar si ya existe en el carrito
        const existente = ventaState.carrito.find(item => item.codigo === producto.codigo);

        if (existente) {
            // Verificar que no exceda el stock
            if (existente.cantidad + cantidad > producto.stock) {
                window.app.showToast('No hay suficiente stock disponible', 'warning');
                return;
            }
            existente.cantidad += cantidad;
        } else {
            // Agregar al inicio del array
            ventaState.carrito.unshift({
                codigo: producto.codigo,
                nombre: producto.producto,
                precio: producto.precio,
                cantidad: cantidad,
                stock: producto.stock,
                costo: producto.costo || 0,
                unidad: producto.unidad_paquete || 'UNIDADES'
            });
        }

        actualizarCarrito();
        guardarCarritoEnCache();

        // Hacer scroll al inicio del carrito
        const carritoColumn = document.getElementById('carritoColumn');
        if (carritoColumn) {
            carritoColumn.scrollTo({ top: 0, behavior: 'smooth' });
        }

        const tipoProducto = producto.codigo.endsWith('001') ? 'UNIDADES' : 'PAQUETE';
        window.app.showToast(`✓ ${cantidad} × ${producto.producto} (${tipoProducto})`, 'success', 2500);
    }

    function cerrarModalSeleccionProducto() {
        const modal = document.getElementById('modalSeleccionProducto');
        modal.classList.remove('active');

        // Volver a enfocar búsqueda
        setTimeout(() => {
            document.getElementById('searchInput').focus();
        }, 200);
    }

    // Exportar funciones
    window.mostrarModalSeleccionProducto = mostrarModalSeleccionProducto;
    window.cerrarModalSeleccionProducto = cerrarModalSeleccionProducto;

    // ========= MODAL DE ACTUALIZACIÓN DE CLIENTE =========
    function mostrarModalActualizarCliente(cliente) {
        // Guardar cliente temporal para actualizar después
        ventaState.clienteTemporal = cliente;

        // Guardar estado anterior del cliente para poder restaurar si cancela
        ventaState.clienteAnterior = ventaState.clienteSeleccionado ? { ...ventaState.clienteSeleccionado } : null;

        // Rellenar formulario con datos actuales
        document.getElementById('updateClienteNombre').value = cliente.razon_social || '';
        document.getElementById('updateClienteCedula').value = cliente.cedula || '';
        document.getElementById('updateClienteDireccion').value = cliente.direccion || '';
        document.getElementById('updateClienteTelefono').value = cliente.telefono || '';

        // Pre-llenar correo solo si NO es genérico (@cambiar.com)
        const esCorreoGenerico = cliente.correo && cliente.correo.toLowerCase().includes('@cambiar.com');
        document.getElementById('updateClienteCorreo').value = esCorreoGenerico ? '' : (cliente.correo || '');

        // Inicializar visibilidad de botones de correo
        const btnNoCorreo = document.getElementById('btnNoCorreoUpdate');
        const btnComprobarCorreo = document.getElementById('btnComprobarCorreoUpdate');
        const tieneCorreo = document.getElementById('updateClienteCorreo').value.trim();

        if (tieneCorreo) {
            if (btnNoCorreo) btnNoCorreo.style.display = 'none';
            if (btnComprobarCorreo) btnComprobarCorreo.style.display = 'inline-flex';
        } else {
            if (btnNoCorreo) btnNoCorreo.style.display = 'inline-flex';
            if (btnComprobarCorreo) btnComprobarCorreo.style.display = 'none';
        }

        // Mostrar modal
        const modal = document.getElementById('modalActualizarCliente');
        modal.classList.add('active');

        // Enfocar en el correo para que sea lo primero que actualicen
        setTimeout(() => {
            document.getElementById('updateClienteCorreo').focus();
        }, 300);
    }

    function cerrarModalActualizarCliente() {
        const modal = document.getElementById('modalActualizarCliente');
        modal.classList.remove('active');

        // Restaurar cliente anterior (si había uno) o dejar Consumidor Final
        if (ventaState.clienteAnterior) {
            ventaState.clienteSeleccionado = { ...ventaState.clienteAnterior };
            mostrarClienteSeleccionado();
            document.getElementById('clienteSeleccionadoBox').style.display = 'block';
            window.app.showToast('Cliente anterior restaurado', 'info', 2000);
        } else {
            // Si no había cliente anterior, mostrar Consumidor Final
            ventaState.clienteSeleccionado = null;
            mostrarClienteSeleccionado();
            document.getElementById('clienteSeleccionadoBox').style.display = 'block';
            window.app.showToast('Cancelado - Consumidor Final seleccionado', 'info', 2000);
        }

        // Asegurarse de que la búsqueda esté oculta
        document.getElementById('clienteBusquedaBox').style.display = 'none';

        // Limpiar datos temporales
        ventaState.clienteTemporal = null;
        ventaState.clienteAnterior = null;

        // Limpiar formulario
        document.getElementById('updateClienteNombre').value = '';
        document.getElementById('updateClienteCedula').value = '';
        document.getElementById('updateClienteDireccion').value = '';
        document.getElementById('updateClienteTelefono').value = '';
        document.getElementById('updateClienteCorreo').value = '';
    }

    async function confirmarActualizacionCliente() {
        const cliente = ventaState.clienteTemporal;
        if (!cliente) return;

        // Obtener valores del formulario
        const razonSocial = document.getElementById('updateClienteNombre').value.trim();
        const direccion = document.getElementById('updateClienteDireccion').value.trim();
        const telefono = document.getElementById('updateClienteTelefono').value.trim();
        const correo = document.getElementById('updateClienteCorreo').value.trim();

        // Validación de campos requeridos
        if (!razonSocial) {
            window.app.showToast('<i class="fas fa-exclamation-triangle"></i> El nombre del cliente es obligatorio', 'warning', 3000);
            document.getElementById('updateClienteNombre').focus();
            return;
        }

        if (!correo) {
            window.app.showToast('<i class="fas fa-exclamation-triangle"></i> El correo electrónico es obligatorio', 'warning', 3000);
            document.getElementById('updateClienteCorreo').focus();
            return;
        }

        // Validar formato de correo
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(correo)) {
            window.app.showToast('<i class="fas fa-exclamation-triangle"></i> Por favor ingrese un correo electrónico válido', 'warning', 3000);
            document.getElementById('updateClienteCorreo').focus();
            return;
        }

        // Validar que no sea un correo genérico
        if (correo.toLowerCase().includes('@cambiar.com')) {
            window.app.showToast('<i class="fas fa-exclamation-triangle"></i> No puede usar un correo @cambiar.com. Ingrese el correo real del cliente', 'warning', 4000);
            document.getElementById('updateClienteCorreo').focus();
            return;
        }

        try {
            // Obtener referencia a la base de datos
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

            // Actualizar en Supabase
            const { data, error } = await db
                .from('ferre_clientes')
                .update({
                    razon_social: razonSocial,
                    direccion: direccion || null,
                    telefono: telefono || null,
                    correo: correo
                })
                .eq('cedula', cliente.cedula)
                .select()
                .single();

            if (error) throw error;

            // Actualizar el cliente seleccionado directamente con los datos actualizados
            ventaState.clienteSeleccionado = data;
            ventaState.clienteTemporal = null;
            ventaState.clienteAnterior = null;

            // Cerrar modal
            const modal = document.getElementById('modalActualizarCliente');
            modal.classList.remove('active');

            // Limpiar formulario
            document.getElementById('updateClienteNombre').value = '';
            document.getElementById('updateClienteCedula').value = '';
            document.getElementById('updateClienteDireccion').value = '';
            document.getElementById('updateClienteTelefono').value = '';
            document.getElementById('updateClienteCorreo').value = '';

            // Actualizar la visualización del cliente
            mostrarClienteSeleccionado();
            document.getElementById('clienteSeleccionadoBox').style.display = 'block';
            document.getElementById('clienteBusquedaBox').style.display = 'none';

            // Mostrar confirmación
            window.app.showToast('✓ Cliente actualizado exitosamente', 'success', 2500);

        } catch (error) {
            console.error('Error al actualizar cliente:', error);
            window.app.showToast('✗ Error al actualizar el cliente. Por favor intente nuevamente.', 'error', 3000);
        }
    }

    // Exportar funciones del modal de actualización
    window.mostrarModalActualizarCliente = mostrarModalActualizarCliente;
    window.cerrarModalActualizarCliente = cerrarModalActualizarCliente;
    window.confirmarActualizacionCliente = confirmarActualizacionCliente;

    // =====================================================
    // MODAL REGISTRO NUEVO CLIENTE
    // =====================================================

    function mostrarModalRegistroCliente(datosCliente) {
        // Rellenar formulario con datos pre-llenados de la API (o vacíos si es manual)
        document.getElementById('nuevoClienteCedula').value = datosCliente.cedula || '';
        document.getElementById('nuevoClienteNombre').value = datosCliente.razon_social || '';
        document.getElementById('nuevoClienteDireccion').value = datosCliente.direccion || '';
        document.getElementById('nuevoClienteTelefono').value = datosCliente.telefono || '';
        document.getElementById('nuevoClienteCorreo').value = datosCliente.correo || '';

        // Configurar listener para el campo de correo
        const correoInput = document.getElementById('nuevoClienteCorreo');
        const btnNoTieneCorreo = document.getElementById('btnNoTieneCorreo');
        const btnComprobarCorreo = document.getElementById('btnComprobarCorreo');

        // Función para actualizar visibilidad de botones
        const actualizarBotonesCorreo = () => {
            const correoValue = correoInput.value.trim();
            if (correoValue) {
                btnNoTieneCorreo.style.display = 'none';
                btnComprobarCorreo.style.display = 'flex';
            } else {
                btnNoTieneCorreo.style.display = 'flex';
                btnComprobarCorreo.style.display = 'none';
            }
        };

        // Actualizar al abrir modal
        actualizarBotonesCorreo();

        // Actualizar al escribir
        if (!correoInput.dataset.listenerConfigured) {
            correoInput.addEventListener('input', actualizarBotonesCorreo);
            correoInput.dataset.listenerConfigured = 'true';
        }

        // Actualizar mensaje según el modo (automático o manual)
        const mensajeElement = document.getElementById('modalRegistroMensaje');
        if (datosCliente.ingresoManual) {
            mensajeElement.style.background = '#fff3cd';
            mensajeElement.style.borderLeftColor = '#ffc107';
            mensajeElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Servicio de consulta no disponible. Ingrese los datos manualmente.';
        } else {
            mensajeElement.style.background = '#e3f2fd';
            mensajeElement.style.borderLeftColor = '#2196f3';
            mensajeElement.innerHTML = '<i class="fas fa-info-circle"></i> Complete los datos del cliente para registrarlo en el sistema.';
        }

        // Mostrar modal
        const modal = document.getElementById('modalRegistroCliente');
        modal.classList.add('active');

        // Configurar Enter key para confirmar registro
        const inputs = [
            document.getElementById('nuevoClienteNombre'),
            document.getElementById('nuevoClienteDireccion'),
            document.getElementById('nuevoClienteTelefono'),
            document.getElementById('nuevoClienteCorreo')
        ];

        inputs.forEach(input => {
            if (input && !input.dataset.enterConfigured) {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        confirmarRegistroCliente();
                    }
                });
                input.dataset.enterConfigured = 'true';
            }
        });

        // Enfoque inteligente según origen de datos
        setTimeout(() => {
            const nombreInput = document.getElementById('nuevoClienteNombre');
            const direccionInput = document.getElementById('nuevoClienteDireccion');
            const telefonoInput = document.getElementById('nuevoClienteTelefono');

            // Si es ingreso manual (API falló), enfocar en nombre/razón social
            if (datosCliente.ingresoManual) {
                nombreInput.focus();
                nombreInput.select();
            }
            // Si es RUC y tiene dirección pre-llenada (API exitosa), enfocar en teléfono
            else if (datosCliente.tieneRuc && datosCliente.direccion) {
                telefonoInput.focus();
            }
            // Si es cédula (sin dirección), enfocar en dirección
            else if (!direccionInput.value) {
                direccionInput.focus();
            }
            // Si dirección ya está llena pero no es RUC, enfocar en correo
            else {
                document.getElementById('nuevoClienteCorreo').focus();
            }
        }, 300);
    }

    function cerrarModalRegistroCliente() {
        const modal = document.getElementById('modalRegistroCliente');
        modal.classList.remove('active');

        // Limpiar formulario
        document.getElementById('nuevoClienteCedula').value = '';
        document.getElementById('nuevoClienteNombre').value = '';
        document.getElementById('nuevoClienteDireccion').value = '';
        document.getElementById('nuevoClienteTelefono').value = '';
        document.getElementById('nuevoClienteCorreo').value = '';

        // Volver a mostrar búsqueda de cliente
        document.getElementById('clienteBusquedaBox').style.display = 'block';

        // Enfocar en búsqueda
        setTimeout(() => {
            document.getElementById('clienteCedula').focus();
        }, 100);
    }

    async function confirmarRegistroCliente() {
        // Obtener valores del formulario
        const cedula = document.getElementById('nuevoClienteCedula').value.trim();
        const razonSocial = document.getElementById('nuevoClienteNombre').value.trim();
        const direccion = document.getElementById('nuevoClienteDireccion').value.trim();
        const telefono = document.getElementById('nuevoClienteTelefono').value.trim();
        const correo = document.getElementById('nuevoClienteCorreo').value.trim();

        // Validación de campos requeridos
        if (!cedula || !razonSocial || !direccion || !correo) {
            window.app.showToast('<i class="fas fa-exclamation-triangle"></i> Complete todos los campos obligatorios', 'warning', 3000);
            return;
        }

        // Validar formato de correo
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(correo)) {
            window.app.showToast('<i class="fas fa-exclamation-triangle"></i> Por favor ingrese un correo electrónico válido', 'warning', 3000);
            document.getElementById('nuevoClienteCorreo').focus();
            return;
        }

        try {
            window.app.showToast('Guardando cliente...', 'info', 1500);

            // Obtener referencia a la base de datos
            const db = window.app ? window.app.db : (typeof getDB === 'function' ? getDB() : supabaseClient);

            // Insertar en Supabase
            const { data, error } = await db
                .from('ferre_clientes')
                .insert([{
                    cedula: cedula.padStart(10, '0'),
                    razon_social: razonSocial,
                    direccion: direccion,
                    telefono: telefono || null,
                    correo: correo
                }])
                .select()
                .single();

            if (error) {
                if (error.code === '23505') { // Duplicate key
                    throw new Error('Este cliente ya está registrado');
                }
                throw error;
            }

            // Seleccionar el nuevo cliente automáticamente
            ventaState.clienteSeleccionado = data;

            // Cerrar modal
            const modal = document.getElementById('modalRegistroCliente');
            modal.classList.remove('active');

            // Limpiar formulario
            document.getElementById('nuevoClienteCedula').value = '';
            document.getElementById('nuevoClienteNombre').value = '';
            document.getElementById('nuevoClienteDireccion').value = '';
            document.getElementById('nuevoClienteTelefono').value = '';
            document.getElementById('nuevoClienteCorreo').value = '';

            // Actualizar visualización
            mostrarClienteSeleccionado();
            document.getElementById('clienteSeleccionadoBox').style.display = 'block';
            document.getElementById('clienteBusquedaBox').style.display = 'none';

            // Recargar cache de clientes en background
            cargarClientesCompleto();

            // Mostrar confirmación
            window.app.showToast(`✓ Cliente ${razonSocial} registrado exitosamente`, 'success', 3000);

            // Enfocar en búsqueda de productos
            setTimeout(() => {
                document.getElementById('searchInput').focus();
            }, 500);

        } catch (error) {
            console.error('Error al guardar cliente:', error);
            window.app.showToast(`✗ Error: ${error.message}`, 'danger', 4000);
        }
    }

    // Establecer correo genérico para clientes sin correo
    function establecerCorreoGenerico() {
        const correoInput = document.getElementById('nuevoClienteCorreo');
        correoInput.value = 'nishvenatalia99@gmail.com';

        // Trigger input event para actualizar botones
        correoInput.dispatchEvent(new Event('input'));

        // Mostrar toast informativo
        window.app.showToast('📧 Correo genérico establecido', 'info', 2000);

        // Enfocar en el siguiente campo disponible
        const nombreInput = document.getElementById('nuevoClienteNombre');
        const direccionInput = document.getElementById('nuevoClienteDireccion');

        if (!nombreInput.value) {
            nombreInput.focus();
        } else if (!direccionInput.value) {
            direccionInput.focus();
        }
    }

    // Imprimir comprobación de correo (ticket térmico 80mm)
    function imprimirComprobacionCorreo() {
        const correo = document.getElementById('nuevoClienteCorreo').value.trim();
        const nombre = document.getElementById('nuevoClienteNombre').value.trim();
        const cedula = document.getElementById('nuevoClienteCedula').value.trim();

        if (!correo) {
            window.app.showToast('⚠️ Debe ingresar un correo primero', 'warning', 2000);
            return;
        }

        // Construir URL con parámetros
        const params = new URLSearchParams({
            correo: correo
        });

        const url = `views/comprobarcorreo.html?${params.toString()}`;

        // Abrir en nueva pestaña
        const ventanaImpresion = window.open(url, '_blank');

        if (!ventanaImpresion) {
            window.app.showToast('❌ Error: Habilita las ventanas emergentes', 'danger', 3000);
            return;
        }

        // Mostrar toast
        window.app.showToast('🖨️ Imprimiendo comprobación de correo...', 'info', 2000);
    }

    // Funciones para modal de actualizar cliente
    function establecerCorreoGenericoUpdate() {
        const correoInput = document.getElementById('updateClienteCorreo');
        if (correoInput) {
            correoInput.value = 'nishvenatalia99@gmail.com';
            correoInput.dispatchEvent(new Event('input'));
            window.app.showToast('✅ Correo genérico establecido', 'success', 2000);
        }
    }

    function imprimirComprobacionCorreoUpdate() {
        const correo = document.getElementById('updateClienteCorreo').value.trim();

        if (!correo) {
            window.app.showToast('⚠️ Debe ingresar un correo primero', 'warning', 2000);
            return;
        }

        const params = new URLSearchParams({ correo: correo });
        const url = `comprobarcorreo.html?${params.toString()}`;
        const ventanaImpresion = window.open(url, '_blank');

        if (!ventanaImpresion) {
            window.app.showToast('❌ Error: Habilita las ventanas emergentes', 'danger', 3000);
            return;
        }

        window.app.showToast('🖨️ Imprimiendo comprobación de correo...', 'info', 2000);
    }

    // Exportar funciones del modal de registro
    window.mostrarModalRegistroCliente = mostrarModalRegistroCliente;
    window.cerrarModalRegistroCliente = cerrarModalRegistroCliente;
    window.confirmarRegistroCliente = confirmarRegistroCliente;
    window.establecerCorreoGenerico = establecerCorreoGenerico;
    window.imprimirComprobacionCorreo = imprimirComprobacionCorreo;
    window.establecerCorreoGenericoUpdate = establecerCorreoGenericoUpdate;
    window.imprimirComprobacionCorreoUpdate = imprimirComprobacionCorreoUpdate;

    // =====================================================
    // GENERAR RECIBO
    // =====================================================

    function abrirRecibo(ventaData) {
        try {
            // Preparar arrays para la URL
            const cantidades = [];
            const servicios = [];
            const p_units = [];
            const p_total = [];

            // Procesar productos
            ventaData.productos.forEach(producto => {
                cantidades.push(producto.cantidad);
                // Reemplazar comas por puntos en el nombre del producto
                const nombreProducto = producto.nombre.replace(/,/g, ".");
                servicios.push(encodeURIComponent(nombreProducto));
                p_units.push(producto.precio.toFixed(2));
                p_total.push(producto.subtotal.toFixed(2));
            });

            // Formatear fecha
            const fecha = new Date(ventaData.fecha);
            const formattedDate = fecha.toLocaleString('es-EC', {
                timeZone: 'America/Guayaquil',
                day: '2-digit',
                month: '2-digit',
                year: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/[/]/g, '/').replace(',', '');

            // Construir URL del recibo LOCAL
            const url = "views/recibo.html" +
                "?fecha=" + encodeURIComponent(formattedDate) +
                "&venta=" + encodeURIComponent(ventaData.saleCode) +
                "&subtotal=" + encodeURIComponent(ventaData.total.toFixed(2)) +
                "&descuento=0" +
                "&vendedor=CAJAPC" +
                "&nombre_cliente=" + encodeURIComponent(ventaData.cliente.razon_social) +
                "&cedula_cliente=" + encodeURIComponent(ventaData.cliente.cedula) +
                "&direccion_cliente=" + encodeURIComponent(ventaData.cliente.direccion || 'S/N') +
                "&telefono_cliente=" + encodeURIComponent(ventaData.cliente.telefono || 'S/N') +
                "&cantidades=" + cantidades.join(',') +
                "&servicios=" + servicios.join(',') +
                "&p_units=" + p_units.join(',') +
                "&total=" + encodeURIComponent(ventaData.total.toFixed(2)) +
                "&p_total=" + p_total.join(',') +
                "&tipo_documento=RECIBO";

            // Abrir en nueva pestaña
            window.open(url, '_blank');

        } catch (error) {
            console.error('Error al abrir recibo:', error);
            window.app.showToast('<i class="fas fa-exclamation-triangle"></i> Error al generar recibo', 'warning', 3000);
        }
    }

    // =====================================================
    // GENERAR FACTURA ELECTRÓNICA (VISTA TÉRMICA)
    // =====================================================

    function abrirFactura({ venta, configServicios, configSRI, docNumber, claveAcceso, usuarioEmail }) {
        try {
            if (!venta || !Array.isArray(venta.productos) || venta.productos.length === 0) {
                console.warn('⚠️ No se encontraron productos para mostrar en la factura electrónica', venta);
                return;
            }

            const productos = venta.productos;

            const parseNumber = (valor, fallback = 0) => {
                const numero = Number(valor);
                return Number.isFinite(numero) ? numero : fallback;
            };

            const cantidades = productos.map(prod => parseNumber(prod.cantidad, 0).toFixed(2));
            const descripciones = productos.map(prod => (prod.nombre || '').replace(/,/g, '.'));
            const preciosUnitarios = productos.map(prod => parseNumber(prod.precio, 0).toFixed(2));
            const totalesProducto = productos.map(prod => (parseNumber(prod.cantidad, 0) * parseNumber(prod.precio, 0)).toFixed(2));

            const subtotalCalculado = productos.reduce((acum, prod) => acum + (parseNumber(prod.cantidad, 0) * parseNumber(prod.precio, 0)), 0);
            const subtotalValor = parseNumber(venta.subtotal, subtotalCalculado).toFixed(2);
            const descuentoValor = parseNumber(venta.descuento, 0).toFixed(2);
            const totalValor = parseNumber(venta.total, subtotalCalculado).toFixed(2);

            const fechaReferencia = venta.fecha ? new Date(venta.fecha) : new Date();
            const fechaFactura = fechaReferencia.toLocaleString('es-EC', {
                timeZone: 'America/Guayaquil',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const ambienteTexto = configSRI && Number(configSRI.ambiente) === 1 ? 'PRUEBAS' : 'PRODUCCIÓN';
            const emisionTexto = configSRI && Number(configSRI.tipo_emision) === 1 ? 'NORMAL' : 'CONTINGENCIA';

            const cliente = venta.cliente || {
                razon_social: 'CONSUMIDOR FINAL',
                cedula: '9999999999999',
                direccion: 'S/N',
                telefono: 'S/N',
                correo: 'consumidor@final.com'
            };

            const params = new URLSearchParams();
            params.set('company_name', configServicios?.empresa_nombre_comercial || configServicios?.empresa_razon_social || '');
            params.set('company_owner', configServicios?.empresa_razon_social || '');
            params.set('company_ruc', configServicios?.empresa_ruc || '');
            params.set('company_address', configServicios?.empresa_dir_establecimiento || '');
            params.set('company_phone', configServicios?.empresa_telefono || '');
            params.set('logo_url', configServicios?.url_logo_factura || '');

            params.set('invoice_number', docNumber || '');
            params.set('invoice_date', fechaFactura);
            params.set('environment', ambienteTexto);
            params.set('emission', emisionTexto);
            params.set('auth_number', claveAcceso || '');

            params.set('customer_name', cliente.razon_social || 'CONSUMIDOR FINAL');
            params.set('customer_id', cliente.cedula || '9999999999999');
            params.set('customer_address', cliente.direccion || 'S/N');
            params.set('customer_phone', cliente.telefono || 'S/N');
            params.set('customer_email', cliente.correo || 'consumidor@final.com');

            params.set('attendant', usuarioEmail || '---');

            params.set('subtotal', subtotalValor);
            params.set('discount', descuentoValor);
            params.set('total', totalValor);

            params.set('quantities', cantidades.join(','));
            params.set('descriptions', descripciones.join(','));
            params.set('unit_prices', preciosUnitarios.join(','));
            params.set('total_prices', totalesProducto.join(','));

            const facturaUrl = `views/factura.html?${params.toString()}`;
            const facturaWindow = window.open(facturaUrl, '_blank');

            if (!facturaWindow) {
                window.app.showToast('⚠️ Habilita las ventanas emergentes para visualizar la factura electrónica', 'warning', 4000);
            } else {
                console.debug('Factura electrónica abierta:', facturaUrl);
            }

        } catch (error) {
            console.error('❌ Error al abrir factura electrónica:', error);
            window.app.showToast('No se pudo abrir la vista de factura electrónica', 'danger', 4000);
        }
    }

    // =====================================================
    // FUNCIONES DE FACTURACIÓN ELECTRÓNICA
    // =====================================================


    function padWithZeroes(num, length) {
        const str = String(num);
        if (str.length >= length) return str;
        return '0'.repeat(length - str.length) + str;
    }


    function calcularDigitoVerificador(cadena) {
        try {
            // Verificar longitud
            if (!cadena || cadena.length !== 48) {
                return {
                    success: false,
                    message: "La cadena debe tener exactamente 48 dígitos"
                };
            }

            // Factores para el cálculo (se repiten en ciclo)
            const factores = [2, 3, 4, 5, 6, 7];
            let suma = 0;

            // Recorrer cada dígito de derecha a izquierda
            for (let i = 0; i < cadena.length; i++) {
                const digito = parseInt(cadena[cadena.length - 1 - i], 10);
                const factor = factores[i % factores.length];
                suma += digito * factor;
            }

            // Calcular dígito verificador
            let digitoVerificador = 11 - (suma % 11);

            // Reglas especiales
            if (digitoVerificador === 10) digitoVerificador = 1;
            if (digitoVerificador === 11) digitoVerificador = 0;

            // Resultado
            const resultado = cadena + digitoVerificador;

            return {
                success: true,
                resultado: resultado,
                digito: digitoVerificador
            };
        } catch (error) {
            return {
                success: false,
                message: "Error calculando dígito verificador: " + error.message
            };
        }
    }


    function generarClaveAcceso(fecha, config) {
        try {
            // Validar fecha
            if (!fecha || fecha.length !== 8 || !/^\d{8}$/.test(fecha)) {
                return {
                    success: false,
                    message: "La fecha debe estar en formato ddMMyyyy (8 dígitos)"
                };
            }

            // Tipo de comprobante: 01 = Factura
            const tipoComprobante = "01";

            // Formatear valores a longitudes requeridas
            const ruc = padWithZeroes(config.ruc, 13);
            const ambiente = padWithZeroes(config.ambiente, 1);
            const establecimiento = padWithZeroes(config.establecimiento, 3);
            const puntoEmision = padWithZeroes(config.punto_emision, 3);
            const serie = establecimiento + puntoEmision; // 6 dígitos
            const comprobante = padWithZeroes(config.comprobante_actual, 9);
            const codigoNumerico = padWithZeroes(config.codigo_numerico, 8);
            const tipoEmision = padWithZeroes(config.tipo_emision, 1);

            // Componer clave de acceso (48 dígitos)
            const claveAcceso48 =
                fecha +                 // 8 dígitos
                tipoComprobante +       // 2 dígitos
                ruc +                   // 13 dígitos
                ambiente +              // 1 dígito
                serie +                 // 6 dígitos (establecimiento + punto emisión)
                comprobante +           // 9 dígitos
                codigoNumerico +        // 8 dígitos
                tipoEmision;            // 1 dígito
            // TOTAL: 48 dígitos

            // Calcular dígito verificador
            const resultado = calcularDigitoVerificador(claveAcceso48);

            if (!resultado.success) {
                return resultado;
            }

            return {
                success: true,
                claveAcceso: resultado.resultado,
                digito: resultado.digito
            };

        } catch (error) {
            return {
                success: false,
                message: "Error generando clave de acceso: " + error.message
            };
        }
    }


    function getTipoIdentificacion(identificacion) {
        if (!identificacion) return "07"; // Consumidor final
        const id = String(identificacion).trim();
        if (id === "9999999999999") return "07"; // Consumidor final
        if (id.length === 10) return "05"; // Cédula
        if (id.length === 13) return "04"; // RUC
        return "06"; // Pasaporte u otro
    }


    function formatIdentificacion(identificacion) {
        if (!identificacion) return "9999999999999";
        let id = String(identificacion).trim();

        // Si es consumidor final
        if (id === "9999999999999") return id;

        // Si es cédula (10 dígitos)
        if (id.length <= 10) {
            return padWithZeroes(id, 10);
        }

        // Si es RUC (13 dígitos)
        return id;
    }


    function formatearTelefonoEcuador(telefono) {
        if (!telefono) return "S/N";
        let tel = String(telefono).replace(/\D/g, ''); // Solo dígitos
        if (tel.length === 0) return "S/N";
        if (tel.length === 9) tel = '0' + tel; // Agregar 0 al inicio
        return tel;
    }


    async function obtenerConfiguracionFacturacion() {
        try {
            const db = window.app.db;

            // Obtener configuración SRI
            const { data: configSRI, error: errorSRI } = await db
                .from('ferre_facelectronicaconfig')
                .select('*')
                .single();

            if (errorSRI) {
                console.error('❌ Error obteniendo configuración SRI:', errorSRI);
                throw new Error('No se pudo obtener configuración de facturación SRI');
            }

            // Obtener configuración de servicios
            const { data: configServicios, error: errorServicios } = await db
                .from('ferre_config_servicios')
                .select('*')
                .single();

            if (errorServicios) {
                console.error('❌ Error obteniendo configuración de servicios:', errorServicios);
                throw new Error('No se pudo obtener configuración de servicios');
            }


            return {
                success: true,
                configSRI: configSRI,
                configServicios: configServicios
            };

        } catch (error) {
            console.error('❌ Error en obtenerConfiguracionFacturacion:', error);
            return {
                success: false,
                message: error.message
            };
        }
    }


    function generarJsonFacturacion(ventaData, configSRI, configServicios, claveAcceso, docNumber) {
        try {
            // Calcular totales
            let subtotal = 0;
            const productos = ventaData.productos.map(prod => {
                const subtotalProducto = prod.cantidad * prod.precio;
                subtotal += subtotalProducto;
                return {
                    codigoPrincipal: prod.codigo,
                    codigoAuxiliar: prod.codigo,
                    descripcion: prod.nombre.replace(/,/g, '.'), // Sin comas
                    cantidad: prod.cantidad.toFixed(2),
                    precioUnitario: prod.precio.toFixed(2),
                    subtotalSinIVA: subtotalProducto.toFixed(2),
                    codigoPorcentaje: "0",
                    tarifa: "0",
                    iva: "0.00",
                    descuento: "0.00"
                };
            });

            // Extraer partes del documento
            const docParts = docNumber.split('-');
            const estab = docParts[0];
            const ptoEmi = docParts[1];
            const secuencial = docParts[2];

            // Fecha de emisión
            const now = new Date();
            const fechaEmision = now.toLocaleDateString('es-EC', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Datos del cliente
            const cliente = ventaData.cliente;
            const identificacionComprador = formatIdentificacion(cliente.cedula);
            const tipoIdentificacionComprador = getTipoIdentificacion(identificacionComprador);
            const telefonoCliente = formatearTelefonoEcuador(cliente.telefono);

            // Construir JSON
            const jsonFactura = {
                // WhatsApp config
                instance_id: configServicios.instance_id || configServicios.whatsapp_instance_id || "",
                access_token: configServicios.acces_token || configServicios.whatsapp_access_token || "",

                // Archivos
                archivo: `FACTURA-${estab}-${ptoEmi}-${secuencial}.xml`,
                facturaPDF: `FACTURA-${estab}-${ptoEmi}-${secuencial}.pdf`,

                // Correo del cliente
                correo: cliente.correo || "consumidor@final.com",

                // Configuración SRI
                ambiente: String(configSRI.ambiente),
                razonSocial: configServicios.empresa_razon_social,
                nombreComercial: configServicios.empresa_nombre_comercial,
                ruc: configServicios.empresa_ruc,
                claveAcceso: claveAcceso,
                estab: estab,
                ptoEmi: ptoEmi,
                secuencial: secuencial,

                // Direcciones
                dirMatriz: configServicios.empresa_dir_matriz,
                dirEstablecimiento: configServicios.empresa_dir_establecimiento,

                // Contribuyente
                contribuyenteRimpe: configServicios.empresa_contribuyente_rimpe || "",
                contribuyenteRIDE: configServicios.empresa_contribuyente_ride || "",
                obligadoContabilidad: configServicios.empresa_obligado_contabilidad,

                // Fecha
                fechaEmision: fechaEmision,

                // Cliente
                tipoIdentificacionComprador: tipoIdentificacionComprador,
                razonSocialComprador: cliente.razon_social,
                identificacionComprador: identificacionComprador,
                direccionComprador: cliente.direccion || "S/N",
                telefonoCliente: telefonoCliente,
                telefonoContribuyente: configServicios.empresa_telefono,

                // Documento
                factura: docNumber,
                formaPago: configServicios.factura_forma_pago_defecto || "01",
                formaPagoRIDE: configServicios.factura_forma_pago_ride || "01 SIN UTILIZACIÓN DEL SISTEMA FINANCIERO",

                // Totales
                codigoPorcentajeTotales: "0",
                baseImponibleTotales: subtotal.toFixed(2),
                valorTotales: "0.00",
                totalSinImpuestos: subtotal.toFixed(2),
                importeTotal: subtotal.toFixed(2),
                totalDescuento: "0.00",
                valor: "0.00",

                // Productos (arrays concatenados)
                codigoPrincipal: productos.map(p => p.codigoPrincipal).join(' , '),
                codigoAuxiliar: productos.map(p => p.codigoAuxiliar).join(' , '),
                descripcion: productos.map(p => p.descripcion).join(' , '),
                cantidad: productos.map(p => p.cantidad).join(' , '),
                precioUnitario: productos.map(p => p.precioUnitario).join('|'),
                subtotalSinIVA: productos.map(p => p.subtotalSinIVA).join('|'),
                codigoPorcentaje: productos.map(p => p.codigoPorcentaje).join(','),
                tarifa: productos.map(p => p.tarifa).join(','),
                iva: productos.map(p => p.iva).join('|'),
                descuento: productos.map(p => p.descuento).join('|'),

                // Subtotales IVA
                subtotal12: "0.00",
                subtotal0: subtotal.toFixed(2),
                subtotalNoObjeto: "0.00",
                subtotalExento: "0.00",

                // Campos adicionales
                campoAdicional: 'campoAdicional nombre="Correo de cliente"',
                codigoArtesano: (cliente.correo || "consumidor@final.com"),
                artesanoRide: (cliente.correo || "consumidor@final.com"),

                // Firma electrónica (.p12)
                clave_12: configServicios.firma_clave_p12 || "",

                // URLs y logos
                urlLogo: configServicios.url_logo_factura || "",
                urlLogoPieCorreo: configServicios.url_logo_pie_correo || "",

                // SMTP
                correoRemitente: configServicios.smtp_correo_remitente || "",
                clavecorreoRemitente: configServicios.smtp_clave_remitente || "",
                hostcorreoRemitente: configServicios.smtp_host || "smtp.gmail.com",
                puertocorreoRemitente: String(configServicios.smtp_puerto || "587"),

                // Nombre del archivo .p12
                nombrep12: configServicios.firma_nombre_p12 || "",

                // Ambiente SRI
                ambientesri: configSRI.ambiente === 1 ? "https://celcer.sri.gob.ec" : "https://cel.sri.gob.ec"
            };

            return {
                success: true,
                json: jsonFactura
            };

        } catch (error) {
            console.error('❌ Error generando JSON de facturación:', error);
            return {
                success: false,
                message: error.message
            };
        }
    }

    async function enviarFacturaAlServicioFirma({ url, payload, maxIntentos = 3, timeoutMs = 30000 }) {
        if (!url) {
            throw new Error('No se configuró la URL del servicio de firma.');
        }

        const intentosTotales = Math.max(1, Number(maxIntentos) || 1);
        const timeout = Math.max(5000, Number(timeoutMs) || 30000);
        const cuerpo = JSON.stringify(payload);
        let ultimoError = null;

        for (let intento = 1; intento <= intentosTotales; intento++) {
            let controller;
            let timeoutHandle;

            try {
                controller = new AbortController();
                timeoutHandle = setTimeout(() => controller.abort(), timeout);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: cuerpo,
                    signal: controller.signal
                });

                clearTimeout(timeoutHandle);

                const raw = await response.text();
                let data = null;

                if (raw) {
                    try {
                        data = JSON.parse(raw);
                    } catch (parseError) {
                        console.warn('⚠️ Respuesta del servicio de firma no es JSON válido:', parseError);
                    }
                }

                const statusValue = data?.status ?? data?.Status ?? data?.estado ?? data?.data?.status ?? null;
                const detalleValue = data?.detalle ?? data?.Detalle ?? data?.data?.detalle ?? null;
                const statusString = statusValue !== null && statusValue !== undefined
                    ? String(statusValue).trim().toLowerCase()
                    : null;
                const detalleString = detalleValue !== null && detalleValue !== undefined
                    ? String(detalleValue).trim().toLowerCase()
                    : null;

                const autorizado = response.ok && (
                    statusString === '0' ||
                    statusString === 'ok' ||
                    statusString === 'autorizado' ||
                    statusString === 'success' ||
                    detalleString === 'autorizado'
                );

                const requiereReintento = !autorizado && response.ok && intento < intentosTotales && (
                    statusString === '1' ||
                    statusString === 'pendiente' ||
                    statusString === 'pending'
                );

                if (requiereReintento) {
                    await new Promise(resolve => setTimeout(resolve, intento * 1000));
                    continue;
                }

                return {
                    success: autorizado,
                    statusCode: response.status,
                    data,
                    raw,
                    intento,
                    statusString,
                    detalleString,
                    message: data?.message || data?.detalle || data?.error || raw
                };
            } catch (error) {
                if (timeoutHandle) {
                    clearTimeout(timeoutHandle);
                }

                ultimoError = error;

                if (intento === intentosTotales) {
                    return {
                        success: false,
                        intento,
                        error,
                        message: error.name === 'AbortError' ? 'Tiempo de espera agotado' : error.message
                    };
                }

                await new Promise(resolve => setTimeout(resolve, intento * 1000));
            }
        }

        return {
            success: false,
            intento: intentosTotales,
            error: ultimoError,
            message: ultimoError ? ultimoError.message : 'Error desconocido al contactar servicio de firma'
        };
    }

    async function procesarEnvioFacturaElectronica({ db, ventaId, ventaCodigo, docNumber, payload, configServicios }) {
        const urlFirma = configServicios?.firma_url || configServicios?.firmaUrl;

        if (!urlFirma) {
            console.warn('⚠️ No se configuró firma_url en config_servicios. La factura queda pendiente.');
            window.app?.showToast?.('Factura generada, pero el servicio de firma no está configurado. La autorización queda pendiente.', 'warning', 7000);
            return { success: false, skipped: true, message: 'URL del servicio de firma no configurada' };
        }

        const maxIntentos = Number(configServicios.firma_max_intentos) || 3;
        const timeoutMs = (Number(configServicios.firma_timeout_segundos) || 30) * 1000;

        window.app?.showToast?.('⌛ Enviando factura al servicio de firma...', 'info', 3500);

        const resultado = await enviarFacturaAlServicioFirma({
            url: urlFirma,
            payload,
            maxIntentos,
            timeoutMs
        });

        window.lastFacturaFirmaResult = resultado;
        if (window.lastFacturaPayload) {
            window.lastFacturaPayload.result = resultado;
        }

        const supabase = db;

        if (!supabase || typeof supabase.from !== 'function') {
            console.error('❌ Cliente de base de datos no disponible para actualizar estado de la venta.');
        }

        if (resultado.success) {
            if (supabase && typeof supabase.from === 'function') {
                const { error: updateError } = await supabase
                    .from('ferre_ventas')
                    .update({ estado: 'AUTORIZADO' })
                    .eq('id', ventaId);

                if (updateError) {
                    console.error('❌ Error actualizando estado de venta a AUTORIZADO:', updateError);
                }
            }

            window.app?.showToast?.(`<i class="fas fa-check-circle"></i> Factura ${docNumber} autorizada por el SRI`, 'success', 6000);
        } else {
            const detalle = resultado.message || resultado.data?.message || resultado.data?.detalle || 'Sin detalle de error.';

            if (resultado.statusCode && resultado.statusCode >= 200 && resultado.statusCode < 300) {
                if (supabase && typeof supabase.from === 'function') {
                    const { error: updateError } = await supabase
                        .from('ferre_ventas')
                        .update({ estado: 'RECHAZADO' })
                        .eq('id', ventaId);

                    if (updateError) {
                        console.error('❌ Error actualizando estado de venta a RECHAZADO:', updateError);
                    }
                }

                window.app?.showToast?.(`❌ Factura ${docNumber} rechazada por el SRI. ${detalle}`, 'danger', 7000);
            } else {
                console.warn('⚠️ Factura quedó pendiente de autorización SRI:', resultado);
                window.app?.showToast?.(`⚠️ Factura ${docNumber} pendiente de autorización. ${detalle}`, 'warning', 7000);
            }
        }

        console.groupCollapsed('%c🚀 Servicio de firma SRI', 'color:#b5179e;font-weight:bold;');
        console.log('Venta ID:', ventaCodigo);
        console.log('Documento:', docNumber);
        console.log('Resultado de firma:', resultado);
        console.groupEnd();

        return resultado;
    }

    async function confirmarVenta() {
        try {
            // Validar pago con redondeo a 2 decimales para evitar problemas de precisión
            const totalConIva = Math.round(ventaState.carrito.reduce((sum, item) => sum + (item.cantidad * item.precio), 0) * 100) / 100;
            const pagadoCon = Math.round((parseFloat(document.getElementById('pagadoCon').value) || 0) * 100) / 100;
            const vuelto = Math.max(0, Math.round((pagadoCon - totalConIva) * 100) / 100);

            // Obtener tipo de pago
            const radio = document.querySelector('input[name="tipoPagoVenta"]:checked');
            const tipoPago = radio ? radio.value : 'EFECTIVO';

            // Validación con tolerancia de 1 centavo para evitar errores de redondeo
            // SOLO validamos monto completo si es EFECTIVO.
            if (tipoPago === 'EFECTIVO' && pagadoCon < totalConIva - 0.01) {
                window.app.showToast(`El monto pagado ($${pagadoCon.toFixed(2)}) debe ser igual o mayor al total ($${totalConIva.toFixed(2)})`, 'warning', 3000);
                return;
            }

            // Generar ID de venta (formato: S + timestamp)
            const ventaIdText = `S${Date.now()}`;
            const fechaActual = new Date().toISOString();

            // Obtener cliente_id (default: consumidor final)
            const clienteId = ventaState.clienteSeleccionado?.cedula || '9999999999999';

            // Obtener email del usuario autenticado
            const userEmail = auth.getUserEmail ? auth.getUserEmail() : null;

            const db = window.app ? window.app.db : (typeof getSupabaseClient === 'function' ? getSupabaseClient() : supabaseClient);

            // Determinar tipo de documento
            const tipoDocumento = ventaState.tipoComprobante || 'RECIBO';

            // Variables para facturación electrónica
            let docNumber = null;
            let claveAcceso = null;
            let jsonFactura = null;
            let datosFacturaVenta = null;
            let configSRIData = null;
            let configServiciosData = null;

            // Si es FACTURA, generar datos de facturación electrónica
            if (tipoDocumento === 'FACTURA') {

                // Obtener configuración
                const configResult = await obtenerConfiguracionFacturacion();

                if (!configResult.success) {
                    throw new Error('No se pudo obtener configuración de facturación: ' + configResult.message);
                }

                configSRIData = configResult.configSRI;
                configServiciosData = configResult.configServicios;

                // Incrementar número de comprobante (NOTA: En producción se debe usar bloqueo para evitar duplicados)
                const nuevoComprobante = configSRIData.comprobante_actual + 1;

                // Generar número de documento (formato: 001-001-000000015)
                docNumber = `${padWithZeroes(configSRIData.establecimiento, 3)}-${padWithZeroes(configSRIData.punto_emision, 3)}-${padWithZeroes(nuevoComprobante, 9)}`;

                // Generar clave de acceso
                const now = new Date();
                const fechaFormateada = now.toLocaleDateString('es-EC', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }).split('/').join(''); // ddMMyyyy

                const claveResult = generarClaveAcceso(fechaFormateada, {
                    ...configSRIData,
                    comprobante_actual: nuevoComprobante
                });

                if (!claveResult.success) {
                    throw new Error('Error generando clave de acceso: ' + claveResult.message);
                }

                claveAcceso = claveResult.claveAcceso;


                // Generar JSON completo de facturación
                datosFacturaVenta = {
                    cliente: ventaState.clienteSeleccionado || {
                        cedula: '9999999999999',
                        razon_social: 'CONSUMIDOR FINAL',
                        direccion: 'S/N',
                        telefono: 'S/N',
                        correo: 'consumidor@final.com'
                    },
                    productos: ventaState.carrito.map(item => ({
                        codigo: item.codigo,
                        nombre: item.nombre,
                        cantidad: item.cantidad,
                        precio: item.precio
                    })),
                    total: totalConIva,
                    subtotal: totalConIva,
                    descuento: 0,
                    fecha: fechaActual
                };

                const jsonResult = generarJsonFacturacion(datosFacturaVenta, configSRIData, configServiciosData, claveAcceso, docNumber);

                if (!jsonResult.success) {
                    throw new Error('Error generando JSON de facturación: ' + jsonResult.message);
                }

                jsonFactura = jsonResult.json;
                window.lastFacturaPayload = {
                    url: configServiciosData.firma_url || null,
                    json: jsonFactura,
                    docNumber,
                    claveAcceso
                };

                console.groupCollapsed('%c🧾 Facturación electrónica', 'color:#0b7285;font-weight:bold;');
                console.log('Endpoint firma:', configServiciosData.firma_url || 'No configurado');
                console.log('Intentos máximos:', configServiciosData.firma_max_intentos ?? 'N/D');
                console.log('Timeout (segundos):', configServiciosData.firma_timeout_segundos ?? 'N/D');
                console.log('Documento:', docNumber);
                console.log('Clave de acceso:', claveAcceso);
                console.log('Payload JSON:', jsonFactura);
                console.groupEnd();


                // Actualizar número de comprobante en la BD
                const { error: updateConfigError } = await db
                    .from('ferre_facelectronicaconfig')
                    .update({ comprobante_actual: nuevoComprobante })
                    .eq('id', configSRIData.id);

                if (updateConfigError) {
                    console.warn('⚠️ Advertencia: No se pudo actualizar número de comprobante:', updateConfigError);
                    // No es crítico para la prueba, continuamos
                }
            }

            // PASO 1: Insertar venta principal (INCLUYENDO tipo_pago)
            const ventaData = {
                id_venta: ventaIdText,
                fecha_hora_venta: fechaActual,
                cliente_id: clienteId,
                total: parseFloat(totalConIva.toFixed(2)),
                pagado_con: parseFloat(pagadoCon.toFixed(2)),
                vuelto: parseFloat(vuelto.toFixed(2)),
                tipo: tipoDocumento,
                tipo_pago: tipoPago, // <-- NUEVO: Guardamos tipo de pago
                estado: tipoDocumento === 'FACTURA' ? 'PENDIENTE' : 'COMPLETADO',
                usuario_email: userEmail,
                doc: docNumber,
                clave_acceso: claveAcceso,
                fecha_factura: tipoDocumento === 'FACTURA' ? new Date().toISOString().split('T')[0] : null
                // ganancia se calculará después de insertar detalles
            };

            const { data: ventaInsertada, error: ventaError } = await db
                .from('ferre_ventas')
                .insert([ventaData])
                .select()
                .single();

            if (ventaError) {
                console.error('Error insertando venta:', ventaError);
                throw new Error(`Error al registrar venta: ${ventaError.message}`);
            }


            // PASO 2: Insertar detalles de venta
            const detalles = ventaState.carrito.map((item, index) => ({
                id_detalle: `${ventaIdText}_${index + 1}`,
                venta_id: ventaInsertada.id, // UUID generado automáticamente
                id_venta: ventaIdText, // TEXT para búsquedas
                producto_id: item.codigo,
                cantidad: parseFloat(item.cantidad),
                precio: parseFloat(item.precio),
                estado: 'ACTIVO'
                // ganancia se calcula automáticamente por trigger
                // subtotal se calcula automáticamente (GENERATED COLUMN)
            }));

            const { data: detallesInsertados, error: detalleError } = await db
                .from('ferre_ventas_detalle')
                .insert(detalles)
                .select();

            if (detalleError) {
                console.error('Error insertando detalles:', detalleError);
                // Intentar revertir la venta si fallan los detalles
                await db.from('ferre_ventas').delete().eq('id', ventaInsertada.id);
                throw new Error(`Error al registrar productos: ${detalleError.message}`);
            }


            // NOTA: La ganancia total se actualiza automáticamente por el trigger 
            // 'trigger_actualizar_ganancia_total' después de insertar detalles

            // ÉXITO
            cerrarModalVenta();

            // NUEVO: Enviar Webhook si NO es efectivo (Transferencia o Mixto)
            if (tipoPago !== 'EFECTIVO') {
                const productosLista = ventaState.carrito.map(item => `${item.cantidad} x ${item.nombre}`).join('\n');
                let montoWebhook = totalConIva;

                if (tipoPago === 'MIXTO') {
                    // Para mixto, enviamos el monto que NO es efectivo (lo que se transfiere)
                    montoWebhook = Math.max(0, totalConIva - pagadoCon);
                }

                const clienteNombre = ventaState.clienteSeleccionado ? ventaState.clienteSeleccionado.razon_social : 'Consumidor Final';

                const payload = {
                    idventa: ventaIdText,
                    productos: productosLista,
                    monto: montoWebhook.toFixed(2),
                    tipo_pago: tipoPago,
                    total_venta: totalConIva.toFixed(2),
                    cliente: clienteNombre
                };

                console.log('🚀 Enviando webhook venta:', payload);

                // Fetch no bloqueante
                fetch('https://webhookn8n.ferrisoluciones.com/webhook/1110913c-ff8d-4ea2-976d-3c171cdaa99a', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).catch(err => console.error('Error webhook venta', err));
            }

            if (tipoDocumento === 'FACTURA') {
                if (datosFacturaVenta && configSRIData && configServiciosData && docNumber && claveAcceso) {
                    abrirFactura({
                        venta: datosFacturaVenta,
                        configServicios: configServiciosData,
                        configSRI: configSRIData,
                        docNumber,
                        claveAcceso,
                        usuarioEmail: userEmail
                    });
                } else {
                    console.warn('⚠️ Datos incompletos para abrir factura electrónica', {
                        datosFacturaVenta,
                        configSRIData,
                        configServiciosData,
                        docNumber,
                        claveAcceso
                    });
                }
                window.app.showToast(`<i class="fas fa-check-circle"></i> Factura ${docNumber} generada exitosamente! Revisa la consola para ver el JSON`, 'success', 5000);

                if (jsonFactura && configServiciosData) {
                    const firmaPromise = procesarEnvioFacturaElectronica({
                        db,
                        ventaId: ventaInsertada.id,
                        ventaCodigo: ventaIdText,
                        docNumber,
                        payload: jsonFactura,
                        configServicios: configServiciosData
                    });
                    window.lastFacturaFirmaPromise = firmaPromise;
                    firmaPromise.catch(error => {
                        console.error('❌ Error inesperado al procesar envío de factura al servicio de firma:', error);
                        window.app?.showToast?.('No se pudo completar el envío al SRI. Revisa la consola para más detalles.', 'danger', 7000);
                    });
                }

                // Mostrar modal con datos para reimpresión
                mostrarModalExitoVenta(ventaIdText, {
                    tipo: 'FACTURA',
                    facturaData: datosFacturaVenta
                });
            } else {
                // Preparar datos del recibo para todas las ventas
                const reciboData = {
                    saleCode: ventaIdText,
                    fecha: fechaActual,
                    total: totalConIva,
                    pagadoCon: pagadoCon,
                    vuelto: vuelto,
                    cliente: ventaState.clienteSeleccionado || {
                        cedula: '9999999999999',
                        razon_social: 'CONSUMIDOR FINAL',
                        direccion: 'S/N',
                        telefono: 'S/N',
                        correo: 'S/N'
                    },
                    productos: ventaState.carrito.map(item => ({
                        codigo: item.codigo,
                        nombre: item.nombre,
                        cantidad: item.cantidad,
                        precio: item.precio,
                        subtotal: item.cantidad * item.precio
                    }))
                };

                // Si la venta es menor a $4, no imprimir automáticamente pero guardar datos
                if (totalConIva < 4) {
                    mostrarModalExitoVenta(ventaIdText, {
                        tipo: 'RECIBO',
                        reciboData: reciboData
                    });
                } else {
                    // Abrir recibo en nueva pestaña
                    abrirRecibo(reciboData);

                    // Mostrar modal de éxito después de abrir recibo
                    setTimeout(() => {
                        mostrarModalExitoVenta(ventaIdText, {
                            tipo: 'RECIBO',
                            reciboData: reciboData
                        });
                    }, 500);
                }
            }

            // Limpiar carrito y caché (sin confirmación porque ya se procesó)
            ventaState.carrito = [];
            ventaState.clienteSeleccionado = null;
            ventaState.tipoComprobante = 'RECIBO';
            limpiarCarritoCache();
            actualizarCarrito();
            mostrarClienteSeleccionado();

            // Limpiar búsqueda de cliente
            document.getElementById('clienteCedula').value = '';

            // Recargar cache de clientes en background (por si se agregó un cliente nuevo)
            cargarClientesCompleto();

            // Focus en búsqueda de productos
            document.getElementById('searchInput').focus();

        } catch (error) {
            console.error('❌ Error procesando venta:', error);
            window.app.showToast('Error al procesar la venta: ' + error.message, 'danger', 5000);
        }
    }

    // =====================================================
    // FUNCIONES DE GARANTÍA
    // =====================================================

    let garantiaProductoActual = null;

    function abrirModalGarantia(codigo) {
        const producto = ventaState.carrito.find(item => item.codigo === codigo);
        if (!producto) {
            window.app.showToast('Producto no encontrado', 'danger');
            return;
        }

        garantiaProductoActual = producto;
        document.getElementById('garantiaProductoNombre').textContent = producto.nombre;
        document.getElementById('garantiaProductoCodigo').textContent = producto.codigo;
        document.getElementById('garantiaPeriodo').value = '1';

        // Mostrar modal
        document.getElementById('modalGarantia').classList.add('show');

        // Enfocar input de años
        setTimeout(() => {
            document.getElementById('garantiaPeriodo').focus();
            document.getElementById('garantiaPeriodo').select();
        }, 100);
    }

    function cerrarModalGarantia() {
        document.getElementById('modalGarantia').classList.remove('show');
        garantiaProductoActual = null;
    }

    function generarGarantia() {
        if (!garantiaProductoActual) {
            window.app.showToast('No hay producto seleccionado', 'danger');
            return;
        }

        const guaranteePeriod = parseInt(document.getElementById('garantiaPeriodo').value);
        if (!guaranteePeriod || guaranteePeriod < 1) {
            window.app.showToast('Por favor, ingrese un período de garantía válido', 'warning');
            return;
        }

        // Preparar datos para la URL
        const productName = garantiaProductoActual.nombre.split('-')[0].trim();
        const now = new Date();
        const formattedDate = now.toLocaleString('es-EC', {
            timeZone: 'America/Guayaquil',
            day: '2-digit',
            month: '2-digit',
            year: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).replace(/[/]/g, '/').replace(',', '');

        const saleCode = 'G' + Date.now();

        const url = "https://pos.ferrisoluciones.com/views/GARANTIAS.html" +
            "?fecha=" + encodeURIComponent(formattedDate) +
            "&venta=" + encodeURIComponent(saleCode) +
            "&nombre_cliente=" + encodeURIComponent(productName) +
            "&cedula_cliente=" + encodeURIComponent(guaranteePeriod + " AÑO" + (guaranteePeriod > 1 ? "S" : "")) +
            "&codigo_ducha=" + encodeURIComponent(garantiaProductoActual.codigo);

        // Abrir en nueva ventana
        window.open(url, '_blank');

        // Cerrar modal
        cerrarModalGarantia();

        window.app.showToast('<i class="fas fa-check-circle"></i> Garantía generada exitosamente', 'success', 3000);
    }

    // =====================================================
    // MODAL DE ÉXITO DE VENTA
    // =====================================================

    function mostrarModalExitoVenta(codigoVenta, datosVenta = null) {
        const modal = document.getElementById('modalExitoVenta');
        const codigoElement = document.getElementById('modalExitoCodigoVenta');
        const tipoDocElement = document.getElementById('modalExitoTipoDoc');

        if (codigoElement) {
            codigoElement.textContent = codigoVenta;
        }

        // Guardar datos de la última venta para reimpresión
        if (datosVenta) {
            window.ultimaVentaRegistrada = datosVenta;
            if (tipoDocElement) {
                const tipo = datosVenta.tipo === 'FACTURA' ? 'Factura Electrónica' : 'Recibo';
                tipoDocElement.textContent = `Tipo: ${tipo}`;
            }
        }

        // Mostrar modal
        modal.classList.add('active');

        // Remover listener anterior si existe
        if (window.modalExitoEnterHandler) {
            document.removeEventListener('keydown', window.modalExitoEnterHandler);
        }

        // Crear handler para Enter (solo acepta, no cierra automático)
        window.modalExitoEnterHandler = (e) => {
            if (e.key === 'Enter' && modal.classList.contains('active')) {
                e.preventDefault();
                e.stopPropagation();
                cerrarModalExitoVenta();
            }
        };

        // Agregar listener
        document.addEventListener('keydown', window.modalExitoEnterHandler);

        // Enfocar el botón de Aceptar para que Enter funcione
        setTimeout(() => {
            const btnAceptar = document.getElementById('btnAceptarVenta');
            if (btnAceptar) btnAceptar.focus();
        }, 100);
    }

    function cerrarModalExitoVenta() {
        const modal = document.getElementById('modalExitoVenta');
        modal.classList.remove('active');

        // Remover listener de Enter
        if (window.modalExitoEnterHandler) {
            document.removeEventListener('keydown', window.modalExitoEnterHandler);
            window.modalExitoEnterHandler = null;
        }

        // Enfocar búsqueda
        setTimeout(() => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.focus();
        }, 200);
    }

    function reimprimirUltimoComprobante() {
        if (!window.ultimaVentaRegistrada) {
            window.app?.showToast?.('No hay datos de venta para reimprimir', 'warning', 3000);
            return;
        }

        const datos = window.ultimaVentaRegistrada;

        if (datos.tipo === 'FACTURA') {
            if (!datos.facturaData) {
                window.app?.showToast?.('No hay datos de factura disponibles', 'error', 3000);
                return;
            }
            // Reimprimir factura electrónica
            abrirFacturaElectronica(datos.facturaData);
            window.app?.showToast?.('Reabriendo factura...', 'info', 2000);
        } else {
            if (!datos.reciboData) {
                window.app?.showToast?.('No hay datos de recibo disponibles', 'error', 3000);
                return;
            }
            // Reimprimir recibo
            abrirRecibo(datos.reciboData);
            window.app?.showToast?.('Reabriendo recibo...', 'info', 2000);
        }
    }

    // Exportar funciones
    window.mostrarModalExitoVenta = mostrarModalExitoVenta;
    window.cerrarModalExitoVenta = cerrarModalExitoVenta;
    window.reimprimirUltimoComprobante = reimprimirUltimoComprobante;



    // =====================================================
    // EXPORTAR FUNCIONES GLOBALES
    // =====================================================

    // Exportar función de inicialización
    window.initPuntoVenta = initPuntoVenta;

    // Exportar funciones auxiliares
    window.calcularStockRestante = calcularStockRestante;
    window.guardarCarritoEnCache = guardarCarritoEnCache;
    window.limpiarCarritoCache = limpiarCarritoCache;
    window.mostrarConfirmacion = mostrarConfirmacion;
    window.toggleModoEdicion = toggleModoEdicion;
    window.buscarProductos = buscarProductos;
    window.mostrarResultadosBusqueda = mostrarResultadosBusqueda;
    window.agregarProducto = agregarProducto;
    window.agregarProductoPorCodigo = agregarProductoPorCodigo;
    window.actualizarCantidad = actualizarCantidad;
    window.actualizarPrecio = actualizarPrecio;
    window.eliminarDelCarrito = eliminarDelCarrito;
    window.limpiarVenta = limpiarVenta;
    window.procesarVenta = procesarVenta;
    window.buscarCliente = buscarCliente;
    window.toggleBusquedaCliente = toggleBusquedaCliente;
    window.activarBusquedaCliente = activarBusquedaCliente;
    window.buscarClienteDirecto = buscarClienteDirecto;
    window.seleccionarCliente = seleccionarCliente;
    window.cancelarBusqueda = cancelarBusqueda;
    window.cerrarModalVenta = cerrarModalVenta;
    window.confirmarVenta = confirmarVenta;
    window.calcularVuelto = calcularVuelto;
    window.manejarTeclasCantidad = manejarTeclasCantidad;
    window.abrirRecibo = abrirRecibo;
    window.seleccionarTipoComprobante = seleccionarTipoComprobante;
    window.procesarVentaConValidacion = procesarVentaConValidacion;
    window.abrirModalGarantia = abrirModalGarantia;
    window.cerrarModalGarantia = cerrarModalGarantia;
    window.generarGarantia = generarGarantia;

    // =====================================================
    // GESTION DE EVENTUALIDADES
    // =====================================================

    function abrirModalEventualidad() {
        const modal = document.getElementById('modalEventualidadOverlay');
        const input = document.getElementById('inputEventualidad');
        modal.classList.add('active');
        input.value = '';
        
        // Listener para Enter
        input.onkeydown = function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                window.guardarEventualidad();
            }
        };

        setTimeout(() => input.focus(), 150);
    }

    function cerrarModalEventualidad() {
        document.getElementById('modalEventualidadOverlay').classList.remove('active');
    }

    async function guardarEventualidad() {
        const input = document.getElementById('inputEventualidad');
        const query = input.value.trim();
        
        if (query.length < 3) {
            window.app?.showToast?.('Detalla la eventualidad (minimo 3 letras)', 'warning', 2000);
            return;
        }

        const btn = document.getElementById('btnGuardarEventualidad');
        if (btn.disabled) return;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

        try {
            const db = window.app?.db;
            const userResponse = await db?.auth?.getUser();
            const userId = userResponse?.data?.user?.id;

            const { error } = await db.from('ferre_eventualidades').insert({
                descripcion: query,
                usuario_id: userId
            });
            
            if (error) throw error;

            window.app?.showToast?.('Eventualidad registrada correctamente', 'success', 2000);
            cerrarModalEventualidad();
        } catch (error) {
            console.error('Error al guardar eventualidad:', error);
            window.app?.showToast?.('Error al registrar registro', 'error', 3000);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-circle"></i> REGISTRAR';
        }
    }

    // Exportar funciones
    window.abrirModalEventualidad = abrirModalEventualidad;
    window.cerrarModalEventualidad = cerrarModalEventualidad;
    window.guardarEventualidad = guardarEventualidad;

</script>